<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="dashboard.css">
    <title>ADPanel</title>
    <link id="favicon" rel="icon" type="image/png" href="/images/adpanel-dark.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.cdnfonts.com/css/gg-sans-2" rel="stylesheet">
    <link
      href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://site-assets.fontawesome.com/releases/v6.7.2/css/all.css" />

    <!-- Flat cards + premium aqua cursor-follow hover -->
    <style>
      :root {
        --panel-bg: #020617;
        --panel-bg-soft: #050816;
        --panel-bg-soft-alt: #050b1a;
        --panel-aqua: #22d3ee;
        --panel-blue: #1d4ed8;
        --panel-text-soft: #9caad0;
        --panel-text-muted: #7e8ba4;
      }

      .btn-primary {
        display: inline-flex;
        gap: 8px;
        align-items: center;
        background: linear-gradient(135deg, #0ea5e9, #1d4ed8);
        color: #e5f4ff;
        border: none;
        border-radius: 10px;
        padding: 10px 14px;
        font-weight: 700;
        cursor: pointer;
        box-shadow: none;
        transition:
          transform 0.22s cubic-bezier(0.22, 0.61, 0.36, 1),
          filter 0.18s ease-out,
          background 0.28s ease-out;
      }
      .btn-primary:hover {
        filter: brightness(1.06);
        transform: translateY(-1px);
      }
      .btn-primary:active {
        transform: translateY(0);
        filter: brightness(0.96);
      }

      .btn-ghost {
        background: rgba(15,23,42,0.85);
        border: none;
        color: #c8d3df;
        padding: 9px 13px;
        border-radius: 10px;
        cursor: pointer;
        box-shadow: none;
        font-size: 13px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition:
          background 0.2s ease-out,
          transform 0.2s ease-out,
          opacity 0.18s ease-out;
      }
      .btn-ghost:hover {
        background: rgba(15,23,42,1);
        transform: translateY(-1px);
      }
      .btn-ghost:active {
        transform: translateY(0);
        opacity: .9;
      }

      .modal-overlay {
        position: fixed;
        inset: 0;
        background: radial-gradient(circle at top, rgba(15,23,42,.9), rgba(2,6,23,.96));
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(10px);
        padding: 12px;
      }
      .modal-overlay.show { display: flex; }

      @keyframes modalEnter {
        from { opacity: 0; transform: translateY(16px) scale(.97); }
        to   { opacity: 1; transform: translateY(0)    scale(1);   }
      }

      .modal-card {
        width: min(780px, 96vw);
        max-height: 92vh;
        background: linear-gradient(145deg, var(--panel-bg), #02091a);
        border-radius: 18px;
        color: #e7eef7;
        display: flex;
        flex-direction: column;
        box-shadow: none;
        animation: modalEnter .22s ease-out;
        overflow: hidden;
      }

      .modal-head {
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        padding: 14px 18px 10px;
        flex-shrink: 0;
      }

      .modal-title-group {
        display:flex;
        gap:12px;
        align-items:flex-start;
      }

      .modal-avatar {
        width:40px;
        height:40px;
        border-radius:999px;
        background: radial-gradient(circle at 25% 0, #38bdf8, #1e40af 45%, #020617 100%);
        display:flex;
        align-items:center;
        justify-content:center;
        color:#e5f4ff;
        flex-shrink:0;
      }

      .modal-eyebrow {
        font-size:11px;
        letter-spacing:0.14em;
        text-transform:uppercase;
        color:var(--panel-text-soft);
        margin-bottom:2px;
      }

      .modal-title {
        font-size:18px;
        font-weight:800;
      }

      .modal-subtitle {
        font-size:13px;
        color:var(--panel-text-soft);
        margin-top:4px;
      }

      .modal-body {
        padding: 12px 18px 14px;
        display:flex;
        flex-direction:column;
        gap:14px;
        flex:1 1 auto;
        overflow:auto;
      }

      .modal-body--split {
        display:grid;
        grid-template-columns: minmax(0, 1.6fr) minmax(0, 1fr);
        gap:16px;
        align-items:flex-start;
      }

      .modal-main { display:grid; gap:12px; }

      .modal-aside { display:flex; flex-direction:column; gap:10px; }

      @media (max-width: 720px) {
        .modal-card {
          width: 100%;
          max-height: 96vh;
        }
        .modal-head {
          padding: 12px 14px 6px;
        }
        .modal-body {
          padding: 10px 12px 12px;
        }
        .modal-body--split {
          grid-template-columns:minmax(0,1fr);
        }
      }

      .modal-foot {
        display:flex;
        justify-content:flex-end;
        gap:10px;
        padding: 10px 18px 12px;
        background: #020617;
        flex-shrink: 0;
      }

      .field { display: grid; gap: 6px; }
      .field label { font-size: 13px; color: #a9b4c2; }

      .field input,
      .field select,
      .field textarea {
        background: #020617;
        border: none;
        border-radius: 10px;
        color: #eaf1fb;
        padding: 9px 11px;
        outline: none;
        font-family: inherit;
        font-size: 14px;
        transition:
          background 0.18s ease-out,
          transform 0.14s ease-out;
      }
      .field input:focus,
      .field select:focus,
      .field textarea:focus {
        background: #020b1f;
        transform: translateY(-1px);
      }

      .inline-hint { font-size: 12px; color: #9eb0c5; }

      .summary-card {
        border-radius: 12px;
        background: var(--panel-bg-soft);
        font-size: 13px;
        padding: 9px 10px 8px;
        position: relative;
        overflow: hidden;
      }

      .summary-header {
        display:flex;
        align-items:center;
        justify-content:space-between;
        margin-bottom:4px;
      }

      .summary-title {
        font-size: 11px;
        letter-spacing:0.16em;
        text-transform:uppercase;
        color:var(--panel-text-soft);
      }

      .summary-badge {
        font-size:11px;
        padding:2px 8px;
        border-radius:999px;
        background: rgba(15,23,42,.95);
        color:#cbd5f5;
      }

      .summary-row {
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-top:2px;
      }

      .summary-label { color:var(--panel-text-soft); font-size:12px; }

      .summary-value {
        color:#e5edf9;
        font-weight:600;
        font-size:13px;
        margin-left:8px;
      }

      .summary-footer {
        font-size:11px;
        color:var(--panel-text-muted);
        margin-top:5px;
      }

      .template-grid,
      .node-grid {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fill, minmax(190px, 1fr));
      }

      /* Base flat card */
      .template-card,
      .node-card,
      .fork-card {
        border: none;
        border-radius: 12px;
        padding: 9px 9px 8px;
        cursor: pointer;
        background: var(--panel-bg-soft);
        text-align: left;
        display:flex;
        flex-direction:column;
        gap:6px;
        box-shadow: none;
        position: relative;
        overflow: hidden;
        transform: translateY(0) scale(1);
        transition:
          transform .26s cubic-bezier(0.22, 0.61, 0.36, 1),
          background .26s ease-out;
        --mouse-x: 50%;
        --mouse-y: 50%;
      }

      /* Aqua “cursor follow” aura */
      .template-card::before,
      .node-card::before,
      .fork-card::before {
        content:"";
        position:absolute;
        top: var(--mouse-y);
        left: var(--mouse-x);
        transform: translate(-50%, -50%);
        width: 220%;
        height: 220%;
        background:
          radial-gradient(circle at center,
            rgba(34,211,238,0.25) 0%,
            rgba(37,99,235,0.18) 35%,
            transparent 60%);
        opacity: 0;
        pointer-events:none;
        transition:
          opacity .35s ease-out,
          transform .35s ease-out;
      }

      .template-card:hover,
      .node-card:hover,
      .fork-card:hover {
        transform: translateY(-2px) scale(1.01);
        background: var(--panel-bg-soft-alt);
      }
      .template-card:hover::before,
      .node-card:hover::before,
      .fork-card:hover::before {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1.03);
      }

      .template-card[aria-selected="true"],
      .node-card[aria-selected="true"],
      .fork-card[aria-selected="true"] {
        background: var(--panel-bg-soft-alt);
      }

      .template-card__header,
      .node-card__header {
        display:flex;
        gap:10px;
        align-items:center;
      }

      .template-card__icon,
      .node-card__icon,
      .fork-card__icon {
        width:30px;
        height:30px;
        border-radius:999px;
        display:flex;
        align-items:center;
        justify-content:center;
        background:#020617;
        flex-shrink:0;
        font-size:14px;
      }

      .template-card__title-group h4,
      .node-card__title-group h4 {
        margin: 0;
        font-size: 14px;
      }

      .template-card__badge {
        display:inline-flex;
        align-items:center;
        margin-top:2px;
        padding:2px 8px;
        border-radius:999px;
        font-size:11px;
        text-transform:uppercase;
        letter-spacing:.12em;
        color:#cbd5f5;
        background: rgba(15,23,42,.95);
      }

      .template-card__description,
      .node-card__description {
        margin: 2px 0 0 0;
        font-size: 12px;
        color:#a9b4c2;
        min-height: 32px;
      }

      .template-card__meta {
        display:flex;
        justify-content:space-between;
        align-items:center;
        font-size:11px;
        color:var(--panel-text-soft);
      }

      .node-status {
        display:inline-flex;
        align-items:center;
        gap:8px;
        font-size:12px;
        color:#9eb0c5;
      }

      .dot {
        width:8px;
        height:8px;
        border-radius:999px;
        background:#64748b;
        display:inline-block;
      }
      .dot.ok { background:var(--panel-aqua); }
      .dot.down { background:#ef4444; }

      .spinner {
        width: 16px;
        height: 16px;
        border-radius: 999px;
        border: 2px solid rgba(255,255,255,.28);
        border-top-color: #e5f4ff;
        animation: spin .9s linear infinite;
        display:none;
      }
      .spinner.show { display:inline-block; }
      @keyframes spin { to { transform: rotate(360deg); } }

      .fork-grid {
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      }

      .fork-title { font-weight: 700; font-size:14px; }
      .muted { color:#a9b4c2; font-size:12px; }

      .port-layout {
        display:grid;
        grid-template-columns:minmax(0,1.4fr) minmax(0,1fr);
        gap:16px;
        align-items:flex-start;
      }
      @media (max-width: 640px) {
        .port-layout { grid-template-columns:minmax(0,1fr); }
      }

      .connection-chip {
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding:7px 9px;
        border-radius:999px;
        background:#020617;
        font-size:12px;
        color:#e5edf9;
        box-shadow:none;
        position:relative;
        overflow:hidden;
      }
      .connection-chip i { font-size:13px; }
      .connection-chip__divider { margin:0 2px; opacity:.6; }
      .connection-chip code {
        background:none;
        padding:0;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size:12px;
        color:#e5edf9;
      }
    </style>
  </head>
  <body>
    <div id="splash-screen"></div>

    <svg xmlns="http://www.w3.org/2000/svg" style="position: absolute; width:0; height:0; pointer-events:none;">
      <defs>
        <filter id="glass-distortion" x="0%" y="0%" width="100%" height="100%">
          <feTurbulence type="fractalNoise" baseFrequency="0.008 0.008" numOctaves="2" seed="92" result="noise" />
          <feGaussianBlur in="noise" stdDeviation="2" result="blurred" />
          <feDisplacementMap in="SourceGraphic" in2="blurred" scale="77" xChannelSelector="R" yChannelSelector="G" />
        </filter>
      </defs>
    </svg>

    <header class="top-bar" id="topBar">
      <div class="brand">
        <img src="/images/adpanel-dark.png" alt="ADPanel logo" class="brand-logo" />
        <div class="brand-copy">
          <h1 class="brand-title">ADPanel</h1>
          <p class="brand-subtitle">Smart control for your servers</p>
        </div>
      </div>

      <div class="toolbar">
        <div class="toolbar-actions" style="gap:10px; display:flex; align-items:center;">
          <button id="createBtn" class="btn-primary" title="Create">
            <i class="fa-solid fa-plus"></i>
            <span>Create</span>
          </button>

          <% if (isAdmin) { %>
          <button class="icon-button" title="Settings" onclick="location.href='/settings'">
            <i class="fa-solid fa-bars"></i>
          </button>
          <% } else { %>
          <button class="icon-button" title="You are not admin" disabled>
            <i class="fa-solid fa-lock"></i>
          </button>
          <% } %>
          <button id="logoutBtn" class="icon-butt" title="Log Out">
            <i class="fa-solid fa-right-from-bracket"></i>
          </button>
        </div>
      </div>
    </header>

    <div id="topbar-spacer" aria-hidden="true"></div>

    <main class="dashboard" id="mainContent">
      <section class="hero">
        <div class="hero-copy">
          <h2>Welcome back!</h2>
          <p>
            Monitor, deploy, and orchestrate servers with ease. Launch new experiences for your community in
            seconds.
          </p>

          <div class="hero-actions">
            <button class="pills" data-scroll-target="bots">View Servers</button>
            <button class="pill pill--outline" id="createBtnHero">
              <i class="fa-solid fa-plus" style="margin-right:6px;"></i>Create
            </button>
          </div>
        </div>

        <div class="hero-stats">
          <article class="stat-card">
            <div class="stat-card__icon stat-card__icon--active">
              <i class="fa-solid fa-server"></i>
            </div>
            <div class="stat-card__content">
              <p class="stat-card__label">Active servers</p>
              <p class="stat-card__value"><%= bots.length %></p>
            </div>
          </article>

          <article class="stat-card">
            <div class="stat-card__icon stat-card__icon--uptime">
              <i class="fa-solid fa-signal-bars"></i>
            </div>
            <div class="stat-card__content">
              <p class="stat-card__label">Status</p>
              <p class="stat-card__value">Operational</p>
            </div>
          </article>

          <article class="stat-card">
            <div class="stat-card__icon stat-card__icon--deploy">
              <i class="fa-solid fa-clock-three"></i>
            </div>
            <div class="stat-card__content">
              <p class="stat-card__label">Server Uptime</p>
              <p class="stat-card__value" id="uptimeDisplay">0s</p>
            </div>
          </article>
        </div>
      </section>

      <section class="quick-actions" aria-label="Quick actions">
        <h3>Quick actions</h3>
        <div class="quick-actions__grid">
          <button class="quick-action" onclick="window.location.href='/settings?panel=account'">
            <i class="fa-solid fa-list-check"></i>
            <p style="font-family: 'gg sans', sans-serif; font-size: 15px; line-height: 1.4;">Manage account</p>
          </button>
          <button class="quick-action" onclick="window.location.href='/settings?panel=servers'">
            <i class="fa-solid fa-bars-progress"></i>
            <p style="font-family: 'gg sans', sans-serif; font-size: 15px; line-height: 1.4;">Manage servers</p>
          </button>
          <button class="quick-action" onclick="window.open('https://ad-panel.com', '_blank')">
            <i class="fa-duotone fa-regular fa-panel-ews"></i>
            <p style="font-family: 'gg sans', sans-serif; font-size: 15px; line-height: 1.4;">ADPanel Site</p>
          </button>
        </div>
      </section>

      <section class="bots" id="bots">
        <div class="section-heading">
          <div>
            <h3>Your servers</h3>
            <p>Browse and jump straight into any bot workspace.</p>
          </div>
          <div class="section-actions">
            <label for="searchBots" class="search-field">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input id="searchBots" class="search-servers" type="text" placeholder="Search servers" />
            </label>
          </div>
        </div>

        <div class="bot-grid" data-bot-grid>
          <% bots.forEach(function(bot){
               const coverStyle = bot.templateImage ? `--bot-cover:url('${String(bot.templateImage).replace(/'/g, "\\'")}');` : '';
               const ipPort = bot.port ? `${bot.ip}:${bot.port}` : bot.ip;
               const memory = bot.memory || {};
               const disk = bot.disk || {};
               const cpuPercent = bot.cpuPercent !== null && bot.cpuPercent !== undefined ? bot.cpuPercent : 0;
               const statusClass = bot.status === 'online' ? 'status-online' : 'status-stopped';
          %>
          <article class="bot-card <%= statusClass %>" data-bot-card data-name="<%= bot.name.toLowerCase() %>" onclick="location.href='/bot/<%= bot.name %>'" style="<%= coverStyle %>">
            <div class="bot-card__hero">
              <div class="bot-card__hero-bg"></div>
              <div class="bot-card__hero-overlay"></div>
              <div class="bot-card__hero-content">
                <div class="bot-card__title-row">
                  <div>
                    <h4><%= bot.name %></h4>
                    <p>Node: <%= bot.nodeName %></p>
                  </div>
                  <div class="bot-card__status <%= statusClass %>"><span class="bot-card__status-dot"></span></div>
                </div>
                <div class="bot-card__template-tag"><i class="fa-solid fa-cube"></i> <%= bot.templateName %></div>
                <div class="bot-card__meta-row">
                  <span><i class="fa-solid fa-globe"></i> <%= ipPort %></span>
                  <span><i class="fa-solid fa-cube"></i> <%= bot.templateId || 'Custom' %></span>
                </div>
              </div>
            </div>

            <div class="bot-card__stats">
              <div class="bot-card__stat">
                <div class="bot-card__stat-label">Memory <span><%= memory.label || '—' %></span></div>
                <div class="bot-card__progress"><span style="width:<%= memory.percent != null ? memory.percent : 0 %>%"></span></div>
              </div>
              <div class="bot-card__stat">
                <div class="bot-card__stat-label">Disk <span><%= disk.label || '—' %></span></div>
                <div class="bot-card__progress"><span style="width:<%= disk.percent != null ? disk.percent : 0 %>%"></span></div>
              </div>
              <div class="bot-card__stat">
                <div class="bot-card__stat-label">CPU <span><%= bot.cpu || '—' %></span></div>
                <div class="bot-card__progress"><span style="width:<%= cpuPercent %>%"></span></div>
              </div>
            </div>

            <div class="bot-card__footer">
              <div class="bot-card__footer-text">Click to view details</div>
              <i class="fa-solid fa-arrow-right bot-card__chevron"></i>
            </div>
          </article>
          <% }) %>
        </div>
      </section>
    </main>

    <footer class="footer" id="upload">
      <div class="footer-inner" style="align-items:center; gap:16px;">
        <div class="footer-copy">
          <h3>Spin up a new server</h3>
          <p>Pick a template and a name, we’ll do the rest.</p>
        </div>
        <button class="btn-primary" id="createBtnFooter">
          <i class="fa-solid fa-plus"></i>
          <span>Create</span>
        </button>
      </div>
    </footer>

    <template id="empty-state">
      <div class="empty-state">
        <i class="fa-solid fa-sparkles empty-state__icon"></i>
        <h4>No servers found</h4>
        <p>Try adjusting your search or create a new server.</p>
      </div>
    </template>

    <!-- Create Modal -->
    <div id="createModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="createTitle">
        <div class="modal-head">
          <div class="modal-title-group">
            <div class="modal-avatar">
              <i class="fa-solid fa-rocket-launch"></i>
            </div>
            <div>
              <div class="modal-eyebrow">New deployment</div>
              <div class="modal-title" id="createTitle">Create server</div>
              <p class="modal-subtitle">Pick a template, choose a node and configure the public port.</p>
            </div>
          </div>
          <button id="createClose" class="btn-ghost" title="Close">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div class="modal-body modal-body--split">
          <div class="modal-main">
            <div class="field">
              <label for="serverName">Server name</label>
              <input id="serverName" type="text" placeholder="e.g. my-discord-bot" />
              <div class="inline-hint">
                Only letters, numbers, dash and underscore. Max ~40 characters.
              </div>
            </div>

            <div class="field">
              <label>Template <span class="inline-hint">(platform that you want to run)</span></label>
              <div id="templateGrid" class="template-grid" role="listbox" aria-label="Templates"></div>
              <div class="inline-hint" id="templateInfo">No template chosen</div>
            </div>

            <div class="field">
              <label>Node <span class="inline-hint">(local node or one from the list)</span></label>
              <div id="nodeGrid" class="node-grid" role="listbox" aria-label="Nodes"></div>
              <div class="inline-hint" id="nodeInfo">Local node</div>
            </div>
          </div>

          <aside class="modal-aside">
            <div class="summary-card">
              <div class="summary-header">
                <div class="summary-title">Summary</div>
                <span class="summary-badge"><i class="fa-solid fa-bolt"></i>&nbsp;Live preview</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">Name</span>
                <span class="summary-value" id="summaryServerName">—</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">Template</span>
                <span class="summary-value" id="summaryTemplateName">—</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">Node</span>
                <span class="summary-value" id="summaryNodeName">Local node</span>
              </div>
              <div class="summary-footer">
                Updated in real time as you fill in the form.
              </div>
            </div>
            <div id="templateInfo2" class="inline-hint"></div>
          </aside>
        </div>

        <div class="modal-foot">
          <span class="spinner" id="createSpinner"></span>
          <button id="createCancel" class="btn-ghost">Cancel</button>
          <button id="createConfirm" class="btn-primary">
            <i class="fa-solid fa-arrow-right"></i><span>Continue</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Minecraft Fork Modal -->
    <div id="forkModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="forkTitle">
        <div class="modal-head">
          <div class="modal-title-group">
            <div class="modal-avatar">
              <i class="fa-solid fa-cube"></i>
            </div>
            <div>
              <div class="modal-eyebrow">Minecraft</div>
              <div class="modal-title" id="forkTitle">Choose Minecraft fork</div>
              <p class="modal-subtitle">Pick the fork that best matches your performance and compatibility needs.</p>
            </div>
          </div>
          <button id="forkClose" class="btn-ghost" title="Close">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div class="modal-body">
          <div class="inline-hint">
            Fixed version: <strong>1.21.8</strong>. The <code>.jar</code> file will be downloaded automatically after creation.
          </div>

          <div id="forkGrid" class="fork-grid" role="listbox" aria-label="Minecraft forks"></div>

          <div id="forkInfo" class="inline-hint"></div>
        </div>

        <div class="modal-foot">
          <span class="spinner" id="forkSpinner"></span>
          <button id="forkBack" class="btn-ghost">Back</button>
          <button id="forkConfirm" class="btn-primary">
            <i class="fa-solid fa-arrow-right"></i><span>Continue</span>
          </button>
        </div>
      </div>
    </div>

    <!-- Port Selection Modal (for ALL templates) -->
    <div id="portModal" class="modal-overlay" aria-hidden="true">
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="portTitle">
        <div class="modal-head">
          <div class="modal-title-group">
            <div class="modal-avatar">
              <i class="fa-solid fa-ethernet"></i>
            </div>
            <div>
              <div class="modal-eyebrow">Networking</div>
              <div class="modal-title" id="portTitle">
                <span id="portTitleText">Expose public port</span>
              </div>
              <p class="modal-subtitle" id="portSubtitle">Choose which public port to expose for this server.</p>
            </div>
          </div>
          <button id="portClose" class="btn-ghost" title="Close">
            <i class="fa-solid fa-xmark"></i>
          </button>
        </div>

        <div class="modal-body">
          <div class="port-layout">
            <div class="field">
              <label>Public endpoint</label>
              <div class="connection-chip">
                <i class="fa-solid fa-plug"></i>
                <span>
                  <code id="serverIp">detecting…</code>
                  <span class="connection-chip__divider">:</span>
                  <code id="serverPortPreview">25565</code>
                </span>
              </div>
              <div class="inline-hint">
                This is the address your users will use to connect.
              </div>
            </div>
            <div class="field">
              <label for="serverPort">Public port (1 – 35650)</label>
              <input id="serverPort" type="number" min="1" max="35650" step="1" placeholder="25565" />
              <div class="inline-hint">
                Default <span id="portDefaultValue">25565</span>. You can manually choose another port (e.g. 30000).
              </div>
            </div>
          </div>
        </div>

        <div class="modal-foot">
          <span class="spinner" id="portSpinner"></span>
          <button id="portBack" class="btn-ghost">Back</button>
          <button id="portConfirm" class="btn-primary">
            <i class="fa-solid fa-check"></i><span>Create</span>
          </button>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      window.addEventListener('DOMContentLoaded', () => {
        // ---- Splash & layout ----
        const splash = document.getElementById('splash-screen');
        if (!localStorage.getItem('seenSplash')) {
          const displayTime = 5000;
          setTimeout(() => {
            splash.classList.add('hidden');
            setTimeout(() => splash.remove(), 600);
          }, displayTime);
          localStorage.setItem('seenSplash', 'true');
        } else {
          splash.remove();
        }

        document.querySelectorAll('[data-scroll-target]').forEach(button => {
          button.addEventListener('click', () => {
            const targetId = button.getAttribute('data-scroll-target');
            const section = document.getElementById(targetId);
            if (section) section.scrollIntoView({ behavior: 'smooth' });
          });
        });

        const searchInput = document.getElementById('searchBots');
        const botGrid = document.querySelector('[data-bot-grid]');
        const emptyStateTemplate = document.getElementById('empty-state');

        function updateBotVisibility() {
          const term = (searchInput?.value || '').trim().toLowerCase();
          const botCards = Array.from(botGrid.querySelectorAll('[data-bot-card]'));
          let visible = 0;
          botCards.forEach(card => {
            const name = card.getAttribute('data-name');
            const match = !term || name.includes(term);
            card.classList.toggle('is-hidden', !match);
            if (match) visible++;
          });
          const existing = botGrid.querySelector('.empty-state');
          if (visible === 0) {
            if (!existing) {
              const clone = emptyStateTemplate.content.cloneNode(true);
              botGrid.appendChild(clone);
            }
          } else if (existing) existing.remove();
        }
        searchInput?.addEventListener('input', updateBotVisibility);
        updateBotVisibility();

        const topBar = document.getElementById('topBar');
        const spacer = document.getElementById('topbar-spacer');
        function measureExpandedHeight() {
          const hadCompact = topBar.classList.contains('top-bar--compact');
          topBar.classList.remove('top-bar--compact');
          const h = Math.ceil(topBar.getBoundingClientRect().height);
          if (hadCompact) topBar.classList.add('top-bar--compact');
          return h;
        }
        let expandedHeight = measureExpandedHeight();
        spacer.style.height = expandedHeight + 'px';
        let resizeRAF = null;
        window.addEventListener('resize', () => {
          if (resizeRAF) cancelAnimationFrame(resizeRAF);
          resizeRAF = requestAnimationFrame(() => {
            expandedHeight = measureExpandedHeight();
            spacer.style.height = expandedHeight + 'px';
          });
        });
        new ResizeObserver(() => {
          expandedHeight = measureExpandedHeight();
          spacer.style.height = expandedHeight + 'px';
        }).observe(topBar);

        let lastY = window.scrollY || 0, ticking = false, pinnedTimeout = null;
        function onScrollTick() {
          const y = window.scrollY || 0, d = y - lastY;
          if (y > 36) topBar.classList.add('top-bar--compact'); else topBar.classList.remove('top-bar--compact');
          if (y <= 24) {
            topBar.classList.remove('top-bar--hidden','top-bar--pinned');
            lastY = y; ticking = false; return;
          }
          if (Math.abs(d) > 4) {
            if (d > 0 && y > 120) {
              topBar.classList.add('top-bar--hidden'); topBar.classList.remove('top-bar--pinned');
            } else if (d < 0) {
              topBar.classList.remove('top-bar--hidden'); topBar.classList.add('top-bar--pinned');
              if (pinnedTimeout) clearTimeout(pinnedTimeout);
              pinnedTimeout = setTimeout(() => topBar.classList.remove('top-bar--pinned'), 900);
            }
          }
          lastY = y; ticking = false;
        }
        window.addEventListener('scroll', () => {
          if (!ticking) {
            requestAnimationFrame(onScrollTick);
            ticking = true;
          }
        }, { passive: true });
        if ((window.scrollY || 0) > 36) topBar.classList.add('top-bar--compact'); else topBar.classList.remove('top-bar--compact');
        topBar.classList.remove('top-bar--hidden');

        function deleteAllClientCookies() {
          const cookies = document.cookie ? document.cookie.split('; ') : [];
          for (const cookie of cookies) {
            const eqPos = cookie.indexOf('=');
            const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/`;
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=${location.hostname}`;
            const parts = location.hostname.split('.');
            for (let i = 0; i < parts.length - 1; i++) {
              const dom = '.' + parts.slice(i).join('.');
              document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/;domain=${dom}`;
            }
          }
        }
        document.getElementById('logoutBtn')?.addEventListener('click', async (e) => {
          e.preventDefault();
          try {
            deleteAllClientCookies();
            await fetch('/logout', { method:'POST', credentials:'include' });
            location.href='/login';
          } catch {
            alert('Failed to log out');
          }
        });

        // ----- Premium hover helper (cursor-follow aqua) -----
        function attachPremiumHover(root) {
          if (!root) return;
          const cards = root.querySelectorAll('.template-card, .node-card, .fork-card');
          cards.forEach(card => {
            card.addEventListener('pointermove', (e) => {
              const rect = card.getBoundingClientRect();
              const x = ((e.clientX - rect.left) / rect.width) * 100;
              const y = ((e.clientY - rect.top) / rect.height) * 100;
              card.style.setProperty('--mouse-x', `${x}%`);
              card.style.setProperty('--mouse-y', `${y}%`);
            });
            card.addEventListener('pointerleave', () => {
              card.style.removeProperty('--mouse-x');
              card.style.removeProperty('--mouse-y');
            });
          });
        }

        // ----- Create / Fork / Port flow -----
        const createBtns = [
          document.getElementById('createBtn'),
          document.getElementById('createBtnHero'),
          document.getElementById('createBtnFooter')
        ].filter(Boolean);

        const createModal = document.getElementById('createModal');
        const createClose = document.getElementById('createClose');
        const createCancel = document.getElementById('createCancel');
        const createConfirm = document.getElementById('createConfirm');
        const createSpinner = document.getElementById('createSpinner');

        const serverNameEl = document.getElementById('serverName');
        const templateGrid = document.getElementById('templateGrid');
        const templateInfo = document.getElementById('templateInfo');

        const nodeGrid = document.getElementById('nodeGrid');
        const nodeInfo = document.getElementById('nodeInfo');

        const summaryNameEl = document.getElementById('summaryServerName');
        const summaryTemplateEl = document.getElementById('summaryTemplateName');
        const summaryNodeEl = document.getElementById('summaryNodeName');

        const templateInfo2 = document.getElementById('templateInfo2');

        // Fork modal
        const forkModal = document.getElementById('forkModal');
        const forkClose = document.getElementById('forkClose');
        const forkBack = document.getElementById('forkBack');
        const forkConfirm = document.getElementById('forkConfirm');
        const forkSpinner = document.getElementById('forkSpinner');
        const forkGrid = document.getElementById('forkGrid');
        const forkInfo = document.getElementById('forkInfo');

        // Port modal
        const portModal = document.getElementById('portModal');
        const portClose = document.getElementById('portClose');
        const portBack = document.getElementById('portBack');
        const portConfirm = document.getElementById('portConfirm');
        const portSpinner = document.getElementById('portSpinner');
        const serverIpEl = document.getElementById('serverIp');
        const serverPortEl = document.getElementById('serverPort');
        const serverPortPreviewEl = document.getElementById('serverPortPreview');
        const portDefaultValueEl = document.getElementById('portDefaultValue');
        const portTitleTextEl = document.getElementById('portTitleText');
        const portSubtitleEl = document.getElementById('portSubtitle');

        const MC_VERSION = "1.21.8";
        const MC_FORKS = [
          { id: "paper",      name: "Paper",      desc: "Great performance and high plugin compatibility." },
          { id: "pufferfish", name: "Pufferfish", desc: "Additional optimisations focused on TPS stability." },
          { id: "vanilla",    name: "Vanilla",    desc: "Standard experience without extra patches." },
          { id: "purpur",     name: "Purpur",     desc: "Paper fork with extra configuration options." }
        ];

        let templates = [];
        let nodes = [];
        let selectedTemplateId = null;
        let selectedForkId = null;
        let selectedNodeId = "local";
        let portBackTarget = "create";

        function sanitizeName(s) {
          s = (s || '').trim().toLowerCase();
          s = s.replace(/\s+/g, '-').replace(/[^a-z0-9\-_]/g, '');
          return s.slice(0, 40) || '';
        }

        function getTemplateMeta(t) {
          const id = ((t && t.id) || '').toString().toLowerCase();
          if (id.includes('minecraft') || id === 'mc') {
            return { icon: 'fa-solid fa-cube', badge: 'Minecraft' };
          }
          if (id.includes('node') || id.includes('discord')) {
            return { icon: 'fa-brands fa-node-js', badge: 'Node.js' };
          }
          if (id.includes('python') || id.includes('py')) {
            return { icon: 'fa-brands fa-python', badge: 'Python' };
          }
          if (id.includes('proxy') || id.includes('web') || id.includes('http')) {
            return { icon: 'fa-solid fa-cloud', badge: 'Web' };
          }
          return { icon: 'fa-solid fa-server', badge: 'Generic' };
        }

        function getDefaultPortForTemplate(templateId) {
          const id = (templateId || '').toString().toLowerCase();
          if (!id) return 25565;
          if (id.includes('minecraft') || id === 'mc') return 25565;
          if (id.includes('node') || id.includes('discord')) return 3000;
          if (id.includes('http') || id.includes('web') || id.includes('proxy')) return 80;
          return 8080;
        }

        function openCreate() {
          createModal.classList.add('show');
          createModal.setAttribute('aria-hidden', 'false');

          selectedTemplateId = null;
          selectedForkId = null;
          selectedNodeId = 'local';
          portBackTarget = 'create';

          if (serverNameEl) serverNameEl.value = '';
          if (templateGrid) templateGrid.innerHTML = '<div class="inline-hint">Loading templates…</div>';
          if (templateInfo) templateInfo.textContent = 'No template chosen';

          if (nodeGrid) nodeGrid.innerHTML = '<div class="inline-hint">Loading nodes…</div>';
          if (nodeInfo) nodeInfo.textContent = 'Local node';

          if (summaryNameEl) summaryNameEl.textContent = '—';
          if (summaryTemplateEl) summaryTemplateEl.textContent = '—';
          if (summaryNodeEl) summaryNodeEl.textContent = 'Local node';
          if (templateInfo2) templateInfo2.textContent = '';

          fetchTemplates();
          fetchNodes();
        }

        function closeCreate() {
          createModal.classList.remove('show');
          createModal.setAttribute('aria-hidden', 'true');
        }

        createBtns.forEach(btn => btn.addEventListener('click', openCreate));
        createClose.addEventListener('click', closeCreate);
        createCancel.addEventListener('click', closeCreate);
        createModal.addEventListener('click', (e) => {
          if (e.target === createModal) closeCreate();
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && createModal.classList.contains('show')) closeCreate();
        });

        async function fetchTemplates() {
          try {
            const r = await fetch('/api/templates');
            if (!r.ok) throw new Error('Failed to load templates');
            const data = await r.json();
            templates = (data && data.templates) || [];
          } catch (e) {
            templates = [
              { id: 'minecraft',   name: 'Minecraft',   description: 'Minecraft server (fork selection in the next step).' },
              { id: 'discord-bot', name: 'Discord Bot', description: 'Node 20 runtime (mount /app).' },
              { id: 'vanilla',     name: 'Empty',       description: 'Alpine base (sleep).' },
            ];
          }
          renderTemplates();
        }

        async function fetchNodes() {
          try {
            const r = await fetch('/api/nodes');
            const data = await r.json();
            nodes = (data && data.nodes) ? data.nodes : [];
          } catch (e) {
            nodes = [];
          }
          renderNodes();
        }

        function renderTemplates() {
          if (!templateGrid) return;
          templateGrid.innerHTML = '';

          if (!templates.length) {
            const empty = document.createElement('div');
            empty.className = 'inline-hint';
            empty.textContent = 'No templates available.';
            templateGrid.appendChild(empty);
            return;
          }

          templates.forEach(t => {
            const card = document.createElement('button');
            card.type = 'button';
            card.className = 'template-card';
            card.setAttribute('role', 'option');
            card.setAttribute('aria-selected', 'false');

            const meta = getTemplateMeta(t);

            card.innerHTML = `
              <div class="template-card__header">
                <div class="template-card__icon">
                  <i class="${meta.icon}"></i>
                </div>
                <div class="template-card__title-group">
                  <h4>${t.name}</h4>
                  <span class="template-card__badge">${meta.badge}</span>
                </div>
              </div>
              <p class="template-card__description">${t.description || ''}</p>
              <div class="template-card__meta">
                <span class="inline-hint">ID: ${t.id}</span>
                <span class="inline-hint">${(t.docker && t.docker.image) ? `${t.docker.image}:${t.docker.tag || 'latest'}` : 'Custom Docker'}</span>
              </div>
            `;
            card.addEventListener('click', () => {
              selectedTemplateId = t.id;
              [...templateGrid.children].forEach(c => c.setAttribute('aria-selected','false'));
              card.setAttribute('aria-selected','true');
              if (templateInfo) templateInfo.textContent = t.name;
              if (summaryTemplateEl) summaryTemplateEl.textContent = t.name;
              if (templateInfo2) templateInfo2.textContent = t.description || '';
            });
            templateGrid.appendChild(card);
          });

          attachPremiumHover(templateGrid);
        }

        function renderNodes() {
          if (!nodeGrid) return;
          nodeGrid.innerHTML = '';

          const local = document.createElement('button');
          local.type = 'button';
          local.className = 'node-card';
          local.setAttribute('role','option');
          local.setAttribute('aria-selected', 'true');
          local.innerHTML = `
            <div class="node-card__header">
              <div class="node-card__icon">
                <i class="fa-solid fa-house-laptop"></i>
              </div>
              <div class="node-card__title-group">
                <h4>Local node</h4>
                <p class="node-card__description">Runs on the same host as the panel.</p>
              </div>
            </div>
            <div class="node-status"><span class="dot ok"></span> assumed online</div>
          `;
          local.addEventListener('click', () => {
            selectedNodeId = 'local';
            [...nodeGrid.children].forEach(c => c.setAttribute('aria-selected','false'));
            local.setAttribute('aria-selected','true');
            if (nodeInfo) nodeInfo.textContent = 'Local node';
            if (summaryNodeEl) summaryNodeEl.textContent = 'Local node';
          });
          nodeGrid.appendChild(local);

          nodes.forEach(n => {
            const online = !!n.online;
            const el = document.createElement('button');
            el.type = 'button';
            el.className = 'node-card';
            el.setAttribute('role','option');
            el.setAttribute('aria-selected', 'false');
            el.innerHTML = `
              <div class="node-card__header">
                <div class="node-card__icon">
                  <i class="fa-solid fa-diagram-project"></i>
                </div>
                <div class="node-card__title-group">
                  <h4>${n.name || n.uuid}</h4>
                  <p class="node-card__description">${n.address || ''}</p>
                </div>
              </div>
              <div class="node-status"><span class="dot ${online ? 'ok' : 'down'}"></span> ${online ? 'online' : 'offline'}</div>
              <div class="inline-hint">ID: ${n.uuid}</div>
            `;
            el.addEventListener('click', () => {
              selectedNodeId = n.uuid || n.id || n.name;
              [...nodeGrid.children].forEach(c => c.setAttribute('aria-selected','false'));
              el.setAttribute('aria-selected','true');
              const label = n.name || n.uuid;
              if (nodeInfo) nodeInfo.textContent = online ? label : `${label} (offline)`;
              if (summaryNodeEl) summaryNodeEl.textContent = label;
            });
            nodeGrid.appendChild(el);
          });

          if (summaryNodeEl && !nodes.length) {
            summaryNodeEl.textContent = 'Local node';
          }

          attachPremiumHover(nodeGrid);
        }

        function openForkModal() {
          if (!forkModal) return;
          if (forkGrid) forkGrid.innerHTML = '';
          selectedForkId = null;
          if (forkInfo) forkInfo.textContent = 'Choose a fork (required).';

          MC_FORKS.forEach(f => {
            const card = document.createElement('button');
            card.type = 'button';
            card.className = 'fork-card';
            card.setAttribute('role','option');
            card.setAttribute('aria-selected','false');
            card.innerHTML = `
              <div class="fork-card__icon">
                <i class="fa-solid fa-cubes"></i>
              </div>
              <div>
                <div class="fork-title">${f.name}</div>
                <div class="muted">${f.desc}</div>
              </div>
            `;
            card.addEventListener('click', () => {
              selectedForkId = f.id;
              [...forkGrid.children].forEach(c => c.setAttribute('aria-selected','false'));
              card.setAttribute('aria-selected','true');
              if (forkInfo) forkInfo.textContent = 'Fork: ' + f.name + ' (' + MC_VERSION + ')';
            });
            forkGrid.appendChild(card);
          });

          attachPremiumHover(forkGrid);

          forkModal.classList.add('show');
          forkModal.setAttribute('aria-hidden','false');
        }

        function closeForkModal() {
          forkModal.classList.remove('show');
          forkModal.setAttribute('aria-hidden','true');
        }

        forkClose.addEventListener('click', closeForkModal);
        forkBack.addEventListener('click', () => {
          closeForkModal();
          createModal.classList.add('show');
          createModal.setAttribute('aria-hidden','false');
        });
        forkModal.addEventListener('click', (e) => {
          if (e.target === forkModal) closeForkModal();
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && forkModal.classList.contains('show')) closeForkModal();
        });

        function openPortModal(backFrom) {
          portBackTarget = backFrom || 'create';

          if (serverPortEl) {
            const defPort = getDefaultPortForTemplate(selectedTemplateId);
            serverPortEl.value = String(defPort);
            if (portDefaultValueEl) portDefaultValueEl.textContent = String(defPort);
            if (serverPortPreviewEl) serverPortPreviewEl.textContent = String(defPort);
          }

          if (serverIpEl) {
            serverIpEl.textContent = 'detecting…';
          }

          const ipv4Re = /\b(?:(?:25[0-5]|2[0-4]\d|1?\d?\d)\.){3}(?:25[0-5]|2[0-4]\d|1?\d?\d)\b/;
          function extractIP(s) {
            if (!s) return null;
            const str = String(s).trim();
            const m = str.match(ipv4Re);
            if (m) return m[0];
            if (str.includes(':')) return str.replace(/^\[|\]$/g,'');
            return null;
          }
          function pickIpFromJSON(j) {
            return extractIP(j?.publicIp) ||
                   extractIP(j?.ip) ||
                   extractIP(j?.address) ||
                   extractIP(j?.host) ||
                   extractIP(j?.hostname);
          }
          function setIp(ip) {
            if (serverIpEl) serverIpEl.textContent = ip || 'unknown';
          }

          const selectedTemplate = templates.find(t => t.id === selectedTemplateId);
          const templateLabel = selectedTemplate ? selectedTemplate.name : 'server';
          if (portTitleTextEl) portTitleTextEl.textContent = 'Expose public port';
          if (portSubtitleEl) portSubtitleEl.textContent = `Choose the public port for ${templateLabel}.`;

          if (selectedNodeId && selectedNodeId !== 'local') {
            const node = (nodes || []).find(x =>
              (x.uuid === selectedNodeId) ||
              (x.id === selectedNodeId) ||
              (x.name === selectedNodeId)
            );
            const ip = node && (node.address || node.host || node.hostname);
            setIp(ip);
          } else {
            fetch('/api/server-info')
              .then(r => r.ok ? r.json() : Promise.reject())
              .then(j => setIp(pickIpFromJSON(j)))
              .catch(() => setIp(null));
          }

          portModal.classList.add('show');
          portModal.setAttribute('aria-hidden','false');
        }

        function closePortModal() {
          portModal.classList.remove('show');
          portModal.setAttribute('aria-hidden','true');
        }

        portClose.addEventListener('click', closePortModal);
        portBack.addEventListener('click', () => {
          closePortModal();
          if (portBackTarget === 'fork') {
            forkModal.classList.add('show');
            forkModal.setAttribute('aria-hidden','false');
          } else {
            createModal.classList.add('show');
            createModal.setAttribute('aria-hidden','false');
          }
        });
        portModal.addEventListener('click', (e) => {
          if (e.target === portModal) closePortModal();
        });
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && portModal.classList.contains('show')) closePortModal();
        });

        if (serverPortEl && serverPortPreviewEl) {
          serverPortEl.addEventListener('input', () => {
            const raw = serverPortEl.value.trim();
            serverPortPreviewEl.textContent = raw || (portDefaultValueEl ? portDefaultValueEl.textContent : '—');
          });
        }

        if (serverNameEl && summaryNameEl) {
          serverNameEl.addEventListener('input', () => {
            const val = sanitizeName(serverNameEl.value);
            summaryNameEl.textContent = val || '—';
          });
        }

        // Step 1: create modal "Continue"
        createConfirm.addEventListener('click', () => {
          const raw = serverNameEl.value;
          const name = sanitizeName(raw);
          if (!name) {
            alert('Please enter a valid name (letters / numbers / - / _).');
            return;
          }
          if (!selectedTemplateId) {
            alert('Please choose a template.');
            return;
          }

          if (selectedNodeId !== 'local') {
            const node = (nodes || []).find(x =>
              (x.uuid === selectedNodeId) ||
              (x.id === selectedNodeId) ||
              (x.name === selectedNodeId)
            );
            if (!node) {
              alert('The chosen node no longer exists.');
              return;
            }
            if (!node.online) {
              alert('The chosen node is offline.');
              return;
            }
          }

          if (selectedTemplateId === 'minecraft') {
            closeCreate();
            openForkModal();
            return;
          }

          closeCreate();
          openPortModal('create');
        });

        // Step 2: fork modal -> port modal
        forkConfirm.addEventListener('click', () => {
          if (!selectedForkId) {
            alert('Please choose a fork.');
            return;
          }
          closeForkModal();
          openPortModal('fork');
        });

        // Step 3: port modal -> final create (for ALL templates)
        portConfirm.addEventListener('click', async () => {
          const raw = serverNameEl.value;
          const name = sanitizeName(raw);
          if (!name) {
            alert('Server name is missing or invalid.');
            return;
          }
          if (!selectedTemplateId) {
            alert('Template is not chosen.');
            return;
          }
          if (selectedTemplateId === 'minecraft' && !selectedForkId) {
            alert('Please choose a fork.');
            return;
          }

          if (selectedNodeId !== 'local') {
            const node = (nodes || []).find(x =>
              (x.uuid === selectedNodeId) ||
              (x.id === selectedNodeId) ||
              (x.name === selectedNodeId)
            );
            if (!node) {
              alert('The chosen node no longer exists.');
              return;
            }
            if (!node.online) {
              alert('The chosen node is offline.');
              return;
            }
          }

          const portVal = parseInt(serverPortEl.value, 10);
          if (!Number.isInteger(portVal) || portVal < 1 || portVal > 35650) {
            alert('Invalid port. Choose a value between 1 and 35650.');
            return;
          }

          try {
            portSpinner.classList.add('show');
            portConfirm.disabled = true;

            const payload = {
              name,
              templateId: selectedTemplateId,
              nodeId: selectedNodeId,
              hostPort: portVal
            };

            if (selectedTemplateId === 'minecraft') {
              payload.mcFork = selectedForkId;
              payload.mcVersion = MC_VERSION;
            }

            const r = await fetch('/api/servers/create', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
            const j = await r.json().catch(() => ({}));
            if (!r.ok || !j.ok) {
              throw new Error((j && j.error) ? j.error : 'Create failed');
            }

            window.location.href = `/bot/${encodeURIComponent(name)}`;
          } catch (e) {
            alert(e.message || 'Create failed');
          } finally {
            portSpinner.classList.remove('show');
            portConfirm.disabled = false;
          }
        });
      });

      const serverStartTime = <%= serverStartTime %>;
      const uptimeDisplay = document.getElementById('uptimeDisplay');
      function formatTime(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${hours}h ${minutes}m ${seconds}s`;
      }
      function updateUptime() {
        const now = Date.now();
        uptimeDisplay.textContent = formatTime(now - serverStartTime);
      }
      setInterval(updateUptime, 1000);
      updateUptime();

      const statusSocket = window.io ? window.io({ transports: ['websocket'] }) : null;
      const cards = Array.from(document.querySelectorAll('[data-bot-card]'));

      function setStatusClasses(cardEl, statusEl, status) {
        const classes = ['status-online', 'status-stopped'];
        cardEl.classList.remove(...classes);
        statusEl.classList.remove(...classes);
        const className = status === 'online' ? 'status-online' : 'status-stopped';
        cardEl.classList.add(className);
        statusEl.classList.add(className);
      }

      function applyStatus(name, status) {
        const card = cards.find((el) => el.dataset.name === name.toLowerCase());
        if (!card) return;
        const statusEl = card.querySelector('.bot-card__status');
        if (!statusEl) return;
        setStatusClasses(card, statusEl, status === 'online' ? 'online' : 'stopped');
      }

      if (statusSocket && cards.length) {
        const botNames = cards.map((el) => el.dataset.name).filter(Boolean);
        statusSocket.emit('dashboard:watch', { bots: botNames });
        statusSocket.on('dashboard:status', (list = []) => {
          list.forEach((item) => applyStatus(item.name || '', item.status));
        });
      }
    </script>
  </body>
</html>