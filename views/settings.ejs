<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="settings.css">
  <title>ADPanel Settings</title>
  <link rel="icon" type="image/png" sizes="16x16" href="/images/adpanel-dark.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Minimal helpers to ensure the new big modal and nodes UI look nice even without extra CSS */
    .nodes-empty {
      padding: 16px;
      color: var(--muted);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--card-contrast-bg);
      border: 1px solid rgba(15,23,42,0.06);
      border-radius: 10px;
    }
    .nodes-header {
      display:flex; align-items:center; justify-content:space-between;
    }
    .node-row {
      display:flex; align-items:center; justify-content:space-between;
      padding:12px; border-radius:10px;
      background:var(--card-contrast-bg);
      border:1px solid rgba(15,23,42,0.06);
      cursor:pointer;
    }
    .node-left { display:flex; gap:10px; align-items:center; }
    .status-dot {
      width:10px; height:10px; border-radius:50%;
      display:inline-block; margin-right:8px;
      background:#a1a1a1;
      transition: background .15s ease;
    }
    .status-dot.green { background:#16a34a; }
    .status-dot.red { background:#ef4444; }
    .status-dot.gray { background:#9ca3af; }
    .muted { color:var(--muted); }
    .kpi { font-size:12px; color: var(--muted); }
    .modal.big {
      width:80vw; max-width:1200px; height:80vh; max-height:900px;
      display:flex; flex-direction:column;
    }
    .modal .tabs {
      display:flex; gap:8px; border-bottom:1px solid rgba(15,23,42,0.08); padding-bottom:8px; margin-bottom:12px;
    }
    .modal .tabs button { padding:8px 12px; border-radius:8px; }
    .modal .tabs button.active { background: var(--accent, #4f46e5); color: #fff; }
    .modal .tab-page { display:none; overflow:auto; }
    .modal .tab-page.active { display:block; }
    .template-picker { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:12px; margin-top:12px; }
    .template-pill { border:1px solid rgba(255,255,255,0.08); background:rgba(255,255,255,0.03); border-radius:12px; padding:12px; text-align:left; cursor:pointer; transition:all 0.15s ease; }
    .template-pill:hover { border-color:rgba(79,70,229,0.5); box-shadow:0 10px 30px rgba(0,0,0,0.25); transform:translateY(-1px); }
    .template-pill.active { border-color:var(--accent,#4f46e5); background:rgba(79,70,229,0.08); box-shadow:0 12px 32px rgba(79,70,229,0.18); }
    .template-pill .title { font-weight:700; font-size:15px; }
    .template-pill .desc { color:var(--muted); margin-top:6px; font-size:13px; line-height:1.4; }
    .template-pill .tag { display:inline-block; margin-top:8px; font-size:12px; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,0.05); color:var(--muted); }
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    .field-col { display:flex; flex-direction:column; gap:6px; }
    .field-col input, .field-col textarea, .field-col select {
      padding:10px; border-radius:8px; border:1px solid rgba(15,23,42,0.06); background:var(--panel-bg, #fff);
      color:var(--text, #111827);
    }
    .codebox {
      width:100%; min-height:260px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      background:rgba(0,0,0,0.04); border:1px solid rgba(15,23,42,0.06); border-radius:8px; padding:10px; resize:vertical;
      color:var(--text);
    }
    .inline-badge {
      font-size:12px; padding:2px 8px; border-radius:999px; background:rgba(15,23,42,0.06);
    }
    .danger { background:#fee2e2; border-color:#fecaca; }
    .row-actions { display:flex; gap:8px; align-items:center; }
    .chip {
      display:inline-flex; align-items:center; gap:6px;
      padding:2px 8px; border-radius:9999px; background:rgba(15,23,42,0.06); font-size:12px;
    }
    @media (max-width: 900px){
      .grid-2 { grid-template-columns:1fr; }
      .modal.big { width:92vw; height:90vh; }
    }
  </style>
</head>
<body>
  <div id="themeOverlay" class="theme-overlay" aria-hidden="true"></div>

  <div class="closeEscFixed" id="closeEscFixed" title="Esc → Close (go to /)">
    <div style="display:flex;flex-direction:column;align-items:center;justify-content:center">
      <i class="fa-solid fa-xmark"></i>
      <small>ESC</small>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar" aria-label="Sidebar">
      <div class="brand">
        <div class="logo"><i class="fa-solid fa-cog"></i></div>
        <div>
          <h1>Settings</h1>
          <p>Make ADPanel yours.</p>
        </div>
      </div>

      <nav class="nav" id="sidebarNav">
        <button data-panel="preferences" class="active"><i class="fa-solid fa-cog"></i> Preferences</button>
        <button data-panel="account"><i class="fa-solid fa-user"></i> Account</button>
        <button data-panel="security"><i class="fa-solid fa-shield-halved"></i> Security</button>
        <button data-panel="nodes"><i class="fa-solid fa-diagram-project"></i> Nodes</button>
        <button data-panel="templates"><i class="fa-solid fa-boxes-stacked"></i> Templates</button>
        <button data-panel="integrations"><i class="fa-solid fa-file-import"></i> Integrations</button>
        <button data-panel="servers"><i class="fa-solid fa-server"></i> Servers</button>
      </nav>

      <div style="margin-top:12px;border-top:1px dashed rgba(15,23,42,0.04);padding-top:12px;flex:0 0 auto">
        <div style="font-weight:700;margin-bottom:8px">Theme</div>
        <div style="display:flex;gap:8px">
          <div style="flex:1">
            <button id="themeLight" class="theme-btn">White</button>
          </div>
          <div style="flex:1">
            <button id="themeDark" class="theme-btn">Dark</button>
          </div>
        </div>
      </div>

    </aside>

    <main>
      <section class="panel" aria-labelledby="settings-title">
        <h2 id="settings-title">Settings</h2>
        <p>Main settings area — choose a section on the left.</p>

        <div class="layout-inner">
          <div class="left-col" id="leftCol">
            <div class="card" id="bgCard">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div style="font-weight:700">Background selection</div>
                  <div style="font-size:13px;color:var(--muted)">Main color default: <code>#282c34</code></div>
                </div>
                <div style="font-size:18px;color:var(--muted)"><i class="fa-regular fa-image"></i></div>
              </div>

              <div class="bg-select">
                <div class="bg-preview" id="bgPreview" style="background-color:var(--panel-gray)">
                  <div class="label">Main color</div>
                  <div style="text-align:center;opacity:0.92">
                    <div style="font-weight:700;font-size:16px" id="bgHex">#282c34</div>
                    <div style="font-size:12px;color:rgba(255,255,255,0.86)">Preview area</div>
                  </div>
                </div>

                <div class="controls">
                  <div class="color-dot" id="colorDot"> </div>
                  <input type="color" id="colorPicker" value="#282c34" title="Pick main color">

                  <div class="field">
                    <input type="text" id="hexInput" value="#282c34" aria-label="Hex input">
                  </div>

                  <button class="btn" id="applyColorBtn"><i class="fa-solid fa-check"></i> Apply</button>
                </div>

                <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px">
                  <div style="font-weight:700">Choose an image</div>
                  <div style="font-size:13px;color:var(--muted)">Thumbnail previews</div>
                </div>

                <div class="thumbs" id="thumbs"></div>

                <div class="upload">
                  <label class="upload-btn" for="uploadFile"><i class="fa-solid fa-upload"></i> Upload</label>
                  <input id="uploadFile" type="file" accept="image/*">

                  <div style="flex:1;display:flex;gap:8px">
                    <input type="text" id="urlInput" placeholder="Or paste image URL" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)">
                    <button class="btn ghost" id="useUrlBtn">Use</button>
                  </div>
                </div>

                <div class="note">Note: background set here will be applied to the dashboard and main style files.</div>

              </div>

            </div>

            <div class="card" style="margin-top:10px">
              <div style="font-weight:700">Other preferences</div>
              <div class="prefs-list">
                <div class="pref-row">
                  <div>
                    <div style="font-weight:700">Density</div>
                    <small class="muted">Compact / Comfortable</small>
                  </div>
                  <div>
                    <select id="densitySelect" style="padding:8px;border-radius:8px">
                      <option value="comfortable">Comfortable</option>
                      <option value="compact">Compact</option>
                    </select>
                  </div>
                </div>

                <div class="pref-row">
                  <div>
                    <div style="font-weight:700">Animations</div>
                    <small class="muted">Enable/Disable UI animations</small>
                  </div>
                  <div>
                    <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="animationsToggle" checked> On</label>
                  </div>
                </div>

                <div class="pref-row">
                  <div>
                    <div style="font-weight:700">Accent color</div>
                    <small class="muted">Change UI accent color</small>
                  </div>
                  <div>
                    <input type="color" id="accentPicker" value="#4f46e5">
                  </div>
                </div>

              </div>
            </div>

          </div>

          <div style="flex:1">
            <div class="content-area">
              <div id="preferences" class="panel-section active">
                <div style="font-weight:700;margin-bottom:10px">Preferences</div>
                <p style="color:var(--muted)">Main customization options: color, background image, density and animations.</p>

                <div style="margin-top:12px;display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
                  <div style="padding:12px;border-radius:10px;background:var(--card-contrast-bg);color:var(--text)">
                    <div style="font-weight:700">Saved background</div>
                    <div id="savedBg" style="margin-top:8px;color:var(--text)">None</div>
                  </div>
                  <div style="padding:12px;border-radius:10px;background:var(--card-contrast-bg);color:var(--text)">
                    <div style="font-weight:700">Theme</div>
                    <div id="savedTheme" style="margin-top:8px;color:var(--text)">White</div>
                  </div>
                </div>

              </div>

              <div id="account" class="panel-section">
                <div style="display:flex;justify-content:space-between;align-items:center">
                  <div>
                    <div style="font-weight:700">Account</div>
                    <div style="color:var(--muted)">Account settings</div>
                  </div>
                </div>
                <div class="logout">
                  <button id="logoutBtn"><i class="fa-solid fa-right-from-bracket"></i><a>Log Out</a></button>
                </div>

                <div style="margin-top:12px;display:grid;gap:8px">

                  <div id="changePassCard" class="clickable-card" style="margin-top:6px;padding:12px;border-radius:10px;background:var(--card-contrast-bg);">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                      <div>
                        <div style="font-weight:700">Change password</div>
                        <small style="color:var(--muted)">Requires current password & 2FA at login (if enabled)</small>
                      </div>
                      <div style="font-size:18px;color:var(--muted)"><i class="fa-solid fa-key"></i></div>
                    </div>
                  </div>

                  <div style="margin-top:10px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.04);border:1px solid rgba(15,23,42,0.04);font-size:13px;color:var(--muted)">
                    <strong>NOTE:</strong> Other settings are changed via the <code>initialize.sh</code> script in the <code>adpanel</code> folder.
                  </div>

                  <div id="accountsSection" style="margin-top:12px;">
                    <div style="font-weight:700;margin-bottom:8px">Accounts</div>
                    <div style="color:var(--muted);margin-bottom:8px">List of accounts from <code>user-access.json</code> (admins are excluded).</div>
                    <div id="accountsList" style="display:grid;gap:8px">
                    </div>
                    <div style="margin-top:8px;color:var(--muted);font-size:13px">Click the server icon next to a user to open the popup and manage access for that account.</div>
                  </div>

                </div>
              </div>

              <div id="security" class="panel-section">
                <div style="font-weight:700">Security</div>
                <div style="color:var(--muted);margin-top:8px">2FA, password and active sessions</div>

                <div style="margin-top:12px;display:grid;gap:8px">
                  <div style="padding:10px;border-radius:8px;background:var(--card-contrast-bg)">
                    <div style="font-weight:700">Two-factor authentication</div>
                    <small style="color:var(--muted)">Enabled</small>
                  </div>
                  <div style="padding:10px;border-radius:8px;background:var(--card-contrast-bg)">
                    <div style="font-weight:700">Active sessions</div>
                    <small style="color:var(--muted)">1 active session (this browser)</small>
                  </div>
                </div>
              </div>

              <!-- NODES PANEL -->
              <div id="nodes" class="panel-section">
                <div class="nodes-header">
                  <div>
                    <div style="font-weight:700">Nodes</div>
                    <div class="muted">Manage your infrastructure</div>
                  </div>
                  <div>
                    <button class="btn" id="openCreateNode"><i class="fa-solid fa-circle-plus"></i> Create node</button>
                  </div>
                </div>

                <div id="nodesList" style="margin-top:12px;display:grid;gap:8px"></div>
              </div>

              <div id="templates" class="panel-section">
                <div class="servers-header">
                  <div>
                    <div style="font-weight:700">Templates</div>
                    <div style="color:var(--muted)">Create and manage Docker templates</div>
                  </div>
                  <div>
                    <button class="btn" id="openCreateTemplate"><i class="fa-solid fa-plus"></i> Create</button>
                  </div>
                </div>
                <div id="templatesFeedback" class="muted" style="margin-top:8px"></div>
                <div id="templatesList" class="templates-grid" style="margin-top:12px"></div>
              </div>

              <div id="integrations" class="panel-section">
                <div style="font-weight:700">Integrations</div>
                <div style="color:var(--muted);margin-top:8px">Connect external services</div>
              </div>

              <div id="servers" class="panel-section">
                <div class="servers-header">
                  <div>
                    <div style="font-weight:700">Servers</div>
                    <div style="color:var(--muted)">Manage yours</div>
                  </div>

                  <div class="create-inline" style="gap:8px">
                    <input id="createServerName" type="text" placeholder="New server name" aria-label="New server name" />
                    <button class="btn" id="createServerBtn"><i class="fa-solid fa-plus"></i> Create</button>
                  </div>
                </div>

                <div id="serversList" style="margin-top:12px;display:grid;gap:8px">
                </div>

                <div class="note">Creating a server folder only creates an empty directory — upload or configure bot files afterwards. Use the trash icon to permanently remove a folder.</div>
              </div>

            </div>
          </div>
        </div>

      </section>
    </main>
  </div>

  <!-- Modal: Manage account access to servers -->
  <div id="accountModalOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" id="accountModal">
      <h3 id="accountModalTitle">Manage access</h3>
      <div id="accountModalBody" style="margin-top:10px;max-height:360px;overflow:auto"></div>
      <div class="actions" style="margin-top:12px">
        <button class="btn ghost" id="accountModalClose">Close</button>
      </div>
    </div>
  </div>

  <!-- NEW Modal: Grant permissions when adding a server -->
  <div id="permModalOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" id="permModal">
      <h3 id="permModalTitle">Grant permissions</h3>
      <div id="permModalBody" style="margin-top:10px;max-height:420px;overflow:auto"></div>
      <div class="actions" style="margin-top:12px">
        <button class="btn ghost" id="permCancel">Cancel</button>
        <button class="btn" id="permSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Create template modal -->
  <div id="createTemplateOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" id="createTemplateModal">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
        <h3 style="margin:0;display:flex;align-items:center;gap:8px"><i class="fa-solid fa-boxes-stacked"></i> Create template</h3>
        <div style="font-size:12px;color:var(--muted)">Inspired by 2025 design systems — layered glass, bold gradients and calm typography.</div>
      </div>

      <div style="margin-top:12px;display:grid;gap:14px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));align-items:start">
        <div style="display:grid;gap:10px;padding:14px;border-radius:14px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.05);backdrop-filter:blur(8px)">
          <label style="display:grid;gap:4px;font-weight:600">Template name
            <input type="text" id="ct_name" placeholder="e.g. Minecraft" style="padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.08);background:rgba(0,0,0,0.25)">
          </label>
          <label style="display:grid;gap:4px;font-weight:600">Template ID
            <input type="text" id="ct_id" placeholder="Lowercase, a-z 0-9 - _" style="padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.08);background:rgba(0,0,0,0.25)">
          </label>
          <label style="display:grid;gap:4px;font-weight:600">Description
            <textarea id="ct_description" placeholder="Explain what the template does" style="padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.08);min-height:72px;background:rgba(0,0,0,0.25);"></textarea>
          </label>
          <label style="display:grid;gap:4px;font-weight:600">Docker image
            <input type="text" id="ct_image" placeholder="itzg/minecraft-server" style="padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.08);background:rgba(0,0,0,0.25)">
            <small class="muted" style="font-size:12px">We’ll pull this image automatically when the template is used.</small>
          </label>
          <label style="display:grid;gap:4px;font-weight:600">Tag
            <input type="text" id="ct_tag" placeholder="latest" style="padding:10px;border-radius:10px;border:1px solid rgba(15,23,42,0.08);background:rgba(0,0,0,0.25)" value="latest">
          </label>

          <div class="actions" style="margin-top:4px;display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn ghost" id="createTemplateCancel">Cancel</button>
            <button class="btn" id="createTemplateSave"><i class="fa-solid fa-plus"></i> Create</button>
          </div>
          <div id="createTemplateFeedback" class="muted" style="margin-top:2px"></div>
        </div>

        <div style="padding:16px;border-radius:16px;background:linear-gradient(135deg, rgba(99,102,241,0.35), rgba(236,72,153,0.25));border:1px solid rgba(255,255,255,0.08);box-shadow:0 15px 40px rgba(0,0,0,0.25);color:#e9e9f5;min-height:100%">
          <div style="display:flex;align-items:center;gap:10px;font-weight:700;font-size:15px;margin-bottom:8px">
            <span style="display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:12px;background:rgba(255,255,255,0.12);backdrop-filter:blur(6px)"><i class="fa-solid fa-wand-magic-sparkles"></i></span>
            <div>
              <div>Modern build — ready for 2025</div>
              <small style="color:rgba(233,233,245,0.8);font-weight:400">Consistent geometry, soft gradients, glass panels.</small>
            </div>
          </div>
          <ul style="padding-left:18px;display:grid;gap:6px;margin:0">
            <li>Use clear IDs so templates stay portable across nodes.</li>
            <li>Pair images and tags to keep deployments reproducible.</li>
            <li>Add concise descriptions; they show up in the create flow.</li>
            <li>Docker volumes default to <code>{BOT_DIR}:/data</code> for safety.</li>
          </ul>
          <div style="margin-top:12px;padding:10px;border-radius:12px;background:rgba(255,255,255,0.08);color:#f6f7fb;font-size:13px">
            Tip: keep tags pinned (e.g. <code>1.21.1</code>) for stability, or use <code>latest</code> for bleeding-edge.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Change server template modal -->
  <div id="changeTemplateOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" id="changeTemplateModal">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
        <div>
          <h3 style="margin:0;display:flex;align-items:center;gap:8px"><i class="fa-solid fa-wand-magic-sparkles"></i> Change template</h3>
          <div class="muted" id="changeTemplateSubtitle" style="margin-top:4px"></div>
        </div>
        <div class="inline-badge" id="changeTemplateCurrent">Current: —</div>
      </div>

      <div id="changeTemplateList" class="template-picker" style="margin-top:16px"></div>
      <div id="changeTemplateFeedback" class="muted" style="margin-top:8px"></div>

      <div class="actions" style="margin-top:16px;display:flex;justify-content:flex-end;gap:8px;flex-wrap:wrap">
        <button class="btn ghost" id="changeTemplateCancel">Cancel</button>
        <button class="btn" id="changeTemplateSave"><i class="fa-solid fa-check"></i> Save</button>
      </div>
    </div>
  </div>

  <!-- Change password modal -->
  <div id="modalOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal" id="changeModal">
      <h3>Change password</h3>
      <div style="margin-top:10px;display:grid;gap:8px">
        <input type="password" id="modalCurrent" placeholder="Current password" style="padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)">
        <input type="password" id="modalNew" placeholder="New password (min 8 chars)" style="padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)">
        <input type="password" id="modalConfirm" placeholder="Confirm new password" style="padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)">
      </div>
      <div class="actions">
        <button class="btn ghost" id="modalCancel">Cancel</button>
        <button class="btn" id="modalSave">Save</button>
      </div>
    </div>
  </div>

  <!-- CREATE NODE MODAL (80%) -->
  <div id="createNodeOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal big" id="createNodeModal">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3><i class="fa-solid fa-circle-plus"></i> Create node</h3>
        <button class="btn ghost" id="createNodeClose"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>

      <div style="margin-top:12px" class="grid-2">
        <div class="field-col">
          <label><strong>Node name</strong></label>
          <input id="cn_name" type="text" placeholder="e.g. eu-1" />
        </div>
        <div class="field-col">
          <label><strong>Address (IP or FQDN)</strong></label>
          <input id="cn_address" type="text" placeholder="e.g. 203.0.113.10 or node.example.com" />
        </div>
        <div class="field-col">
          <label><strong>RAM (GB)</strong></label>
          <input id="cn_ram_gb" type="number" min="1" step="1" placeholder="e.g. 16" />
        </div>
        <div class="field-col">
          <label><strong>Disk (GB)</strong></label>
          <input id="cn_disk_gb" type="number" min="10" step="10" placeholder="e.g. 250" />
        </div>
      </div>

      <div style="margin-top:16px">
        <div style="font-weight:700;margin-bottom:8px"><i class="fa-solid fa-plug"></i> Port allocations (max 1000)</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end">
          <label class="chip"><input type="radio" name="cn_ports_mode" value="range" checked> Range</label>
          <label class="chip"><input type="radio" name="cn_ports_mode" value="list"> List</label>

          <div id="cn_ports_range" class="row" style="display:flex;gap:8px;align-items:flex-end">
            <div class="field-col">
              <label>Start port</label>
              <input id="cn_port_start" type="number" min="1" max="65535" placeholder="e.g. 25565" />
            </div>
            <div class="field-col">
              <label>Count (≤1000)</label>
              <input id="cn_port_count" type="number" min="1" max="1000" placeholder="e.g. 50" />
            </div>
          </div>

          <div id="cn_ports_list" class="field-col" style="display:none;flex:1">
            <label>Ports (comma separated)</label>
            <input id="cn_port_list" type="text" placeholder="e.g. 25565,25566,25567" />
          </div>
        </div>
      </div>

      <div class="actions" style="margin-top:16px;display:flex;gap:8px">
        <button class="btn" id="createNodeSave"><i class="fa-solid fa-floppy-disk"></i> Create</button>
        <button class="btn ghost" id="createNodeCancel">Cancel</button>
      </div>

      <div id="createNodeFeedback" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <!-- NODE DETAILS MODAL (80%) -->
  <div id="nodeModalOverlay" class="modal-overlay" aria-hidden="true">
    <div class="modal big" id="nodeModal">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <h3 id="nm_title"><i class="fa-solid fa-diagram-project"></i> Node</h3>
          <div class="kpi" id="nm_subtitle"></div>
        </div>
        <button class="btn ghost" id="nodeModalClose"><i class="fa-solid fa-xmark"></i> Close</button>
      </div>

      <div class="tabs" style="margin-top:12px">
        <button data-tab="build" class="active"><i class="fa-solid fa-screwdriver-wrench"></i> Build Configuration</button>
        <button data-tab="linking"><i class="fa-solid fa-link"></i> Linking</button>
        <button data-tab="deletion"><i class="fa-solid fa-trash"></i> Deletion</button>
      </div>

      <!-- BUILD TAB -->
      <div class="tab-page active" id="tab_build">
        <div class="grid-2">
          <div class="field-col">
            <label><strong>Name</strong></label>
            <input id="nm_name" type="text" />
          </div>
          <div class="field-col">
            <label><strong>Address (IP or FQDN)</strong></label>
            <input id="nm_address" type="text" />
          </div>
          <div class="field-col">
            <label><strong>RAM (GB)</strong></label>
            <input id="nm_ram_gb" type="number" min="1" step="1" />
          </div>
          <div class="field-col">
            <label><strong>Disk (GB)</strong></label>
            <input id="nm_disk_gb" type="number" min="10" step="10" />
          </div>
        </div>

        <div style="margin-top:16px">
          <div style="font-weight:700;margin-bottom:8px"><i class="fa-solid fa-plug"></i> Port allocations</div>
          <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end">
            <label class="chip"><input type="radio" name="nm_ports_mode" value="range"> Range</label>
            <label class="chip"><input type="radio" name="nm_ports_mode" value="list"> List</label>

            <div id="nm_ports_range" class="row" style="display:flex;gap:8px;align-items:flex-end">
              <div class="field-col">
                <label>Start port</label>
                <input id="nm_port_start" type="number" min="1" max="65535" />
              </div>
              <div class="field-col">
                <label>Count (≤1000)</label>
                <input id="nm_port_count" type="number" min="1" max="1000" />
              </div>
            </div>

            <div id="nm_ports_list" class="field-col" style="display:none;flex:1">
              <label>Ports (comma separated)</label>
              <input id="nm_port_list" type="text" />
            </div>
          </div>
        </div>

        <div class="actions" style="margin-top:16px;display:flex;gap:8px">
          <button class="btn" id="nm_save"><i class="fa-solid fa-floppy-disk"></i> Save</button>
          <div id="nm_saveFeedback" class="muted"></div>
        </div>
      </div>

      <!-- LINKING TAB -->
      <div class="tab-page" id="tab_linking">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
          <div><strong>config.yml</strong> — place this on the node server (e.g. <code>/etc/adnode/config.yml</code>)</div>
          <div class="row-actions">
            <button class="btn ghost" id="nm_copyConfig"><i class="fa-solid fa-copy"></i> Copy</button>
            <button class="btn ghost" id="nm_downloadConfig"><i class="fa-solid fa-file-arrow-down"></i> Download</button>
          </div>
        </div>
        <textarea id="nm_configYml" class="codebox" readonly></textarea>

        <div style="margin-top:16px">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap">
            <div><strong>One-time command</strong> — press to reveal a ready-to-run setup command</div>
            <button class="btn" id="nm_showCmd"><i class="fa-solid fa-terminal"></i> Generate Command</button>
          </div>
          <textarea id="nm_cmd" class="codebox" style="display:none" readonly></textarea>
          <div class="row-actions" id="nm_cmdActions" style="display:none;margin-top:8px">
            <button class="btn ghost" id="nm_copyCmd"><i class="fa-solid fa-copy"></i> Copy</button>
          </div>
        </div>
      </div>

      <!-- DELETION TAB -->
      <div class="tab-page" id="tab_deletion">
        <div class="danger" style="padding:12px;border:1px solid;border-radius:8px">
          <div style="font-weight:700"><i class="fa-solid fa-triangle-exclamation"></i> Danger zone</div>
          <div class="muted" style="margin-top:6px">Deleting a node is permanent and requires that the node has <strong>no servers</strong> assigned.</div>
          <div class="actions" style="margin-top:12px">
            <button class="btn" id="nm_delete"><i class="fa-solid fa-trash"></i> Delete node</button>
          </div>
          <div id="nm_deleteFeedback" class="muted" style="margin-top:6px"></div>
        </div>
      </div>

    </div>
  </div>

  <script>
    const THEME_KEY = 'ui-theme';
    const BG_KEY = 'ui-background';
    const ACCENT_KEY = 'ui-accent';
    const DENSITY_KEY = 'ui-density';
    const ANIM_KEY = 'ui-animations';

    const themeLight = document.getElementById('themeLight');
    const themeDark = document.getElementById('themeDark');
    const body = document.body;
    const sidebarNav = document.getElementById('sidebarNav');
    const sections = document.querySelectorAll('.panel-section');
    const closeEscFixed = document.getElementById('closeEscFixed');
    const leftCol = document.getElementById('leftCol');
    const themeOverlay = document.getElementById('themeOverlay');

    const modalOverlay = document.getElementById('modalOverlay');
    const changeModal = document.getElementById('changeModal');
    const changePassCard = document.getElementById('changePassCard');
    const modalCancel = document.getElementById('modalCancel');
    const modalSave = document.getElementById('modalSave');

    const accountModalOverlay = document.getElementById('accountModalOverlay');
    const accountModal = document.getElementById('accountModal');
    const accountModalTitle = document.getElementById('accountModalTitle');
    const accountModalBody = document.getElementById('accountModalBody');
    const accountModalClose = document.getElementById('accountModalClose');

    const permModalOverlay = document.getElementById('permModalOverlay');
    const permModal = document.getElementById('permModal');
    const permModalTitle = document.getElementById('permModalTitle');
    const permModalBody = document.getElementById('permModalBody');
    const permCancel = document.getElementById('permCancel');
    const permSave = document.getElementById('permSave');

    const templatesFeedbackEl = document.getElementById('templatesFeedback');
    const templatesListEl = document.getElementById('templatesList');
    const openCreateTemplateBtn = document.getElementById('openCreateTemplate');
    const createTemplateOverlay = document.getElementById('createTemplateOverlay');
    const createTemplateModal = document.getElementById('createTemplateModal');
    const createTemplateCancel = document.getElementById('createTemplateCancel');
    const createTemplateSave = document.getElementById('createTemplateSave');
    const createTemplateFeedback = document.getElementById('createTemplateFeedback');
    const ct_id = document.getElementById('ct_id');
    const ct_name = document.getElementById('ct_name');
    const ct_description = document.getElementById('ct_description');
    const ct_image = document.getElementById('ct_image');
    const ct_tag = document.getElementById('ct_tag');
    const changeTemplateOverlay = document.getElementById('changeTemplateOverlay');
    const changeTemplateModal = document.getElementById('changeTemplateModal');
    const changeTemplateList = document.getElementById('changeTemplateList');
    const changeTemplateSubtitle = document.getElementById('changeTemplateSubtitle');
    const changeTemplateCurrent = document.getElementById('changeTemplateCurrent');
    const changeTemplateFeedback = document.getElementById('changeTemplateFeedback');
    const changeTemplateCancel = document.getElementById('changeTemplateCancel');
    const changeTemplateSave = document.getElementById('changeTemplateSave');
    let templatesCache = [];
    let templatesLoaded = false;
    let templateModalServer = null;
    let selectedTemplateId = null;

    const serversListEl = document.getElementById('serversList');
    const createServerBtn = document.getElementById('createServerBtn');
    const createServerNameInput = document.getElementById('createServerName');

    const accountsListEl = document.getElementById('accountsList');

    // ===== Nodes elements
    const nodesListEl = document.getElementById('nodesList');
    const openCreateNodeBtn = document.getElementById('openCreateNode');

    const createNodeOverlay = document.getElementById('createNodeOverlay');
    const createNodeModal = document.getElementById('createNodeModal');
    const createNodeClose = document.getElementById('createNodeClose');
    const createNodeCancel = document.getElementById('createNodeCancel');
    const createNodeSave = document.getElementById('createNodeSave');
    const createNodeFeedback = document.getElementById('createNodeFeedback');

    // Create node form fields
    const cn_name = document.getElementById('cn_name');
    const cn_address = document.getElementById('cn_address');
    const cn_ram_gb = document.getElementById('cn_ram_gb');
    const cn_disk_gb = document.getElementById('cn_disk_gb');
    const cn_ports_range = document.getElementById('cn_ports_range');
    const cn_ports_list = document.getElementById('cn_ports_list');
    const cn_port_start = document.getElementById('cn_port_start');
    const cn_port_count = document.getElementById('cn_port_count');
    const cn_port_list = document.getElementById('cn_port_list');

    // Node details modal
    const nodeModalOverlay = document.getElementById('nodeModalOverlay');
    const nodeModal = document.getElementById('nodeModal');
    const nodeModalClose = document.getElementById('nodeModalClose');
    const nm_title = document.getElementById('nm_title');
    const nm_subtitle = document.getElementById('nm_subtitle');

    // Tabs
    const nm_tabs = nodeModal.querySelectorAll('.tabs button');
    const tab_build = document.getElementById('tab_build');
    const tab_linking = document.getElementById('tab_linking');
    const tab_deletion = document.getElementById('tab_deletion');

    // Build fields
    const nm_name = document.getElementById('nm_name');
    const nm_address = document.getElementById('nm_address');
    const nm_ram_gb = document.getElementById('nm_ram_gb');
    const nm_disk_gb = document.getElementById('nm_disk_gb');
    const nm_ports_range = document.getElementById('nm_ports_range');
    const nm_ports_list = document.getElementById('nm_ports_list');
    const nm_port_start = document.getElementById('nm_port_start');
    const nm_port_count = document.getElementById('nm_port_count');
    const nm_port_list = document.getElementById('nm_port_list');
    const nm_save = document.getElementById('nm_save');
    const nm_saveFeedback = document.getElementById('nm_saveFeedback');

    // Linking fields
    const nm_configYml = document.getElementById('nm_configYml');
    const nm_copyConfig = document.getElementById('nm_copyConfig');
    const nm_downloadConfig = document.getElementById('nm_downloadConfig');
    const nm_showCmd = document.getElementById('nm_showCmd');
    const nm_cmd = document.getElementById('nm_cmd');
    const nm_cmdActions = document.getElementById('nm_cmdActions');
    const nm_copyCmd = document.getElementById('nm_copyCmd');

    // Deletion
    const nm_delete = document.getElementById('nm_delete');
    const nm_deleteFeedback = document.getElementById('nm_deleteFeedback');

    // ===== Permissions helpers (frontend memory) =====
    const PERM_KEYS = [
      "files_read","files_delete","files_rename","console_write","server_stop","server_start","files_upload","files_create"
    ];
    const ACL_PREFIX = 'acl:';
    function aclKey(email, server){ return `${ACL_PREFIX}${email}:${server}`; }
    function getSavedPerms(email, server){
      try { const raw = localStorage.getItem(aclKey(email, server)); if(!raw) return null; const obj = JSON.parse(raw); if (obj && typeof obj === 'object') return obj; } catch(e){}
      return null;
    }
    function setSavedPerms(email, server, perms){
      try { localStorage.setItem(aclKey(email, server), JSON.stringify(perms || {})); } catch(e){}
    }
    function summarizePerms(perms){
      const enabled = PERM_KEYS.filter(k => perms && perms[k]);
      return enabled.length ? enabled.join(', ') : 'none';
    }

    function applyTheme(theme, animate = true){
      if(animate){ themeOverlay.classList.add('show'); setTimeout(()=> themeOverlay.classList.remove('show'), 420); }
      if(theme === 'dark') body.setAttribute('data-theme','dark'); else body.removeAttribute('data-theme');
      themeLight.classList.remove('active'); themeDark.classList.remove('active'); if(theme === 'dark') themeDark.classList.add('active'); else themeLight.classList.add('active');
      document.getElementById('savedTheme').textContent = theme === 'dark' ? 'Dark' : 'White';
    }

    const savedTheme = localStorage.getItem(THEME_KEY) || 'dark';
    applyTheme(savedTheme, false);
    themeLight.addEventListener('click', ()=>{ localStorage.setItem(THEME_KEY,'white'); applyTheme('white', true); });
    themeDark.addEventListener('click', ()=>{ localStorage.setItem(THEME_KEY,'dark'); applyTheme('dark', true); });

    sidebarNav.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      sidebarNav.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const panel = btn.dataset.panel;
      if(panel === 'preferences') leftCol.style.display = ''; else leftCol.style.display = 'none';
      sections.forEach(s=>s.classList.remove('active'));
      const target = document.getElementById(panel); if(target) target.classList.add('active');

      if(panel === 'servers') {
        loadServers();
      }
      if(panel === 'account') {
        loadAccounts();
      }
      if(panel === 'nodes') {
        loadNodes();
      }
      if(panel === 'templates') {
        loadTemplates();
      }
    });

    function deleteAllClientCookies() {
      const cookies = document.cookie.split("; ");
      for (const cookie of cookies) {
        const eqPos = cookie.indexOf("=");
        const name = eqPos > -1 ? cookie.substr(0, eqPos) : cookie;
        document.cookie = name + "=;expires=Thu, 01 Jan 1970 00:00:00 GMT;path=/";
      }
    }

    document.getElementById("logoutBtn").addEventListener("click", async () => {
      try {
        deleteAllClientCookies();
        await fetch('/logout', { method: 'POST', credentials: 'include' });
        location.href = '/login';
      } catch (err) {
        console.error(err);
        alert('Failed to log out');
      }
    });

    function goHome(){ window.location.href = '/'; }
    closeEscFixed.addEventListener('click', goHome);
    document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') goHome(); });

    const presets = [
      {id:1,url:'https://images.hdqwalls.com/wallpapers/waves-digital-art-4k-m8.jpg'},
      {id:2,url:'https://images.hdqwalls.com/wallpapers/colorful-mountains-night-minimal-8k-w5.jpg'},
      {id:3,url:'https://raw.githubusercontent.com/BridgeHosting/manelemp3/refs/heads/main/manele/sunset-scenery-minimalist-digital-art-8k-wallpaper-uhdpaper.com-172%405%40b.webp'},
      {id:4,url:'https://cdn.pixabay.com/photo/2024/07/19/08/16/waves-8905720_1280.png'}
    ];

    const thumbsEl = document.getElementById('thumbs');
    const bgPreview = document.getElementById('bgPreview');
    const colorPicker = document.getElementById('colorPicker');
    const hexInput = document.getElementById('hexInput');
    const colorDot = document.getElementById('colorDot');
    const applyColorBtn = document.getElementById('applyColorBtn');
    const bgHex = document.getElementById('bgHex');
    const uploadFile = document.getElementById('uploadFile');
    const urlInput = document.getElementById('urlInput');
    const useUrlBtn = document.getElementById('useUrlBtn');
    const densitySelect = document.getElementById('densitySelect');
    const animationsToggle = document.getElementById('animationsToggle');
    const accentPicker = document.getElementById('accentPicker');
    const savedBg = document.getElementById('savedBg');

    async function sendBackgroundToServer(obj) {
      try {
        const res = await fetch('/api/settings/background', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(obj)
        });
        if (!res.ok) {
          const err = await res.json().catch(()=>({error:'failed'}));
          console.warn("Server returned error:", err);
        } else {
          console.log("Background updated on server");
        }
      } catch (e) {
        console.error("Failed to send background to server", e);
      }
    }

    presets.forEach(p => {
      const el = document.createElement('div');
      el.className = 'thumb';
      el.dataset.url = p.url;
      el.innerHTML = `<img src="${p.url}" alt="preset-${p.id}">`;
      el.addEventListener('click', () => selectThumb(el));
      thumbsEl.appendChild(el);
    });

    function selectThumb(el){
      document.querySelectorAll('.thumb').forEach(t=>t.classList.remove('selected'));
      el.classList.add('selected');
      const url = el.dataset.url;
      bgPreview.style.backgroundImage = `url(${url})`;
      bgPreview.style.backgroundSize = 'cover';
      bgPreview.style.backgroundPosition = 'center';
      const obj = {type:'url', value:url};
      localStorage.setItem(BG_KEY, JSON.stringify(obj));
      updateSavedBgText();
      sendBackgroundToServer(obj);
    }

    function setColor(hex){
      colorPicker.value = hex;
      hexInput.value = hex;
      colorDot.style.background = hex;
      bgPreview.style.backgroundImage = 'none';
      bgPreview.style.backgroundColor = hex;
      bgHex.textContent = hex;
      const obj = {type:'color', value:hex};
      localStorage.setItem(BG_KEY, JSON.stringify(obj));
      updateSavedBgText();
      sendBackgroundToServer(obj);
    }

    const bgSaved = localStorage.getItem(BG_KEY);
    if(bgSaved){
      try{
        const v = JSON.parse(bgSaved);
        if(v.type === 'image' || v.type === 'url' || v.type === 'upload'){
          bgPreview.style.backgroundImage = `url(${v.value})`;
          bgPreview.style.backgroundSize = 'cover';
          bgPreview.style.backgroundPosition = 'center';
        } else {
          bgPreview.style.backgroundImage = 'none';
          bgPreview.style.backgroundColor = v.value;
          colorPicker.value = v.value;
          hexInput.value = v.value;
          colorDot.style.background = v.value;
          bgHex.textContent = v.value;
        }
      } catch(e){
        console.warn('invalid bg saved');
      }
    } else { setColor('#282c34'); }

    function updateSavedBgText(){
      const raw = localStorage.getItem(BG_KEY);
      if(!raw){ savedBg.textContent = 'None'; return; }
      try{ const v = JSON.parse(raw); savedBg.textContent = v.type + ' — ' + (typeof v.value === 'string' && v.value.length>40? v.value.slice(0,40)+'...': v.value); }catch(e){ savedBg.textContent = 'None' }
    }
    updateSavedBgText();

    colorPicker.addEventListener('input', (e)=> setColor(e.target.value));
    hexInput.addEventListener('change', (e)=>{ const v = e.target.value.trim(); if(/^#([0-9A-Fa-f]{3}){1,2}$/.test(v)) setColor(v); else alert('Please enter a valid hex, e.g. #282c34'); });
    applyColorBtn.addEventListener('click', ()=>{ const h = hexInput.value.trim(); if(/^#([0-9A-Fa-f]{3}){1,2}$/.test(h)){ setColor(h); console.log('Applied color selection:', h); } else alert('Invalid hex'); });

    uploadFile.addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = async ()=>{
        const dataUrl = reader.result;
        const obj = {type:'upload', name:file.name, value:dataUrl};
        localStorage.setItem(BG_KEY, JSON.stringify(obj));
        bgPreview.style.backgroundImage = `url(${dataUrl})`;
        bgPreview.style.backgroundSize = 'cover';
        bgPreview.style.backgroundPosition = 'center';
        updateSavedBgText();
        await sendBackgroundToServer({type:'upload', value:dataUrl});
      };
      reader.readAsDataURL(file);
    });

    useUrlBtn.addEventListener('click', async ()=>{
      const url = urlInput.value.trim();
      if(!url) return alert('Enter a valid link');
      if(!/^https?:\/\//i.test(url)) return alert('URL must start with http:// or https://');
      const obj = {type:'url', value:url};
      localStorage.setItem(BG_KEY, JSON.stringify(obj));
      bgPreview.style.backgroundImage = `url(${url})`;
      bgPreview.style.backgroundSize = 'cover';
      bgPreview.style.backgroundPosition = 'center';
      updateSavedBgText();
      await sendBackgroundToServer(obj);
    });

    const initDensity = localStorage.getItem(DENSITY_KEY) || 'comfortable';
    function applyDensity(d){ if(d === 'compact') body.classList.add('compact'); else body.classList.remove('compact'); document.getElementById('densitySelect').value = d; }
    applyDensity(initDensity);
    document.getElementById('densitySelect').addEventListener('change',(e)=>{ localStorage.setItem(DENSITY_KEY,e.target.value); applyDensity(e.target.value); });

    const initAnim = localStorage.getItem(ANIM_KEY);
    const animationsToggleEl = document.getElementById('animationsToggle');
    animationsToggleEl.checked = initAnim === null ? true : initAnim === 'true';
    function applyAnimations(enabled){ if(!enabled) body.classList.add('no-animations'); else body.classList.remove('no-animations'); }
    applyAnimations(animationsToggleEl.checked);
    animationsToggleEl.addEventListener('change',(e)=>{ localStorage.setItem(ANIM_KEY,e.target.checked); applyAnimations(e.target.checked); });

    const savedAccent = localStorage.getItem(ACCENT_KEY);
    if(savedAccent) document.documentElement.style.setProperty('--accent', savedAccent);
    accentPicker.addEventListener('input',(e)=>{ document.documentElement.style.setProperty('--accent', e.target.value); localStorage.setItem(ACCENT_KEY,e.target.value); });

    changePassCard.addEventListener('click', ()=>{ modalOverlay.classList.add('show'); changeModal.classList.add('show'); });
    modalCancel.addEventListener('click', ()=>{ modalOverlay.classList.remove('show'); changeModal.classList.remove('show'); });
    modalOverlay.addEventListener('click', (e)=>{ if(e.target === modalOverlay){ modalOverlay.classList.remove('show'); changeModal.classList.remove('show'); } });

    modalSave.addEventListener('click', async ()=>{
      const cur = document.getElementById('modalCurrent').value;
      const nw = document.getElementById('modalNew').value;
      const cf = document.getElementById('modalConfirm').value;
      if(!cur || !nw || !cf) return alert('Fill all fields');
      if(nw.length < 8) return alert('New password must be at least 8 characters');
      if(nw !== cf) return alert('Passwords do not match');

      try {
        const res = await fetch('/api/settings/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ current: cur, newPassword: nw, confirm: cf })
        });

        const data = await res.json().catch(()=>({ error: 'Invalid server response' }));

        if(!res.ok) {
          alert(data.error || 'Failed to change password');
          return;
        }

        alert('Password changed successfully');
        document.getElementById('modalCurrent').value = '';
        document.getElementById('modalNew').value = '';
        document.getElementById('modalConfirm').value = '';
        modalOverlay.classList.remove('show'); changeModal.classList.remove('show');
        window.location.reload();
      } catch (err) {
        console.error(err);
        alert('Network error');
      }
    });

    // ======== SERVERS (local + remote) ========
async function loadServers(){
  serversListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">Loading…</div>`;
  try {
    const res = await fetch('/api/settings/servers');
    if (!res.ok) {
      const err = await res.json().catch(()=>({error:'failed'}));
      serversListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">Failed to load servers</div>`;
      console.warn(err);
      return;
    }
    const data = await res.json();
    // data.items = [{name, isLocal, nodeId}]
    const items = Array.isArray(data.items)
      ? data.items
      : (Array.isArray(data.names) ? data.names.map(n => ({ name:n, isLocal:true, nodeId:null })) : []);
    renderServers(items);
  } catch (e) {
    console.error(e);
    serversListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">Network error</div>`;
  }
}

    function shortId(id){
      const s = String(id || '');
      return s.length > 8 ? s.slice(0,8) : s || '—';
    }

function renderServers(list){
  if(!Array.isArray(list) || list.length === 0){
    serversListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">No servers found.</div>`;
    return;
  }
  serversListEl.innerHTML = '';
  list.forEach(item=>{
    const name = item.name || String(item);
    const isLocal = (item && typeof item.isLocal === 'boolean') ? item.isLocal : (!item.nodeId);
    const chipText = isLocal ? 'ID: localhost' : `ID: ${item.nodeId}`;
    const templateId = (item && item.template) ? String(item.template) : null;
    const templateLabel = templateId ? templateId : 'template: unknown';

    const row = document.createElement('div');
    row.className = 'server-row clickable-card';
    row.dataset.name = name;
    if (templateId) row.dataset.template = templateId;
    row.innerHTML = `
      <div class="left">
        <div class="iconWrap"><i class="fa-solid fa-folder"></i></div>
        <div class="name">${escapeHtml(name)}</div>
        <span class="inline-badge" style="margin-left:8px">${escapeHtml(chipText)}</span>
        <span class="inline-badge" style="margin-left:8px;background:rgba(79,70,229,0.12);color:var(--text)">${escapeHtml(templateLabel)}</span>
      </div>
      <div class="actions">
        <button class="btn ghost change-template" data-name="${encodeURIComponent(name)}" data-template="${templateId ? encodeURIComponent(templateId) : ''}" title="Change template">
          <i class="fa-solid fa-wand-magic-sparkles"></i>
        </button>
        <button class="btn ghost delete-server" data-name="${encodeURIComponent(name)}" title="Delete ${escapeHtml(name)}">
          <i class="fa-solid fa-trash"></i>
        </button>
      </div>
    `;
    serversListEl.appendChild(row);
  });
}

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
    }

    // ======== Templates ========
    async function loadTemplates(){
      if(!templatesListEl) return;
      if(templatesFeedbackEl) templatesFeedbackEl.textContent = '';
      templatesListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">Loading templates…</div>`;
      try {
        const res = await fetch('/api/settings/templates');
        if(!res.ok){
          const err = await res.json().catch(()=>({error:'failed'}));
          templatesListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">Failed to load templates</div>`;
          if(templatesFeedbackEl) templatesFeedbackEl.textContent = err.error || 'Unable to load templates.';
          console.warn(err);
          return;
        }
        const data = await res.json();
        templatesCache = Array.isArray(data.templates) ? data.templates : [];
        templatesLoaded = true;
        renderTemplates(templatesCache);
      } catch (e) {
        console.error(e);
        templatesListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">Network error</div>`;
      }
    }

    function renderTemplates(list){
      if(!templatesListEl) return;
      if(!Array.isArray(list) || list.length === 0){
        templatesListEl.innerHTML = `<div style="padding:16px;border:1px dashed rgba(255,255,255,0.08);border-radius:12px;background:rgba(255,255,255,0.02);color:var(--muted)">No templates found. Create one to get started.</div>`;
        return;
      }
      templatesListEl.innerHTML = '';
      list.forEach(tpl => {
        const row = document.createElement('div');
        row.className = 'template-card clickable-card';
        row.innerHTML = `
          <div class="template-card__body">
            <div class="template-card__icon"><i class="fa-solid fa-boxes-stacked"></i></div>
            <div class="template-card__content">
              <div class="template-card__title">
                <div class="name">${escapeHtml(tpl.name || tpl.id)}</div>
                <span class="inline-badge">ID: ${escapeHtml(tpl.id || '—')}</span>
              </div>
              <div class="template-card__description">${escapeHtml(tpl.description || 'No description')}</div>
              <div class="template-card__meta">
                <span><i class="fa-solid fa-cube"></i> ${escapeHtml((tpl.docker && tpl.docker.image) ? tpl.docker.image : 'Custom image')}</span>
                <span><i class="fa-solid fa-tag"></i> ${escapeHtml((tpl.docker && tpl.docker.tag) ? tpl.docker.tag : 'latest')}</span>
                <span><i class="fa-solid fa-folder-tree"></i> ${escapeHtml((tpl.docker && tpl.docker.volumes && tpl.docker.volumes.length) ? tpl.docker.volumes.join(', ') : '{BOT_DIR}:/data')}</span>
              </div>
            </div>
            <div class="template-card__actions">
              <button class="btn ghost delete-template" data-id="${encodeURIComponent(tpl.id || '')}" data-name="${encodeURIComponent(tpl.name || tpl.id || '')}" title="Delete template">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
        `;
        templatesListEl.appendChild(row);
      });
    }

    async function ensureTemplatesLoadedForModal(){
      if(templatesLoaded && Array.isArray(templatesCache) && templatesCache.length) return templatesCache;
      try {
        const res = await fetch('/api/settings/templates');
        if(res.ok){
          const data = await res.json().catch(()=>({ templates: [] }));
          templatesCache = Array.isArray(data.templates) ? data.templates : [];
          templatesLoaded = true;
        }
      } catch (e) {
        console.error(e);
      }
      return templatesCache || [];
    }

    function closeChangeTemplateModal(){
      changeTemplateOverlay.classList.remove('show');
      changeTemplateModal.classList.remove('show');
      changeTemplateFeedback.textContent = '';
      templateModalServer = null;
      selectedTemplateId = null;
    }

    function templateDisplayName(tpl){
      return tpl || 'template: unknown';
    }

    async function renderChangeTemplateOptions(){
      changeTemplateList.innerHTML = `<div style="padding:12px;color:var(--muted)">Loading templates…</div>`;
      const list = await ensureTemplatesLoadedForModal();
      if(!Array.isArray(list) || list.length === 0){
        changeTemplateList.innerHTML = `<div style="padding:12px;color:var(--muted)">No templates available. Create one first.</div>`;
        return;
      }
      changeTemplateList.innerHTML = '';
      list.forEach(tpl => {
        const card = document.createElement('div');
        const id = tpl && tpl.id ? String(tpl.id) : '';
        card.className = 'template-pill clickable-card';
        if(selectedTemplateId && id.toLowerCase() === String(selectedTemplateId).toLowerCase()) card.classList.add('active');
        card.innerHTML = `
          <div class="title">${escapeHtml(tpl.name || id || 'Untitled')}</div>
          <div class="desc">${escapeHtml(tpl.description || 'No description provided.')}</div>
          <div class="tag">ID: ${escapeHtml(id || 'n/a')}</div>
        `;
        card.addEventListener('click', ()=>{
          selectedTemplateId = id;
          renderChangeTemplateOptions();
          changeTemplateFeedback.textContent = '';
        });
        changeTemplateList.appendChild(card);
      });
    }

    function openChangeTemplateModal(name, currentTemplate){
      templateModalServer = name;
      selectedTemplateId = currentTemplate || '';
      changeTemplateSubtitle.textContent = `Switch ${name} to another template from your library.`;
      changeTemplateCurrent.textContent = `Current: ${templateDisplayName(currentTemplate)}`;
      changeTemplateFeedback.textContent = '';
      renderChangeTemplateOptions();
      changeTemplateOverlay.classList.add('show');
      changeTemplateModal.classList.add('show');
    }

    function updateServerTemplateInRow(name, templateId){
      const row = Array.from(serversListEl.querySelectorAll('.server-row')).find(r => r.dataset.name === name);
      if(!row) return;
      row.dataset.template = templateId || '';
      const badges = row.querySelectorAll('.inline-badge');
      if(badges && badges[1]) badges[1].textContent = templateDisplayName(templateId);
      const changeBtn = row.querySelector('.change-template');
      if(changeBtn) changeBtn.dataset.template = templateId ? encodeURIComponent(templateId) : '';
    }

    function openTemplateModal(){
      createTemplateOverlay.classList.add('show');
      createTemplateModal.classList.add('show');
      createTemplateFeedback.textContent = '';
    }

    function closeTemplateModal(){
      createTemplateOverlay.classList.remove('show');
      createTemplateModal.classList.remove('show');
      createTemplateFeedback.textContent = '';
    }

    [createTemplateCancel, createTemplateOverlay].forEach(el => {
      if(!el) return;
      el.addEventListener('click', (e)=>{
        if(e.target === el || el === createTemplateCancel){
          closeTemplateModal();
        }
      });
    });

    if(openCreateTemplateBtn){
      openCreateTemplateBtn.addEventListener('click', ()=>{
        ct_name.value = '';
        ct_id.value = '';
        ct_description.value = '';
        ct_image.value = '';
        ct_tag.value = 'latest';
        openTemplateModal();
      });
    }

    if(createTemplateSave){
      createTemplateSave.addEventListener('click', async ()=>{
        const id = (ct_id.value || '').trim();
        const name = (ct_name.value || '').trim();
        const description = (ct_description.value || '').trim();
        const image = (ct_image.value || '').trim();
        const tag = (ct_tag.value || '').trim();

        if(!name || !id || !image){
          createTemplateFeedback.textContent = 'Please fill out name, id and docker image.';
          return;
        }

        try {
          createTemplateSave.disabled = true;
          createTemplateFeedback.textContent = 'Saving template…';
          const res = await fetch('/api/settings/templates', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, name, description, dockerImage: image, dockerTag: tag })
          });
          const data = await res.json().catch(()=>({ error: 'Invalid response' }));
          if(!res.ok){
            createTemplateFeedback.textContent = data.error || 'Failed to save template';
            createTemplateSave.disabled = false;
            return;
          }
          createTemplateFeedback.textContent = 'Template created!';
          setTimeout(closeTemplateModal, 400);
          loadTemplates();
        } catch (e) {
          console.error(e);
          createTemplateFeedback.textContent = 'Network error while saving template';
        } finally {
          createTemplateSave.disabled = false;
        }
      });
    }

    async function deleteTemplate(templateId, templateName, btn){
      if(!templateId) return;
      if(!confirm(`Delete template "${templateName || templateId}"? It cannot be undone.`)) return;
      try {
        if(btn){
          btn.disabled = true;
          btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        }
        const res = await fetch(`/api/settings/templates/${encodeURIComponent(templateId)}`, { method: 'DELETE' });
        const data = await res.json().catch(()=>({}));
        if(!res.ok){
          const serversMsg = Array.isArray(data.servers) && data.servers.length ? ` In use by: ${data.servers.join(', ')}` : '';
          if(templatesFeedbackEl) templatesFeedbackEl.textContent = (data.error || 'Failed to delete template.') + serversMsg;
          return;
        }
        if(templatesFeedbackEl) templatesFeedbackEl.textContent = `Template "${templateName || templateId}" deleted.`;
        loadTemplates();
      } catch (err) {
        console.error(err);
        if(templatesFeedbackEl) templatesFeedbackEl.textContent = 'Network error while deleting template.';
      } finally {
        if(btn){
          btn.disabled = false;
          btn.innerHTML = '<i class="fa-solid fa-trash"></i>';
        }
      }
    }

    if(templatesListEl){
      templatesListEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('.delete-template');
        if(!btn) return;
        const id = decodeURIComponent(btn.dataset.id || '');
        const name = decodeURIComponent(btn.dataset.name || '') || id;
        deleteTemplate(id, name, btn);
      });
    }

    createServerBtn.addEventListener('click', async ()=>{
      const raw = createServerNameInput.value.trim();
      if(!raw) return alert('Enter a server name');
      if(!/^[\w\-. ]{1,80}$/.test(raw)) return alert('Invalid name — allowed: letters, numbers, -, _, ., space');
      try {
        createServerBtn.disabled = true;
        createServerBtn.innerHTML = 'Creating...';
        const res = await fetch('/api/settings/servers', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ name: raw })
        });
        const data = await res.json().catch(()=>({ error: 'Invalid response' }));
        if(!res.ok){
          alert(data.error || 'Failed to create server');
          createServerBtn.disabled = false;
          createServerBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Create';
          return;
        }
        createServerNameInput.value = '';
        loadServers();
      } catch (err) {
        console.error(err);
        alert('Network error while creating server');
      } finally {
        createServerBtn.disabled = false;
        createServerBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Create';
      }
    });

    serversListEl.addEventListener('click', async (e)=>{
      const changeBtn = e.target.closest('.change-template');
      if (changeBtn) {
        const encName = changeBtn.dataset.name;
        if (!encName) return;
        const name = decodeURIComponent(encName);
        const row = changeBtn.closest('.server-row');
        const currentTemplate = (row && row.dataset.template) || (changeBtn.dataset.template ? decodeURIComponent(changeBtn.dataset.template) : '');
        openChangeTemplateModal(name, currentTemplate || '');
        return;
      }

      const btn = e.target.closest('.delete-server');
      if(!btn) return;
      const encName = btn.dataset.name;
      if(!encName) return;
      const name = decodeURIComponent(encName);
      // The backend will detect if it's remote by checking servers.json (nodeId) and will:
      // - stop & remove docker container on the node,
      // - delete /var/lib/node/volumes/volumes/<server> on node,
      // - remove the entry from servers.json
      const ok = confirm(`Delete server "${name}"? This will permanently remove the folder and its contents.${'\n'}If it is on a node, the node container and files will be removed too.`);
      if(!ok) return;
      try {
        btn.disabled = true;
        const res = await fetch(`/api/settings/servers/${encodeURIComponent(name)}`, { method: 'DELETE' });
        const data = await res.json().catch(()=>({ error: 'Invalid response' }));
        if(!res.ok){
          alert(data.error || 'Failed to delete server');
          btn.disabled = false;
          return;
        }
        // Remove row from UI
        const row = btn.closest('.server-row');
        if(row) row.remove();
        // If list is empty, refresh for the empty state
        if (!serversListEl.children.length) {
          loadServers();
        }
      } catch (err) {
        console.error(err);
        alert('Network error while deleting server');
        btn.disabled = false;
      }
    });

    changeTemplateCancel.addEventListener('click', closeChangeTemplateModal);
    changeTemplateOverlay.addEventListener('click', (e)=>{ if(e.target === changeTemplateOverlay) closeChangeTemplateModal(); });

    changeTemplateSave.addEventListener('click', async ()=>{
      if(!templateModalServer) return;
      if(!selectedTemplateId){
        changeTemplateFeedback.textContent = 'Select a template first.';
        return;
      }
      try {
        changeTemplateSave.disabled = true;
        changeTemplateSave.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving';
        const res = await fetch(`/api/settings/servers/${encodeURIComponent(templateModalServer)}/template`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ templateId: selectedTemplateId })
        });
        const data = await res.json().catch(()=>({ error: 'Invalid response' }));
        if(!res.ok){
          changeTemplateFeedback.textContent = data.error || 'Failed to update template';
          return;
        }
        updateServerTemplateInRow(templateModalServer, data.template || selectedTemplateId);
        closeChangeTemplateModal();
      } catch (e) {
        console.error(e);
        changeTemplateFeedback.textContent = 'Network error while saving template';
      } finally {
        changeTemplateSave.disabled = false;
        changeTemplateSave.innerHTML = '<i class="fa-solid fa-check"></i> Save';
      }
    });

    async function loadAccounts(){
      accountsListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">Loading accounts…</div>`;
      try {
        const res = await fetch('/api/settings/accounts');
        if (!res.ok) {
          const err = await res.json().catch(()=>({error:'failed'}));
          accountsListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">Failed to load accounts</div>`;
          console.warn(err);
          return;
        }
        const data = await res.json();
        renderAccounts((data.accounts || []), (data.bots || []));
      } catch (e) {
        console.error(e);
        accountsListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">Network error</div>`;
      }
    }

    function renderAccounts(accounts, bots){
      accountsListEl.innerHTML = '';
      if(!Array.isArray(accounts) || accounts.length === 0){
        accountsListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">No accounts found in <code>user-access.json</code>.</div>`;
        return;
      }
      accounts.forEach(acc=>{
        const div = document.createElement('div');
        div.className = 'account-row';
        const accessLabel = (Array.isArray(acc.servers) && acc.servers.length>0) ? `${acc.servers.length} access` : 'no access';
        div.innerHTML = `
          <div class="account-left">
            <div class="iconWrap" style="width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.04)"><i class="fa-solid fa-user"></i></div>
            <div>
              <div class="account-email">${escapeHtml(acc.email)}</div>
              <div style="color:var(--muted);font-size:13px">${escapeHtml(accessLabel)}</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn ghost manage-access" data-email="${encodeURIComponent(acc.email)}" title="Manage access for ${escapeHtml(acc.email)}"><i class="fa-solid fa-server"></i></button>
          </div>
        `;
        accountsListEl.appendChild(div);
      });
      accountsListEl._bots = bots || [];
    }

    accountsListEl.addEventListener('click', (e)=>{
      const btn = e.target.closest('.manage-access');
      if(!btn) return;
      const enc = btn.dataset.email;
      if(!enc) return;
      const email = decodeURIComponent(enc);
      openManageAccessModal(email);
    });

    async function openManageAccessModal(email){
      accountModalTitle.textContent = `Manage access for ${email}`;
      accountModalBody.innerHTML = `<div style="padding:12px;color:var(--muted)">Loading…</div>`;
      accountModalOverlay.classList.add('show');
      accountModal.classList.add('show');

      try {
        const res = await fetch('/api/settings/accounts');
        if(!res.ok) {
          const err = await res.json().catch(()=>({error:'failed'}));
          accountModalBody.innerHTML = `<div style="padding:12px;color:var(--muted)">Failed to load data</div>`;
          console.warn(err);
          return;
        }
        const data = await res.json();
        const accounts = data.accounts || [];
        const bots = data.bots || [];
        const rec = accounts.find(a => String(a.email).toLowerCase() === String(email).toLowerCase());
        const userServers = rec ? (Array.isArray(rec.servers) ? rec.servers : []) : [];

        if(!Array.isArray(bots) || bots.length === 0){
          accountModalBody.innerHTML = `<div style="padding:12px;color:var(--muted)">No server folders found.</div>`;
          return;
        }

        const list = document.createElement('div');
        list.style.display = 'grid';
        list.style.gap = '8px';

        bots.forEach(b=>{
          const row = document.createElement('div');
          row.style.display = 'flex';
          row.style.justifyContent = 'space-between';
          row.style.alignItems = 'center';
          row.style.padding = '8px';
          row.style.borderRadius = '8px';
          row.style.background = 'var(--card-contrast-bg)';
          row.style.border = '1px solid rgba(15,23,42,0.04)';

          const left = document.createElement('div');
          left.style.display = 'flex';
          left.style.gap = '8px';
          left.style.alignItems = 'center';
          left.innerHTML = `<div style="width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.04)"><i class="fa-solid fa-folder"></i></div><div><div style="font-weight:700">${escapeHtml(b)}</div></div>`;

          let hasAccess = userServers.includes(b) || userServers.includes('all');

          const actions = document.createElement('div');
          actions.style.display = 'flex';
          actions.style.gap = '8px';
          actions.style.alignItems = 'center';

          if (hasAccess) {
            const editBtn = document.createElement('button');
            editBtn.className = 'btn';
            editBtn.title = `Edit permissions for ${escapeHtml(email)} on ${escapeHtml(b)}`;
            editBtn.innerHTML = `<i class="fa-solid fa-pen-to-square"></i> Edit`;
            editBtn.addEventListener('click', () => {
              const existing = getSavedPerms(email, b);
              openPermsModal(email, b, () => openManageAccessModal(email), existing);
            });

            const revokeBtn = document.createElement('button');
            revokeBtn.className = 'btn ghost';
            revokeBtn.title = `Revoke access for ${escapeHtml(email)} on ${escapeHtml(b)}`;
            revokeBtn.textContent = 'Revoke';
            revokeBtn.addEventListener('click', async () => {
              revokeBtn.disabled = true;
              try {
                const r = await fetch(`/api/settings/accounts/${encodeURIComponent(email)}/remove`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ server: b })
                });
                if (!r.ok) {
                  const err = await r.json().catch(()=>({ error: 'failed' }));
                  alert(err.error || 'Failed to revoke access');
                  revokeBtn.disabled = false;
                } else {
                  setSavedPerms(email, b, {});
                  openManageAccessModal(email);
                }
              } catch (err) {
                console.error(err);
                alert('Network error');
                revokeBtn.disabled = false;
              }
            });

            actions.appendChild(editBtn);
            actions.appendChild(revokeBtn);
          } else {
            const addBtn = document.createElement('button');
            addBtn.className = 'btn';
            addBtn.textContent = 'Add';
            addBtn.addEventListener('click', () => {
              const remembered = getSavedPerms(email, b);
              openPermsModal(email, b, () => openManageAccessModal(email), remembered);
            });
            actions.appendChild(addBtn);
          }

          row.appendChild(left);
          row.appendChild(actions);
          list.appendChild(row);
        });

        accountModalBody.innerHTML = '';
        accountModalBody.appendChild(list);

      } catch (e) {
        console.error(e);
        accountModalBody.innerHTML = `<div style="padding:12px;color:var(--muted)">Network error</div>`;
      }
    }

    accountModalClose.addEventListener('click', ()=>{
      accountModalOverlay.classList.remove('show');
      accountModal.classList.remove('show');
    });

    accountModalOverlay.addEventListener('click', (e)=>{
      if(e.target === accountModalOverlay) {
        accountModalOverlay.classList.remove('show');
        accountModal.classList.remove('show');
      }
    });

    // ===== Permissions modal (second popup) =====
    function openPermsModal(email, server, onSaved, existingPerms){
      const isEdit = !!existingPerms && Object.keys(existingPerms).length > 0;
      permModalTitle.textContent = isEdit
        ? `Edit permissions for ${email} on ${server}`
        : `Grant permissions for ${email} on ${server}`;

      permModalBody.innerHTML = buildPermsFormHtml(existingPerms);
      permModalOverlay.classList.add('show');
      permModal.classList.add('show');

      permModal.dataset.email = email;
      permModal.dataset.server = server;
      permModal.dataset.mode = isEdit ? 'edit' : 'add';
      permModal._onSaved = typeof onSaved === 'function' ? onSaved : null;

      const selAll = document.getElementById('perm_all');
      const permInputs = Array.from(permModalBody.querySelectorAll('input[type="checkbox"].perm'));
      selAll.checked = permInputs.length > 0 && permInputs.every(cb => cb.checked);
      selAll.addEventListener('change', () => {
        permInputs.forEach(cb => { cb.checked = selAll.checked; });
      });
      permInputs.forEach(cb => {
        cb.addEventListener('change', () => {
          selAll.checked = permInputs.length > 0 && permInputs.every(x => x.checked);
        });
      });
    }

    function closePermsModal(){
      permModalOverlay.classList.remove('show');
      permModal.classList.remove('show');
      permModal.dataset.email = '';
      permModal.dataset.server = '';
      permModal.dataset.mode = '';
      permModal._onSaved = null;
    }

    function buildPermsFormHtml(existing){
      const currentSummary = existing ? summarizePerms(existing) : null;

      const rows = PERM_KEYS.map((key) => {
        const labelMap = {
          files_read: 'access to files (read)',
          files_delete: 'access to delete files',
          files_rename: 'access to rename files',
          console_write: 'access to write in console',
          server_stop: 'access to stop server',
          server_start: 'access to start server',
          files_upload: 'access to upload files',
          files_create: 'access to create files/folders'
        };
        const checked = existing ? !!existing[key] : (key === 'files_read');
        return `
          <label style="display:flex;align-items:center;gap:8px">
            <input class="perm" data-key="${key}" type="checkbox" ${checked ? 'checked' : ''}>
            <span>${labelMap[key]}</span>
          </label>
        `;
      }).join('');

      const info = existing
        ? `<div class="muted" style="font-size:13px;margin-bottom:6px">
             <strong>Current:</strong> ${escapeHtml(currentSummary)}.
             Changes here will <u>add</u> new permissions and keep the existing ones.
           </div>`
        : `<div class="muted" style="font-size:13px;margin-bottom:6px">
             We couldn't read current permissions. The selection below will be applied;
             to avoid losing existing rights, tick everything the user should keep.
           </div>`;

      return `
        ${info}
        <div style="display:grid;gap:10px">
          <label style="display:flex;align-items:center;gap:8px">
            <input id="perm_all" type="checkbox">
            <span><strong>Select all</strong></span>
          </label>
          ${rows}
        </div>
      `;
    }

    permCancel.addEventListener('click', closePermsModal);
    permModalOverlay.addEventListener('click', (e)=>{ if(e.target === permModalOverlay) closePermsModal(); });

    permSave.addEventListener('click', async ()=>{
      const email = permModal.dataset.email || '';
      const server = permModal.dataset.server || '';
      const mode = permModal.dataset.mode || 'add';
      if(!email || !server) { closePermsModal(); return; }

      const permInputs = Array.from(permModalBody.querySelectorAll('input[type="checkbox"].perm'));
      const selected = {};
      PERM_KEYS.forEach(k => selected[k] = false);
      permInputs.forEach(cb => {
        const key = cb.dataset.key;
        selected[key] = !!cb.checked;
      });

      let finalPerms;
      const remembered = getSavedPerms(email, server);
      if (mode === 'edit' && remembered) {
        finalPerms = {};
        PERM_KEYS.forEach(k => {
          finalPerms[k] = !!(remembered[k] || selected[k]);
        });
      } else {
        finalPerms = selected;
      }

      try {
        permSave.disabled = true;
        const res = await fetch(`/api/settings/accounts/${encodeURIComponent(email)}/grant-perms`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ server, permissions: finalPerms })
        });
        const data = await res.json().catch(()=>({ error: 'Invalid response' }));
        if(!res.ok){
          alert(data.error || 'Failed to grant permissions');
          return;
        }
        setSavedPerms(email, server, finalPerms);

        closePermsModal();
        if (typeof permModal._onSaved === 'function') permModal._onSaved();
      } catch (e) {
        console.error(e);
        alert('Network error');
      } finally {
        permSave.disabled = false;
      }
    });

    // ===== open panel from URL =====
    document.addEventListener('DOMContentLoaded', () => {
      const WAIT_INTERVAL = 100;
      const WAIT_TIMEOUT = 3000;
      const sidebarSelector = '#sidebarNav';

      const pathnameDefaults = [
        { match: /^\/servers(?:\/|$)/i, panel: 'servers' },
        { match: /^\/settings(?:\/|$)/i, panel: 'preferences' }
      ];

      function getRequestedPanel() {
        const params = new URLSearchParams(location.search);
        const p = params.get('panel');
        if (p) return p;
        if (location.hash && location.hash.length > 1) return location.hash.slice(1);
        const path = location.pathname || '/';
        for (const r of pathnameDefaults) {
          if (r.match.test(path)) return r.panel;
        }
        return null;
      }

      function tryOpenPanel(panel) {
        if (!panel) return false;
        const btn = document.querySelector(`${sidebarSelector} button[data-panel="${panel}"]`);
        if (btn) {
          try { btn.focus?.(); btn.click(); } catch { btn.dispatchEvent(new MouseEvent('click', { bubbles:true, cancelable:true })); }
          console.log(`[openPanel] opened panel: ${panel}`);
          return true;
        }
        return false;
      }

      async function waitForSidebarAndOpen() {
        const panel = getRequestedPanel();
        if (!panel) { console.log('[openPanel] no panel requested'); return; }
        const start = Date.now();
        if (document.querySelector(sidebarSelector)) { if (tryOpenPanel(panel)) return; }
        while (Date.now() - start < WAIT_TIMEOUT) {
          const side = document.querySelector(sidebarSelector);
          if (side) { if (tryOpenPanel(panel)) return; }
          await new Promise(r => setTimeout(r, WAIT_INTERVAL));
        }
        console.warn(`[openPanel] failed to open panel "${panel}"`);
        const directPanelEl = document.getElementById(panel);
        if (directPanelEl) {
          document.querySelectorAll('.panel-section').forEach(s => s.classList.remove('active'));
          directPanelEl.classList.add('active');
          console.log(`[openPanel] opened panel by id: ${panel}`);
        }
      }

      waitForSidebarAndOpen();
    });

    // ==========================
    // ===== NODES LOGIC ========
    // ==========================

    // --- Reachability probe (browser) + backend fallback
    async function fetchWithTimeout(url, opts = {}, ms = 2500) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), ms);
      try {
        const res = await fetch(url, { ...opts, signal: ctrl.signal });
        clearTimeout(t);
        return res;
      } catch (e) {
        clearTimeout(t);
        throw e;
      }
    }

    async function browserProbe(address, port) {
      if (!address) return false;
      const p = Number(port) || 8080;
      const httpUrl  = `http://${address}:${p}/health`;
      const httpsUrl = `https://${address}:${p}/health`;

      // Try same scheme first to avoid mixed-content blocks
      const candidates = [];
      if (location.protocol === 'https:') { candidates.push(httpsUrl, httpUrl); }
      else { candidates.push(httpUrl, httpsUrl); }

      for (const u of candidates) {
        try {
          // no-cors will resolve to "opaque" if reachable; that's good enough for green
          await fetchWithTimeout(u, { method: 'GET', mode: 'no-cors', cache: 'no-store' }, 2500);
          return true;
        } catch (_e) {
          // try next candidate
        }
      }
      return false;
    }

    async function backendProbe(nodeIdOrUuid) {
      try {
        // FIX: nodes.js has POST /api/nodes/:id/check
        const r = await fetch(`/api/nodes/${encodeURIComponent(nodeIdOrUuid)}/check`, { method: 'POST', cache: 'no-store' });
        if (!r.ok) return false;
        const j = await r.json().catch(()=> ({}));
        return !!j.ok; // nodes.js responds { ok:true, ... } when reachable
      } catch (e) {
        return false;
      }
    }

    function setNodeStatus(row, cls, label) {
      const dot = row.querySelector('.status-dot');
      if (!dot) return;
      dot.classList.remove('green','red','gray');
      dot.classList.add(cls);
      if (label) dot.title = label;
    }

    async function probeAndPaint(row, node) {
      // 1) probe din browser
      const okBrowser = await browserProbe(node.address, node.api_port);
      if (okBrowser) {
        setNodeStatus(row, 'green', 'Online (browser)');
        return;
      }
      // 2) fallback: verificare din backend (vei avea endpointul în nodes.js)
      const okBackend = await backendProbe(node.id || node.uuid || node.name);
      if (okBackend) setNodeStatus(row, 'green', 'Online (panel backend)');
      else setNodeStatus(row, 'red', 'Offline / unreachable');
    }

    function showCreateNodeModal(show){
      if (show) { createNodeOverlay.classList.add('show'); createNodeModal.classList.add('show'); }
      else { createNodeOverlay.classList.remove('show'); createNodeModal.classList.remove('show'); createNodeFeedback.textContent=''; }
    }

    openCreateNodeBtn.addEventListener('click', ()=> showCreateNodeModal(true));
    createNodeClose.addEventListener('click', ()=> showCreateNodeModal(false));
    createNodeCancel.addEventListener('click', ()=> showCreateNodeModal(false));
    createNodeOverlay.addEventListener('click', (e)=>{ if(e.target === createNodeOverlay) showCreateNodeModal(false); });

    // Toggle ports mode in create
    document.querySelectorAll('input[name="cn_ports_mode"]').forEach(r=>{
      r.addEventListener('change', ()=>{
        const mode = document.querySelector('input[name="cn_ports_mode"]:checked').value;
        cn_ports_range.style.display = (mode==='range') ? 'flex' : 'none';
        cn_ports_list.style.display = (mode==='list') ? 'block' : 'none';
      });
    });

    // Toggle ports mode in edit
    function bindEditPortsRadios(){
      nodeModal.querySelectorAll('input[name="nm_ports_mode"]').forEach(r=>{
        r.addEventListener('change', ()=>{
          const mode = nodeModal.querySelector('input[name="nm_ports_mode"]:checked').value;
          nm_ports_range.style.display = (mode==='range') ? 'flex' : 'none';
          nm_ports_list.style.display = (mode==='list') ? 'block' : 'none';
        });
      });
    }

    function parsePortsInput(mode, startEl, countEl, listEl){
      if(mode==='range'){
        const start = parseInt(startEl.value,10);
        const count = parseInt(countEl.value,10);
        if(!Number.isFinite(start) || start<1 || start>65535) throw new Error('Invalid start port');
        if(!Number.isFinite(count) || count<1 || count>1000) throw new Error('Invalid count');
        if(start+count-1 > 65535) throw new Error('Port range exceeds 65535');
        return { mode:'range', start, count };
      } else {
        const raw = (listEl.value||'').trim();
        if(!raw) throw new Error('Provide at least one port');
        const parts = raw.split(',').map(s=>parseInt(s.trim(),10)).filter(n=>Number.isFinite(n));
        const uniq = Array.from(new Set(parts));
        if(uniq.length===0) throw new Error('No valid ports');
        if(uniq.length>1000) throw new Error('Too many ports (max 1000)');
        if(uniq.some(p=>p<1 || p>65535)) throw new Error('Ports must be 1..65535');
        return { mode:'list', ports: uniq };
      }
    }

    function countPorts(alloc){
      if(!alloc) return 0;
      if(alloc.mode==='range') return Math.max(0, parseInt(alloc.count||0,10));
      if(alloc.mode==='list' && Array.isArray(alloc.ports)) return alloc.ports.length;
      return 0;
    }

    function portsSummary(alloc){
      if(!alloc) return '—';
      if(alloc.mode==='range') return `range ${alloc.start}..${alloc.start + alloc.count - 1} (${alloc.count})`;
      if(alloc.mode==='list') return `${alloc.ports.length} ports`;
      return '—';
    }

    async function loadNodes(){
      nodesListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">Loading…</div>`;
      try {
        const res = await fetch('/api/nodes');
        if(!res.ok){
          nodesListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">Failed to load nodes</div>`;
          return;
        }
        const data = await res.json().catch(()=>({nodes:[]}));
        renderNodes(Array.isArray(data.nodes)?data.nodes:[]);
      } catch (e){
        console.error(e);
        nodesListEl.innerHTML = `<div style="padding:12px;color:var(--muted)">Network error</div>`;
      }
    }

    let _nodesTimer;
    document.querySelector('button[data-panel="nodes"]').addEventListener('click', () => {
      clearInterval(_nodesTimer);
      loadNodes();
      _nodesTimer = setInterval(loadNodes, 5000); // refresh la 5s
    });

    function renderNodes(nodes){
      if(!nodes || nodes.length===0){
        nodesListEl.innerHTML = `
          <div class="nodes-empty">
            <div><i class="fa-solid fa-circle-info"></i> You haven't created any node yet.</div>
            <button class="btn" onclick="document.getElementById('openCreateNode').click()"><i class="fa-solid fa-circle-plus"></i> Create node</button>
          </div>
        `;
        return;
      }
      nodesListEl.innerHTML = '';
      const now = Date.now();
      nodes.forEach(n=>{
        const row = document.createElement('div');
        row.className = 'node-row';
        row.dataset.id = n.id || n.uuid || '';

        // STATUS (initial — bazat pe heartbeat-ul din backend)
        const lastSeen = Number(n.last_seen || n.lastSeen || n.lastHeartbeat || 0);
        const fresh = lastSeen > 0 && (now - lastSeen) < 120000; // 120s TTL
        let statusClass = 'gray';
        let statusLabel = 'No recent heartbeat';
        if (n.online === false) {
          statusClass = 'red';
          statusLabel = 'Offline';
        }
        if (fresh || n.online === true) {
          if (n.port_ok === false) {
            statusClass = 'red';
            statusLabel = 'Heartbeat ok, port unreachable';
          } else if (n.port_ok === true) {
            statusClass = 'green';
            statusLabel = 'Online';
          } else {
            // unknown => lăsăm gray până la probe din browser
            statusClass = 'gray';
            statusLabel = 'Checking…';
          }
        }

        const portCount = countPorts(n.ports);
        row.innerHTML = `
          <div class="node-left">
            <span class="status-dot ${statusClass}" title="${statusLabel}"></span>
            <div class="iconWrap"><i class="fa-solid fa-diagram-project"></i></div>
            <div>
              <div style="font-weight:700">${escapeHtml(n.name || 'unnamed')}</div>
              <div class="kpi">${escapeHtml(n.address || '0.0.0.0')} • API ${Number(n.api_port||8080)} • RAM ${Number(n.ram_mb||0)/1024|0} GB • Disk ${Number(n.disk_gb||0)} GB • Ports ${portCount}</div>
            </div>
          </div>
          <div class="row-actions">
            <span class="inline-badge">ID: ${escapeHtml((n.id||n.uuid||'').toString())}</span>
            <button class="btn ghost open-node"><i class="fa-solid fa-pen-to-square"></i> Configure</button>
          </div>
        `;
        row.querySelector('.open-node').addEventListener('click', (ev)=>{ ev.stopPropagation(); openNodeModal(n.id || n.uuid); });
        row.addEventListener('click', ()=> openNodeModal(n.id || n.uuid));
        nodesListEl.appendChild(row);

        // PROBE live din browser + fallback backend -> actualizează punctul la verde/roșu
        probeAndPaint(row, n);
      });
    }

    // Create node submit
    createNodeSave.addEventListener('click', async ()=>{
      try {
        createNodeFeedback.textContent = '';
        const name = cn_name.value.trim();
        const address = cn_address.value.trim();
        const ram_gb = parseInt(cn_ram_gb.value,10);
        const disk_gb = parseInt(cn_disk_gb.value,10);
        const mode = document.querySelector('input[name="cn_ports_mode"]:checked').value;
        if(!name) throw new Error('Name required');
        if(!address) throw new Error('Address required');
        if(!Number.isFinite(ram_gb) || ram_gb<1) throw new Error('Invalid RAM');
        if(!Number.isFinite(disk_gb) || disk_gb<10) throw new Error('Invalid Disk');

        const ports = parsePortsInput(mode, cn_port_start, cn_port_count, cn_port_list);
        const payload = {
          name, address,
          ram_mb: ram_gb * 1024,
          disk_gb,
          ports
        };

        createNodeSave.disabled = true;
        createNodeSave.innerHTML = 'Creating…';
        const res = await fetch('/api/nodes', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const data = await res.json().catch(()=>({error:'Invalid response'}));
        if(!res.ok){
          createNodeFeedback.textContent = data.error || 'Failed to create node';
          createNodeSave.disabled = false; createNodeSave.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Create';
          return;
        }
        showCreateNodeModal(false);
        await loadNodes();
        if(data.id || data.uuid){
          openNodeModal(data.id || data.uuid, /*focusLinking*/ true);
        }
      } catch (err){
        console.error(err);
        createNodeFeedback.textContent = err.message || 'Error';
      } finally {
        createNodeSave.disabled = false;
        createNodeSave.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Create';
      }
    });

    // Node modal open/fill
    function showNodeModal(show){
      if (show) { nodeModalOverlay.classList.add('show'); nodeModal.classList.add('show'); }
      else { nodeModalOverlay.classList.remove('show'); nodeModal.classList.remove('show'); }
    }
    nodeModalClose.addEventListener('click', ()=> showNodeModal(false));
    nodeModalOverlay.addEventListener('click', (e)=>{ if(e.target === nodeModalOverlay) showNodeModal(false); });

    nm_tabs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        nm_tabs.forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        const tab = btn.dataset.tab;
        [tab_build, tab_linking, tab_deletion].forEach(p=>p.classList.remove('active'));
        if(tab==='build') tab_build.classList.add('active');
        if(tab==='linking') tab_linking.classList.add('active');
        if(tab==='deletion') tab_deletion.classList.add('active');
      });
    });

    let CURRENT_NODE = null;

    async function openNodeModal(id, focusLinking=false){
      try{
        const res = await fetch(`/api/nodes/${encodeURIComponent(id)}`);
        const node = await res.json();
        if(!res.ok) throw new Error(node.error || 'Failed to load node');
        CURRENT_NODE = node;
        fillNodeModal(node, focusLinking);
        showNodeModal(true);
      }catch(e){
        alert(e.message || 'Failed to open node');
      }
    }

    function setRadio(name, value){
      const el = nodeModal.querySelector(`input[name="${name}"][value="${value}"]`);
      if(el){ el.checked = true; el.dispatchEvent(new Event('change')); }
    }

    function fillNodeModal(node, focusLinking=false){
      nm_title.innerHTML = `<i class="fa-solid fa-diagram-project"></i> ${escapeHtml(node.name || 'Node')}`;
      nm_subtitle.textContent = `${escapeHtml(node.address||'0.0.0.0')} • API ${Number(node.api_port||8080)} • RAM ${(Number(node.ram_mb||0)/1024|0)} GB • Disk ${Number(node.disk_gb||0)} GB • Ports ${countPorts(node.ports||{})}`;

      nm_name.value = node.name || '';
      nm_address.value = node.address || '';
      nm_ram_gb.value = (Number(node.ram_mb||0)/1024|0);
      nm_disk_gb.value = Number(node.disk_gb||0);

      const alloc = node.ports || {mode:'range', start:25565, count:10};
      if(alloc.mode==='list'){
        setRadio('nm_ports_mode','list');
        nm_ports_range.style.display = 'none';
        nm_ports_list.style.display = 'block';
        nm_port_list.value = Array.isArray(alloc.ports) ? alloc.ports.join(',') : '';
      } else {
        setRadio('nm_ports_mode','range');
        nm_ports_range.style.display = 'flex';
        nm_ports_list.style.display = 'none';
        nm_port_start.value = alloc.start || '';
        nm_port_count.value = alloc.count || '';
      }
      bindEditPortsRadios();

      // Linking content
      nm_configYml.value = generateNodeConfigYml(node);
      nm_cmd.value = '';
      nm_cmd.style.display = 'none';
      nm_cmdActions.style.display = 'none';

      // Default tab
      nm_tabs.forEach(b=>b.classList.remove('active'));
      [tab_build, tab_linking, tab_deletion].forEach(p=>p.classList.remove('active'));
      if(focusLinking){
        nodeModal.querySelector('button[data-tab="linking"]').classList.add('active');
        tab_linking.classList.add('active');
      } else {
        nodeModal.querySelector('button[data-tab="build"]').classList.add('active');
        tab_build.classList.add('active');
      }
    }

    function generateNodeConfigYml(node){
      const panelUrl = location.origin;
      const uuid = node.uuid || node.id || '';
      const token_id = node.token_id || '';
      const token = node.token || '';
      const yml = [
        `debug: false`,
        `uuid: ${uuid}`,
        `token_id: ${token_id}`,
        `token: ${token}`,
        `api:`,
        `  host: 0.0.0.0`,
        `  port: ${node.api_port || 8080}`,
        `  ssl:`,
        `    enabled: false`,
        `    cert: ""`,
        `    key: ""`,
        `  upload_limit: 1024`,
        `system:`,
        `  data: /var/lib/node/volumes`,
        `  sftp:`,
        `    bind_port: 2022`,
        `allowed_mounts: []`,
        `panel:`,
        `  url: ${panelUrl}`,
        `  node_id: ${node.id || node.uuid || ''}`
      ].join('\n');
      return yml;
    }

    function generateOneTimeCommand(node){
      const panelUrl = location.origin;
      const token = node.token || '';
      const nodeId = node.id || node.uuid || '';
      return `cd /etc/adpanel && sudo adnode configure --panel-url ${panelUrl} --token ${token} --node ${nodeId}`;
    }

    nm_copyConfig.addEventListener('click', ()=>{
      navigator.clipboard.writeText(nm_configYml.value||'').then(()=>{ nm_copyConfig.textContent='Copied'; setTimeout(()=> nm_copyConfig.innerHTML='<i class="fa-solid fa-copy"></i> Copy', 1000); });
    });

    nm_downloadConfig.addEventListener('click', ()=>{
      const blob = new Blob([nm_configYml.value||''], {type:'text/yaml'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'config.yml'; a.click();
      URL.revokeObjectURL(url);
    });

    nm_showCmd.addEventListener('click', ()=>{
      if(!CURRENT_NODE) return;
      nm_cmd.value = generateOneTimeCommand(CURRENT_NODE);
      nm_cmd.style.display = 'block';
      nm_cmdActions.style.display = 'flex';
    });

    nm_copyCmd.addEventListener('click', ()=>{
      navigator.clipboard.writeText(nm_cmd.value||'').then(()=>{ nm_copyCmd.textContent='Copied'; setTimeout(()=> nm_copyCmd.innerHTML='<i class="fa-solid fa-copy"></i> Copy', 1000); });
    });

    nm_save.addEventListener('click', async ()=>{
      if(!CURRENT_NODE) return;
      try{
        nm_save.disabled = true; nm_save.innerHTML = 'Saving…'; nm_saveFeedback.textContent='';
        const name = nm_name.value.trim();
        const address = nm_address.value.trim();
        const ram_gb = parseInt(nm_ram_gb.value,10);
        const disk_gb = parseInt(nm_disk_gb.value,10);
        const mode = nodeModal.querySelector('input[name="nm_ports_mode"]:checked')?.value || 'range';
        if(!name) throw new Error('Name required');
        if(!address) throw new Error('Address required');
        if(!Number.isFinite(ram_gb) || ram_gb<1) throw new Error('Invalid RAM');
        if(!Number.isFinite(disk_gb) || disk_gb<10) throw new Error('Invalid Disk');
        const ports = parsePortsInput(mode, nm_port_start, nm_port_count, nm_port_list);

        const payload = { name, address, ram_mb: ram_gb*1024, disk_gb, ports };
        const res = await fetch(`/api/nodes/${encodeURIComponent(CURRENT_NODE.id || CURRENT_NODE.uuid)}`, {
          method:'PATCH', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok) throw new Error(data.error || 'Failed to save');

        CURRENT_NODE = Object.assign({}, CURRENT_NODE, payload);
        nm_configYml.value = generateNodeConfigYml(CURRENT_NODE);
        nm_saveFeedback.textContent = 'Saved';
        await loadNodes();
      }catch(e){
        nm_saveFeedback.textContent = e.message || 'Error';
      } finally {
        nm_save.disabled = false; nm_save.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save';
      }
    });

    nm_delete.addEventListener('click', async ()=>{
      if(!CURRENT_NODE) return;
      const ok = confirm(`Delete node "${CURRENT_NODE.name}"? This action is permanent.`);
      if(!ok) return;
      try{
        nm_delete.disabled = true;
        nm_deleteFeedback.textContent = '';
        const res = await fetch(`/api/nodes/${encodeURIComponent(CURRENT_NODE.id || CURRENT_NODE.uuid)}`, { method: 'DELETE' });
        const data = await res.json().catch(()=>({}));
        if(!res.ok) throw new Error(data.error || 'Failed to delete');
        nm_deleteFeedback.textContent = 'Deleted';
        showNodeModal(false);
        await loadNodes();
      }catch(e){
        nm_deleteFeedback.textContent = e.message || 'Error';
      } finally {
        nm_delete.disabled = false;
      }
    });

    // ====== END NODES =======

  </script>
</body>
</html>
