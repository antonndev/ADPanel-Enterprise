<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>ADPanel - <%= bot %></title>

    <link rel="stylesheet" href="/style.css">
    <link id="favicon" rel="icon" type="image/png" href="/images/adpanel-dark.png" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="/socket.io/socket.io.js"></script>

    <style>
      .entry-actions { position: relative; }
      .more-btn {
        background: transparent; border: none; color: #bfc8d4; cursor: pointer;
        font-size: 18px; padding: 6px; border-radius: 6px;
      }
      .more-btn:hover { background: rgba(255,255,255,0.02); color:#fff; }
      .more-menu {
        position: absolute; right: 0; top: 28px; background: #0f1114;
        border: 1px solid rgba(255,255,255,0.04); box-shadow: 0 8px 30px rgba(0,0,0,0.6);
        border-radius: 8px; overflow: hidden; z-index: 2000; min-width: 160px; display: none;
      }
      .more-menu.show { display: block; }
      .more-menu button {
        display: block; width: 100%; padding: 10px 12px; background: transparent; border: 0;
        color: #c8d1da; text-align: left; font-size: 14px; cursor: pointer;
      }
      .more-menu button:hover { background: rgba(255,255,255,0.02); color:#fff; }

      /* Progress & modals & scrollbars — neschimbate (doar scurtate) */
      .progress-wheel{width:18px;height:18px;border-radius:50%;background:#31343a;display:inline-block;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.06);box-shadow: inset 0 1px 0 rgba(0,0,0,0.3);margin-left:10px;vertical-align:middle;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease;}
      .progress-wheel:hover{transform:scale(1.08);box-shadow:0 4px 14px rgba(0,0,0,0.5);}
      .progress-wheel .fill{position:absolute;left:0;right:0;top:0;background:#ffffff;height:0%;border-radius:50%;transition:height 120ms linear;pointer-events:none;}
      .progress-wheel.hidden{display:none;}
      .progress-popup{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:linear-gradient(135deg,rgba(18,20,24,0.92),rgba(28,30,36,0.88));color:#fff;border-radius:12px;border:1px solid rgba(255,255,255,0.06);padding:16px 18px;z-index:100000;min-width:300px;box-shadow:0 12px 40px rgba(0,0,0,0.6);display:none;backdrop-filter:blur(6px) saturate(120%);}
      .progress-popup .row{display:flex;align-items:center;justify-content:space-between;gap:12px;}
      .progress-popup .percent{font-weight:700;font-size:20px;color:#ffffff;}
      .progress-popup .close-btn{background:transparent;border:none;color:#9aa3ad;font-size:18px;cursor:pointer;padding:6px;border-radius:6px;}
      .progress-popup .progress-bar{margin-top:12px;width:100%;height:12px;background:rgba(255,255,255,0.06);border-radius:8px;overflow:hidden;position:relative;}
      .progress-popup .progress-bar .bar{height:100%;width:0%;background:linear-gradient(90deg,rgba(255,255,255,1),rgba(220,220,220,0.85));transition:width 120ms linear;box-shadow:0 2px 8px rgba(0,0,0,0.45) inset;}
      .progress-popup .meta{margin-top:10px;font-size:12px;color:#9aa3ad;display:flex;align-items:center;justify-content:space-between;gap:8px;}

      #dropOverlay{position:absolute;inset:0;display:none;align-items:center;justify-content:center;z-index:99990;pointer-events:none;}
      #dropOverlay.visible{display:flex;pointer-events:auto;}
      #dropOverlay .inner{background:rgba(255,255,255,0.02);border:1px dashed rgba(255,255,255,0.08);padding:26px 32px;border-radius:12px;text-align:center;color:#e6eef8;backdrop-filter:blur(3px);box-shadow:0 8px 30px rgba(0,0,0,0.5);}
      #dropOverlay .inner h3{margin:0 0 6px 0;font-size:18px;}
      #dropOverlay .inner p{margin:0;font-size:13px;color:#b8c3cf;}

      *::-webkit-scrollbar{width:10px;height:10px;} *::-webkit-scrollbar-track{background:transparent;margin:6px 0;border-radius:999px;}
      *::-webkit-scrollbar-thumb{background-color:#212121;border-radius:999px;border:2px solid transparent;background-clip:padding-box;box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02);}
      *::-webkit-scrollbar-thumb:hover{background-color:#2a2a2a;} *::-webkit-scrollbar-corner{background:transparent;}

      #console,#entries,.modal-body,.modal-left,.modal-right,.code-area,textarea,.modal{scrollbar-width:thin;scrollbar-color:#212121 transparent;}
      #console{max-height:320px;overflow:auto;padding:12px;border-radius:8px;background:#0b0c0e;}
      #entries{max-height:420px;overflow:auto;padding-right:8px;}
      .modal-body{max-height:520px;overflow:auto;}
      .modal-left,.modal-right{max-height:520px;overflow:auto;}
      .code-area{max-height:520px;overflow:auto;padding:8px;}
      textarea{max-height:520px;overflow:auto;}
      .entry{display:flex;justify-content:space-between;gap:12px;padding:8px 6px;align-items:center;border-radius:6px;}
      .entry:hover{background:rgba(255,255,255,0.02);}

      /* Dock mai lung / lat */
      .dock-wrap{
        position:fixed;
        right:18px;
        bottom:18px;
        z-index:99999;
        max-width:100%;
      }
      .dock{
        display:flex;
        gap:12px;
        background:rgba(11,12,14,0.78);
        padding:10px 18px;
        border-radius:16px;
        box-shadow:0 8px 26px rgba(0,0,0,0.65);
        align-items:center;
      }
      .dock-item{
        display:flex;
        flex-direction:column;
        align-items:center;
        gap:6px;
        padding:8px 10px;
        cursor:pointer;
        user-select:none;
        color:#d1d8de;
        text-decoration:none;
      }
      .dock-item .icon{
        width:36px;
        height:36px;
        display:flex;
        align-items:center;
        justify-content:center;
        border-radius:8px;
      }
      .dock-item .label{
        font-size:11px;
        color:#c3cad2;
        margin-top:4px;
      }
      .dock-item:hover{
        transform:translateY(-3px);
        transition:transform .12s;
      }

      .info-grid{display:grid;gap:10px;}
      .info-row{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;background:#0e1116;border:1px solid rgba(255,255,255,0.05);border-radius:10px;}
      .info-key{color:#9aa3ad;font-size:13px;}
      .info-val{color:#e6eef8;font-weight:700;font-size:14px;word-break:break-all;}
      .addr-wrap{display:flex;gap:8px;align-items:center;}
      .addr-input{flex:1;padding:10px 12px;border-radius:10px;background:#0b0f14;color:#e6eef8;border:1px solid rgba(255,255,255,0.06);outline:none;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
      .copy-btn{background:#10b981;color:#041015;border:0;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer;box-shadow:0 6px 18px rgba(16,185,129,.25);}
      .copy-btn:hover{filter:brightness(1.06);}
      .modal .hint{font-size:12px;color:#9aa3ad;}
      .disabled{opacity:.5;pointer-events:none;filter:saturate(.3);}
      .hidden{display:none !important;}

      /* === Store modal (Versions / Plugins) === */
      #storeModal .modal{
        width:90vw;
        max-width:1200px;
        height:90vh;
        max-height:90vh;
        display:flex;
        flex-direction:column;
      }
      .store-header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:16px;
        padding-bottom:8px;
        border-bottom:1px solid rgba(255,255,255,0.08);
      }
      .store-header-main{
        display:flex;
        align-items:flex-start;
        gap:10px;
      }
      .store-subtitle{
        color:#9aa3ad;
        font-size:13px;
        margin-top:4px;
      }
      .store-header-right{
        display:flex;
        align-items:center;
        gap:10px;
      }
      .store-tabs{
        display:flex;
        align-items:center;
        gap:8px;
      }
      .store-tab{
        border-radius:999px;
        border:0;
        background:rgba(255,255,255,0.04);
        color:#e5edf7;
        font-size:13px;
        padding:6px 14px;
        cursor:pointer;
        white-space:nowrap;
      }
      .store-tab:hover{
        background:rgba(255,255,255,0.08);
      }
      .store-tab.active{
        background:#10b981;
        color:#02110b;
        box-shadow:0 0 0 1px rgba(16,185,129,0.35);
      }
      .store-close{
        border-radius:999px;
      }
      .store-body{
        flex:1;
        display:flex;
        flex-direction:column;
        overflow:hidden;
      }
      #storeContent{
        flex:1;
        margin-top:8px;
        overflow:auto;
        padding-right:6px;
      }
      .store-content-grid{
        display:grid;
        grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
        gap:12px;
        align-content:flex-start;
      }
      .store-provider-card{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        padding:10px 12px;
        border-radius:12px;
        background:#0e1116;
        border:1px solid rgba(255,255,255,0.06);
        cursor:pointer;
        text-align:left;
        transition:transform .1s ease, box-shadow .1s ease, border-color .1s ease, background .1s ease;
      }
      .store-provider-card:hover{
        transform:translateY(-1px);
        background:#10141b;
        border-color:rgba(255,255,255,0.12);
        box-shadow:0 10px 30px rgba(0,0,0,0.55);
      }
      .store-provider-logo{
        width:40px;
        height:40px;
        border-radius:999px;
        background:rgba(255,255,255,0.03);
        display:flex;
        align-items:center;
        justify-content:center;
        overflow:hidden;
      }
      .store-provider-logo img{
        width:32px;
        height:32px;
        object-fit:contain;
      }
      .store-provider-logo-placeholder{
        font-weight:700;
        font-size:18px;
        color:#e5edf7;
      }
      .store-provider-body{
        flex:1;
        min-width:0;
      }
      .store-provider-name{
        font-size:14px;
        font-weight:700;
        color:#e6eef8;
      }
      .store-provider-desc{
        font-size:12px;
        color:#9aa3ad;
        margin-top:2px;
      }
      .store-provider-chevron{
        color:#6b7280;
        font-size:13px;
      }
      .store-provider-header{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:12px;
        margin-bottom:10px;
      }
      .store-back-btn{
        border-radius:999px;
        border:0;
        background:rgba(255,255,255,0.04);
        color:#e5edf7;
        font-size:12px;
        padding:6px 12px;
        cursor:pointer;
        display:flex;
        align-items:center;
        gap:6px;
      }
      .store-back-btn:hover{
        background:rgba(255,255,255,0.08);
      }
      .store-provider-header-main{
        display:flex;
        align-items:center;
        gap:10px;
        flex:1;
      }
      .store-provider-header-logo{
        width:32px;
        height:32px;
        object-fit:contain;
      }
      .store-provider-header-name{
        font-size:15px;
        font-weight:700;
        color:#e6eef8;
      }
      .store-provider-header-desc{
        font-size:12px;
        color:#9aa3ad;
      }
      .store-version-list{
        display:flex;
        flex-direction:column;
        gap:8px;
      }
      .store-version-row{
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        padding:8px 10px;
        border-radius:10px;
        background:#0b0f14;
        border:1px solid rgba(255,255,255,0.04);
        cursor:pointer;               /* <-- clickable */
        transition: transform .08s ease, background .08s ease, border-color .08s ease;
      }
      .store-version-row:hover{
        background:#0d131a;
        border-color:rgba(255,255,255,0.08);
        transform: translateY(-1px);
      }
      .store-version-meta{
        min-width:0;
      }
      .store-version-name{
        font-size:13px;
        font-weight:600;
        color:#e6eef8;
      }
      .store-version-sub{
        font-size:11px;
        color:#9aa3ad;
        margin-top:2px;
      }
      .store-version-tags{
        display:flex;
        flex-wrap:wrap;
        gap:6px;
        justify-content:flex-end;
      }
      .store-note{
        font-size:12px;
        color:#9aa3ad;
        margin-bottom:6px;
      }
      .store-placeholder,
      .store-empty,
      .store-loading,
      .store-error{
        font-size:13px;
        color:#9aa3ad;
      }
      .store-placeholder strong{color:#e6eef8;}
      .store-error{color:#fecaca;}
      .pill{
        display:inline-flex;
        align-items:center;
        border-radius:999px;
        padding:3px 8px;
        font-size:11px;
        font-weight:500;
      }
      .pill-green{
        background:rgba(16,185,129,0.16);
        color:#bbf7d0;
        border:1px solid rgba(16,185,129,0.4);
      }
      .pill-muted{
        background:rgba(148,163,184,0.16);
        color:#e5e7eb;
        border:1px solid rgba(148,163,184,0.45);
      }
    </style>

    <script>
      const darkFavicon="/images/adpanel-white.png", lightFavicon="/images/adpanel-dark.png";
      function updateIcons(){
        const isDark=window.matchMedia("(prefers-color-scheme: dark)").matches;
        document.querySelectorAll('link[rel="icon"], link[rel="apple-touch-icon"]').forEach(el=>el.remove());
        const linkF=document.createElement("link"); linkF.rel="icon"; linkF.type="image/png";
        linkF.href=isDark?darkFavicon:lightFavicon; document.head.appendChild(linkF);
      }
      updateIcons(); window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",updateIcons);
    </script>
  </head>

  <body>
    <div class="app-wrap">
      <div class="topbar">
        <div class="brands">
          <div class="logo" title="Settings"><a href="/"><img src="https://i.imgur.com/k5agjYf.png" alt="adpanel-logo" width="7%" height="7%"></a></div>
          <div class="logo" title="Setups"><a href="/" style="position:absolute;font-family:sans-serif;font-size:30px;font-weight:bold;margin-top:-35px;margin-left:60px;text-decoration:none;color:white;">Panel</a></div>
        </div>

        <div class="top-actions">
          <button class="icon-btn" id="filesBtn" onclick="openFilesModal()"><i class="fa-solid fa-folder-open"></i> Files</button>
          <button class="icon-btn" id="taskBtn" onclick="openTaskModal()"><i class="fa-solid fa-list-check"></i> Task</button>
          <button class="icon-btn" id="storeBtn" onclick="openStoreModal()"><i class="fa-solid fa-store"></i> Store</button>
          <button class="icon-btn" onclick="openInfoModal()"><i class="fa-solid fa-circle-info"></i> Informations</button>
          <button class="icon-btn" id="runBtn" onclick="run()" title="Run selected"><i class="fa-solid fa-play"></i> Run</button>
          <button class="icon-btn" id="stopBtn" onclick="stop()" title="Stop process"><i class="fa-solid fa-stop"></i> Stop</button>
        </div>
      </div>

      <div class="main-stage" style="margin-top:2px">
        <div class="console-panel" role="main" aria-label="Console panel">
          <div class="console-window">
            <div class="window-header">
              <div style="display:flex;align-items:center;gap:8px">
                <span class="dot" style="background:#ff5f56;cursor:pointer" onclick="stop()"></span>
                <span class="dot" style="background:#ffbd2e;cursor:pointer" onclick="stop()"></span>
                <span class="dot" style="background:#27c93f;cursor:pointer" onclick="run()"></span>
                <div style="margin-left:6px;color:var(--muted);font-size:13px">Console — <span style="color:#fff;font-weight:700"><%= bot %></span></div>
              </div>
              <div class="window-controls">
                <div style="color:var(--muted);font-size:13px">Status: <span id="statusLabel">idle</span></div>
              </div>
            </div>

            <div class="controls">
              <select id="scriptSelect" title="Choose startup file (.js, .jar, .html, orice)"></select>
              <button class="run-button" id="miniRunBtn" onclick="run()" title="Run"><i class="fa-solid fa-play" style="transform:rotate(90deg)"></i></button>
              <button class="stop-button" id="miniStopBtn" onclick="stop()" title="Stop"><i class="fa-solid fa-stop"></i></button>
              <div style="flex:1"></div>
            </div>

            <pre id="console" aria-live="polite"></pre>

            <div class="cmd-row" id="cmdRow">
              <input id="cmdInput" type="text" placeholder="Type a command and press Enter (will be sent to running process)" />
              <button class="icon-btn" id="sendBtn" onclick="sendCommand()" title="Send">Send</button>
              <button class="icon-btn" id="clearBtn" onclick="clearConsole()" title="Clear">Clear</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Informations Modal -->
    <div id="infoModal" class="modal-overlay" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="infoModalTitle">
        <div class="modal-header">
          <div>
            <div class="modal-title" id="infoModalTitle">Server Informations — <span style="color:#fff;font-weight:700"><%= bot %></span></div>
            <div style="color:var(--muted);font-size:13px">Quick connection details pulled from servers.json</div>
          </div>
          <div><button class="modal-close" id="infoModalClose" title="Close (Esc)"><i class="fa-solid fa-xmark"></i></button></div>
        </div>
        <div class="modal-body">
          <div class="info-grid">
            <div class="info-row"><div class="info-key">IP</div><div class="info-val" id="infoIp">—</div></div>
            <div class="info-row"><div class="info-key">Port</div><div class="info-val" id="infoPort">—</div></div>
            <div class="info-row" style="flex-direction:column;align-items:stretch;">
              <div class="info-key" style="margin-bottom:6px;">Connection Address</div>
              <div class="addr-wrap">
                <input id="infoAddress" class="addr-input" type="text" readonly value="" />
                <button id="copyAddressBtn" class="copy-btn"><i class="fa-solid fa-copy"></i>&nbsp;Copy</button>
              </div>
              <div class="hint" style="margin-top:6px;">This is the address you can share: IP and port combined.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Files Modal -->
    <div id="filesModal" class="modal-overlay" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="filesModalTitle" style="position:relative;">
        <div class="modal-header">
          <div style="display:flex;align-items:center;gap:8px">
            <div>
              <div class="modal-title" id="filesModalTitle">File Manager — <span style="color:#fff;font-weight:700"><%= bot %></span></div>
              <div style="color:var(--muted);font-size:13px">Explore and manage files</div>
            </div>
            <div id="progressWheel" class="progress-wheel hidden" title="Operation in progress">
              <div class="fill" id="progressFill" style="height:0%"></div>
            </div>
          </div>
          <div><button class="modal-close" id="filesModalClose" title="Close (Esc)"><i class="fa-solid fa-xmark"></i></button></div>
        </div>

        <div id="dropOverlay" aria-hidden="true">
          <div class="inner">
            <h3 id="dropTitle">Drop files here to upload</h3>
            <p id="dropSubtitle">Release to upload to current folder</p>
            <div class="hint">Accepted: files & common archives (zip, tar.gz, rar, 7z)</div>
          </div>
        </div>

        <div class="modal-body">
          <div class="modal-left">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div id="breadcrumbs" style="color:var(--muted);font-size:13px"></div>
              <div style="display:flex;gap:8px;align-items:center">
                <label class="icon-btn" id="uploadLabel" for="fileUploadModal" style="cursor:pointer"><i class="fa-solid fa-upload"></i> Upload</label>
                <input id="fileUploadModal" type="file" />
                <button class="icon-btn" id="newBtn" onclick="createNew()" title="New file/folder"><i class="fa-solid fa-file-circle-plus"></i> New</button>
              </div>
            </div>
            <ul id="entries" role="list"></ul>
          </div>

          <div class="modal-right">
            <div style="color:var(--muted);font-size:13px;margin-bottom:8px">Here you can edit your application.</div>
            <div style="color:var(--muted);font-size:12px">We have actions for all these kinds of things.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="modal-overlay task-modal" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="taskModalTitle">
        <div class="modal-header">
          <div>
            <div class="modal-title" id="taskModalTitle">Task Manager — Startup</div>
            <div style="color:var(--muted);font-size:13px">Choose a startup file to use when you press Run</div>
          </div>
          <div><button class="modal-close" id="taskModalClose" title="Close (Esc)"><i class="fa-solid fa-xmark"></i></button></div>
        </div>

        <div style="padding:6px 0 12px 0">
          <div style="display:flex;gap:8px;align-items:center">
            <select id="taskStartupSelect" style="flex:1;padding:10px;border-radius:8px;background:#0e1116;border:1px solid rgba(255,255,255,0.02);color:#fff"></select>
            <button class="icon-btn" id="saveStartupBtn">Save</button>
          </div>
          <div style="color:var(--muted);font-size:13px;margin-top:8px">Saved startup choice is persisted in browser (localStorage).</div>
        </div>
      </div>
    </div>

    <!-- Editor Modal -->
    <div id="editorModal" class="modal-overlay editor-modal" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="editorModalTitle">
        <div class="editor-header">
          <div>
            <div class="editor-title" id="editorModalTitle">Editor</div>
            <div style="color:var(--muted);font-size:13px" id="editorPath"></div>
          </div>
          <div class="editor-actions">
            <button class="modal-close" id="editorModalClose" title="Close (Esc)"><i class="fa-solid fa-xmark"></i></button>
          </div>
        </div>

        <div id="bigEditor">
          <div id="codeArea" class="code-area" contenteditable="true" spellcheck="false" style="display:none"></div>
          <textarea id="textArea" style="display:none"></textarea>

          <div style="display:flex;gap:8px;justify-content:flex-end">
            <button class="icon-btn" id="editorDiscard">Discard</button>
            <button class="icon-btn" id="editorSave">Save</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Store Modal -->
    <div id="storeModal" class="modal-overlay" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="storeModalTitle">
        <div class="store-header">
          <div class="store-header-main">
            <div>
              <div class="modal-title" id="storeModalTitle">
                Store — <span style="color:#fff;font-weight:700"><%= bot %></span>
              </div>
              <div class="store-subtitle" id="storeSubtitle">Choose your core distribution and manage plugins.</div>
            </div>
          </div>
          <div class="store-header-right">
            <div class="store-tabs" id="storeTabs">
              <button class="store-tab active" id="storeTabVersions">Versions</button>
              <button class="store-tab" id="storeTabPlugins">Plugins</button>
            </div>
            <button class="modal-close store-close" id="storeModalClose" title="Close (Esc)">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
        </div>
        <div class="store-body">
          <div id="storeContent"></div>
        </div>
      </div>
    </div>

    <!-- Dock -->
    <div class="dock-wrap" role="navigation" aria-label="taskbar">
      <div class="dock">
        <div class="dock-item" onclick="window.location='/'" title="Dashboard">
          <div class="icon"><i class="fa-solid fa-house" style="color:white;"></i></div>
          <div class="label">Home</div>
        </div>

        <div class="sep" aria-hidden="true"></div>

        <div class="dock-item" id="dockFiles" onclick="openFilesModal()" title="Files">
          <div class="icon"><i class="fa-solid fa-folder-open" style="color:#60a5fa;"></i></div>
          <div class="label">Files</div>
        </div>
        <div class="dock-item" id="dockTask" onclick="openTaskModal()" title="Task Manager">
          <div class="icon"><i class="fa-solid fa-list-check" ></i></div>
          <div class="label">Task</div>
        </div>
        <div class="dock-item" id="dockInfo" onclick="openInfoModal()" title="Informations">
          <div class="icon"><i class="fa-solid fa-circle-info"></i></div>
          <div class="label">Informations</div>
        </div>
        <div class="dock-item" id="dockStore" onclick="openStoreModal()" title="Store">
          <div class="icon"><i class="fa-solid fa-store"></i></div>
          <div class="label">Store</div>
        </div>
        <div class="dock-item" id="dockRun" onclick="run()" title="Run">
          <div class="icon"><i class="fa-solid fa-play" style="color:#10b981;"></i></div>
          <div class="label">Run</div>
        </div>
        <div class="dock-item" id="dockStop" onclick="stop()" title="Stop">
          <div class="icon"><i class="fa-solid fa-stop" style="color:#f97316;"></i></div>
          <div class="label">Stop</div>
        </div>
        <div class="dock-item" id="dockNew" onclick="createNew()" title="Create new">
          <div class="icon"><i class="fa-solid fa-file-circle-plus" style="color:#38bdf8;"></i></div>
          <div class="label">New</div>
        </div>
      </div>
    </div>

    <div id="progressPopup" class="progress-popup" role="dialog" aria-hidden="true">
      <div class="row">
        <div>
          <div class="title">Current Operation</div>
          <div class="percent" id="popupPercent">0%</div>
        </div>
        <div><button id="popupClose" class="close-btn" title="Close">✕</button></div>
      </div>
      <div class="progress-bar" aria-hidden="true"><div class="bar" id="popupBar" style="width:0%"></div></div>
      <div class="meta"><div id="popupMsg">Processing...</div><div id="popupTime" style="font-size:12px;color:#88929b">—</div></div>
    </div>

    <script>
      const bot = "<%= bot %>";
      const socket = io();

      // ====== NEW: Topology / Node-aware API ======
      let REMOTE_MODE = false;
      let NODE_ID = null;
      let NODE_API_BASE = `/api/nodes/server/${encodeURIComponent(bot)}`;

      // [SSE] — sursa de log dacă e remote
      let logSource = null;
      function attachLogStreamIfRemote(){
        if (!REMOTE_MODE) return;
        try { if (logSource) { logSource.close(); logSource = null; } } catch {}
        const url = `${NODE_API_BASE}/logs`;
        const es = new EventSource(url);
        logSource = es;

        es.addEventListener('hello', (e) => {});
        es.addEventListener('keepalive', () => {});
        es.onmessage = (ev) => {
          try {
            const j = JSON.parse(ev.data);
            if (j && typeof j.line === 'string') {
              consoleEl.textContent += j.line;
              consoleEl.scrollTop = consoleEl.scrollHeight;
            }
          } catch {
            consoleEl.textContent += (ev.data || "") + "\n";
            consoleEl.scrollTop = consoleEl.scrollHeight;
          }
        };
        es.onerror = () => {};
      }
      window.addEventListener('beforeunload', () => { try { if (logSource) logSource.close(); } catch {} });

      // Wrapper-e care aleg automat local vs remote
      async function topoInfo(){
        try{
          const r = await fetch(`${NODE_API_BASE}/info`);
          if(!r.ok) throw new Error('nodes info not ok');
          const j = await r.json();
          REMOTE_MODE = !!j.remote; NODE_ID = j.nodeId || null;
          return j;
        }catch(e){
          REMOTE_MODE = false; NODE_ID = null;
          return null;
        }
      }
      async function apiExplore(path=""){
        const url = REMOTE_MODE
          ? `${NODE_API_BASE}/entries?path=${encodeURIComponent(path)}`
          : `/explore/${encodeURIComponent(bot)}?path=${encodeURIComponent(path)}`;
        const r = await fetch(url);
        if(!r.ok) throw new Error('explore failed');
        return await r.json();
      }
      async function apiReadFile(relPath){
        if(!REMOTE_MODE){
          socket.emit("readFile", { bot, path: relPath });
          return null;
        }
        const r = await fetch(`${NODE_API_BASE}/file?path=${encodeURIComponent(relPath)}`);
        if(!r.ok) throw new Error('read file failed');
        const j = await r.json();
        return j && typeof j.content === 'string' ? j.content : '';
      }
      async function apiWriteFile(relPath, content){
        if(!REMOTE_MODE){
          socket.emit("writeFile", { bot, path: relPath, content });
          return true;
        }
        const r = await fetch(`${NODE_API_BASE}/file`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ path: relPath, content })
        });
        if(!r.ok) throw new Error('write file failed');
        return true;
      }
      async function apiDelete(relPath, isDir){
        if(!REMOTE_MODE){
          socket.emit("deleteFile", { bot, path: relPath, isDir });
          return true;
        }
        const r = await fetch(`${NODE_API_BASE}/delete`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ path: relPath, isDir: !!isDir })
        });
        if(!r.ok) throw new Error('delete failed');
        return true;
      }
      async function apiRename(oldPath, newName){
        const url = REMOTE_MODE ? `${NODE_API_BASE}/rename` : '/rename';
        const payload = REMOTE_MODE
          ? { path: oldPath, newName }
          : { bot, oldPath, newName };
        const r = await fetch(url, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!r.ok) throw new Error(await r.text().catch(()=>r.statusText));
        return true;
      }
      async function apiExtract(relPath){
        const url = REMOTE_MODE ? `${NODE_API_BASE}/extract` : '/extract';
        const payload = REMOTE_MODE ? { path: relPath } : { bot, path: relPath };
        const r = await fetch(url, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const j = await r.json().catch(()=>({}));
        if(!r.ok || !j.ok) throw new Error((j && j.error) ? j.error : 'extract failed');
        return j;
      }
      function apiUploadWithProgress(file, currentPath, onProgress, baseMsg){
        return new Promise((resolve, reject)=>{
          const fd = new FormData();
          fd.append('file', file);
          if(!REMOTE_MODE){ fd.append('bot', bot); }
          fd.append('path', currentPath || '');

          const xhr = new XMLHttpRequest();
          xhr.open('POST', REMOTE_MODE ? `${NODE_API_BASE}/upload` : '/upload');
          xhr.upload.onprogress=(e)=>{ if(e.lengthComputable){ const pct=Math.round((e.loaded/e.total)*100); onProgress(pct, `${baseMsg} (${pct}%)`); } else onProgress(6, `${baseMsg}...`); };
          xhr.onload=()=>{ if(xhr.status>=200 && xhr.status<300){ try{ const j=JSON.parse(xhr.responseText||"{}"); onProgress(100, j && j.msg ? j.msg : "Finalizing..."); }catch{} resolve(); } else reject(new Error(xhr.responseText||xhr.statusText||('status '+xhr.status))); };
          xhr.onerror=()=>reject(new Error('Network error'));
          xhr.send(fd);
        });
      }
      async function apiCreate(type, name, currentPath){
        const url = REMOTE_MODE ? `${NODE_API_BASE}/create` : '/create';
        const payload = REMOTE_MODE
          ? { type, name, path: currentPath || '' }
          : { bot, type, name, path: currentPath || '' };
        const r = await fetch(url, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        if(!r.ok) throw new Error(await r.text().catch(()=>r.statusText));
        return true;
      }
      async function apiAction(data){
        if(!REMOTE_MODE){ socket.emit('action', data); return true; }
        const r = await fetch(`${NODE_API_BASE}/action`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(data)
        });
        if(!r.ok) throw new Error(await r.text().catch(()=>r.statusText));
        return true;
      }
      async function apiCommand(command){
        if(!REMOTE_MODE){ socket.emit('command', { bot, command }); return true; }
        const r = await fetch(`${NODE_API_BASE}/command`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ command })
        });
        if(!r.ok) throw new Error(await r.text().catch(()=>r.statusText));
        return true;
      }

      // ——— Global perms
      let IS_ADMIN = false;
      let PERMS = {
        files_read:false, files_delete:false, files_rename:false, console_write:false,
        server_stop:false, server_start:false, files_upload:false, files_create:false
      };
      function hasPerm(k){ return IS_ADMIN || !!PERMS[k]; }

      // ——— DOM refs
      const consoleEl = document.getElementById("console");
      const scriptSelect = document.getElementById("scriptSelect");
      const cmdRow = document.getElementById("cmdRow");
      const cmdInput = document.getElementById("cmdInput");
      const entriesEl = document.getElementById("entries");
      const breadcrumbs = document.getElementById("breadcrumbs");
      const filesModal = document.getElementById("filesModal");
      const filesModalClose = document.getElementById("filesModalClose");
      const fileUploadModal = document.getElementById("fileUploadModal");
      const uploadLabel = document.getElementById("uploadLabel");
      const newBtn = document.getElementById("newBtn");

      const taskModal = document.getElementById("taskModal");
      const taskModalClose = document.getElementById("taskModalClose");
      const taskStartupSelect = document.getElementById("taskStartupSelect");
      const saveStartupBtn = document.getElementById("saveStartupBtn");

      const statusLabel = document.getElementById("statusLabel");
      const editorModal = document.getElementById("editorModal");
      const editorModalClose = document.getElementById("editorModalClose");
      const editorPath = document.getElementById("editorPath");
      const codeArea = document.getElementById("codeArea");
      const textArea = document.getElementById("textArea");
      const editorSave = document.getElementById("editorSave");
      const editorDiscard = document.getElementById("editorDiscard");

      const progressWheel = document.getElementById("progressWheel");
      const progressFill = document.getElementById("progressFill");
      const progressPopup = document.getElementById("progressPopup");
      const popupPercent = document.getElementById("popupPercent");
      const popupBar = document.getElementById("popupBar");
      const popupMsg = document.getElementById("popupMsg");
      const popupTime = document.getElementById("popupTime");
      const popupClose = document.getElementById("popupClose");
      const dropOverlay = document.getElementById("dropOverlay");
      const dropTitle = document.getElementById("dropTitle");
      const dropSubtitle = document.getElementById("dropSubtitle");

      const infoModal = document.getElementById("infoModal");
      const infoModalClose = document.getElementById("infoModalClose");
      const infoIp = document.getElementById("infoIp");
      const infoPort = document.getElementById("infoPort");
      const infoAddress = document.getElementById("infoAddress");
      const copyAddressBtn = document.getElementById("copyAddressBtn");

      const filesBtn = document.getElementById("filesBtn");
      const taskBtn = document.getElementById("taskBtn");
      const runBtn = document.getElementById("runBtn");
      const stopBtn = document.getElementById("stopBtn");
      const miniRunBtn = document.getElementById("miniRunBtn");
      const miniStopBtn = document.getElementById("miniStopBtn");
      const storeBtn = document.getElementById("storeBtn");

      const storeModal = document.getElementById("storeModal");
      const storeModalClose = document.getElementById("storeModalClose");
      const storeContent = document.getElementById("storeContent");
      const storeTabs = document.getElementById("storeTabs");
      const storeTabVersions = document.getElementById("storeTabVersions");
      const storeTabPlugins = document.getElementById("storeTabPlugins");
      const storeSubtitle = document.getElementById("storeSubtitle");

      const dockFiles = document.getElementById("dockFiles");
      const dockTask = document.getElementById("dockTask");
      const dockRun = document.getElementById("dockRun");
      const dockStop = document.getElementById("dockStop");
      const dockNew = document.getElementById("dockNew");
      const dockStore = document.getElementById("dockStore");

      // ——— server-info cache
      let serverInfo = null;
      let SERVER_NODE_ID = null;

      // Store UI state
      let currentStoreTab = 'versions';
      let storeProvidersCache = null;
      let storeCurrentProvider = null;

      // ===== Perms fetch + UI application =====
      async function fetchPerms(){
        try{
          const r = await fetch(`/api/servers/${encodeURIComponent(bot)}/permissions`);
          if(!r.ok) throw new Error('perm fetch failed');
          const j = await r.json();
          IS_ADMIN = !!j.isAdmin;
          if (j && j.perms && typeof j.perms === 'object') PERMS = Object.assign(PERMS, j.perms);
} catch(e){
  // PUBLIC PANEL fallback: allow-all
  IS_ADMIN = true;
  PERMS = {
    files_read:true, files_delete:true, files_rename:true, console_write:true,
    server_stop:true, server_start:true, files_upload:true, files_create:true
  };
}
      }

      function applyPermissionsToUI(){
        if(!hasPerm('console_write')){ cmdRow.classList.add('hidden'); }
        if(!hasPerm('server_start')){ runBtn.classList.add('disabled'); miniRunBtn.classList.add('disabled'); dockRun.classList.add('disabled'); }
        if(!hasPerm('server_stop')){ stopBtn.classList.add('disabled'); miniStopBtn.classList.add('disabled'); dockStop.classList.add('disabled'); }
        if(!hasPerm('files_read')){ filesBtn.classList.add('disabled'); dockFiles.classList.add('disabled'); }
        if(!hasPerm('files_upload')){ uploadLabel.classList.add('hidden'); fileUploadModal.classList.add('hidden'); }
        if(!hasPerm('files_create')){ newBtn.classList.add('hidden'); dockNew.classList.add('disabled'); editorSave.classList.add('disabled'); }
        if(!hasPerm('server_start')){ taskBtn.classList.add('disabled'); dockTask.classList.add('disabled'); }
      }

      // ===== Socket & output (local mode)
      socket.emit("join", bot);
      socket.on("output", (data) => { consoleEl.textContent += data; consoleEl.scrollTop = consoleEl.scrollHeight; });
      socket.on("fileData", (d) => { openEditorModal(d.path, d.content); });

      // ===== Server info (via nodes.js dacă există)
      async function loadServerInfo() {
        const [topoRes, srvRes] = await Promise.allSettled([
          topoInfo().catch(() => null),
          fetch(`/api/server-info/${encodeURIComponent(bot)}`)
            .then(r => (r.ok ? r.json() : null))
            .catch(() => null)
        ]);

        const topo = topoRes.status === 'fulfilled' ? topoRes.value : null;
        const srv  = srvRes.status === 'fulfilled'  ? srvRes.value  : null;

        REMOTE_MODE = !!(topo && topo.remote);
        NODE_ID     = (topo && topo.nodeId) || (srv && srv.nodeId) || null;

        const topoInfoObj = (topo && topo.info) ? topo.info : {};
        serverInfo = Object.assign({}, topoInfoObj, srv || {});

        updateStoreVisibility();
      }

      function formatAddress(ip, port){
        if (!ip) return "";
        const is6 = ip.includes(":") && !ip.includes(".");
        const host = is6 ? `[${ip}]` : ip;
        return port ? `${host}:${port}` : host;
      }

      async function nodeAction(cmd, options = {}) {
        if (!SERVER_NODE_ID) throw new Error('no remote node');
        const r = await fetch(`/api/nodes/${encodeURIComponent(SERVER_NODE_ID)}/server/action`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(Object.assign({ name: bot, cmd }, options))
        });
        const j = await r.json().catch(()=> ({}));
        if (!r.ok || (j && j.error)) {
          const msg = (j && (j.detail || j.error)) || `HTTP ${r.status}`;
          throw new Error(msg);
        }
        return j;
      }

      async function nodeCommand(command) {
        if (!SERVER_NODE_ID) throw new Error('no remote node');
        const r = await fetch(`/api/nodes/${encodeURIComponent(SERVER_NODE_ID)}/server/command`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: bot, command })
        });
        const j = await r.json().catch(()=> ({}));
        if (!r.ok || (j && j.error)) {
          const msg = (j && (j.detail || j.error)) || `HTTP ${r.status}`;
          throw new Error(msg);
        }
        return j;
      }

      /* ===== Store visibility ===== */
      function normalizeTemplate(t){ return (t ?? '').toString().trim().toLowerCase(); }
      function updateStoreVisibility(){
        const btn  = document.getElementById('storeBtn');
        const dock = document.getElementById('dockStore');
        const tabs = document.getElementById('storeTabs');
        if (!btn && !dock) return;
        const t = serverInfo ? normalizeTemplate(serverInfo.template) : null;
        const shouldShow = !t || t === 'minecraft'; // dacă nu știm încă, îl lăsăm vizibil
        [btn, dock].forEach(el => { if (el) el.classList.toggle('hidden', !shouldShow); });
        if (tabs) tabs.classList.toggle('hidden', !shouldShow);
      }

      function setActiveStoreTab(tab){
        currentStoreTab = tab;
        if (storeTabVersions) storeTabVersions.classList.toggle('active', tab === 'versions');
        if (storeTabPlugins) storeTabPlugins.classList.toggle('active', tab === 'plugins');
        if (storeSubtitle){
          if (tab === 'versions') storeSubtitle.textContent = 'Choose your core distribution and version.';
          else storeSubtitle.textContent = 'Plugin management is coming soon.';
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        updateStoreVisibility(); // la start (template necunoscut) -> vizibil
      });

      /* ===== Store: open modal + fetch providers ===== */
      async function openStoreModal() {
        if (!storeModal) return;

        // Deschide modalul imediat (optimist)
        storeModal.classList.add('show');
        storeModal.style.display = 'flex';
        storeModal.setAttribute('aria-hidden', 'false');
        setActiveStoreTab('versions');
        storeContent.innerHTML = `<div class="store-loading">Loading providers...</div>`;

        try {
          const r = await fetch(`/api/servers/${encodeURIComponent(bot)}/versions`);
          if (!r.ok) {
            const j = await r.json().catch(() => ({}));
            if (j && j.error === 'not-minecraft-template') {
              closeStoreModal();
              const t = serverInfo && serverInfo.template;
              alert(`Store is available only for Minecraft template servers (template: ${JSON.stringify(String(t||'').trim())}).`);
              return;
            }
            storeContent.innerHTML = `<div class="store-error">Failed to load providers (${r.status})</div>`;
            return;
          }

          const data = await r.json();
          // Render providers
          await renderStoreProvidersView(Array.isArray(data.providers) ? data.providers : []);
        } catch (e) {
          storeContent.innerHTML = `<div class="store-error">Failed to load providers</div>`;
        }
      }

      function closeStoreModal(){
        if (!storeModal) return;
        storeModal.classList.remove('show');
        storeModal.style.display='none';
        storeModal.setAttribute('aria-hidden','true');
        storeCurrentProvider = null;
      }

      async function fetchStoreProviders(){
        const res = await fetch(`/api/servers/${encodeURIComponent(bot)}/versions`);
        if (!res.ok) throw new Error('Failed to load providers');
        const j = await res.json();
        storeProvidersCache = j.providers || [];
        return j;
      }

      async function fetchStoreVersions(providerId){
        const res = await fetch(`/api/servers/${encodeURIComponent(bot)}/versions/${encodeURIComponent(providerId)}`);
        if (!res.ok) throw new Error('Failed to load provider versions');
        return await res.json();
      }

      async function renderStoreProvidersView(providersFromServer = null){
        if (!storeContent) return;
        setActiveStoreTab('versions');
        storeCurrentProvider = null;
        storeContent.innerHTML = '<div class="store-loading">Loading providers...</div>';
        try{
          const providers = providersFromServer || (await fetchStoreProviders(), storeProvidersCache);

          if (!providers || providers.length === 0){
            storeContent.innerHTML = '<div class="store-empty">No providers configured in versions.json.</div>';
            return;
          }

          const grid = document.createElement('div');
          grid.className = 'store-content-grid';

          providers.forEach(p => {
            const card = document.createElement('button');
            card.className = 'store-provider-card';
            card.type = 'button';
            card.addEventListener('click', ()=> openProviderDetails(p));

            const logoWrap = document.createElement('div');
            logoWrap.className = 'store-provider-logo';
            if (p.logo){
              const img = document.createElement('img');
              img.src = p.logo;
              img.alt = p.name || p.id || '';
              logoWrap.appendChild(img);
            } else {
              const span = document.createElement('span');
              span.className = 'store-provider-logo-placeholder';
              span.textContent = (p.name || p.id || '?').slice(0,2).toUpperCase();
              logoWrap.appendChild(span);
            }

            const body = document.createElement('div');
            body.className = 'store-provider-body';
            const title = document.createElement('div');
            title.className = 'store-provider-name';
            title.textContent = p.name || p.id;
            const desc = document.createElement('div');
            desc.className = 'store-provider-desc';
            desc.textContent = p.description || '';
            body.appendChild(title);
            body.appendChild(desc);

            const chevron = document.createElement('div');
            chevron.className = 'store-provider-chevron';
            chevron.innerHTML = '<i class="fa-solid fa-chevron-right"></i>';

            card.appendChild(logoWrap);
            card.appendChild(body);
            card.appendChild(chevron);
            grid.appendChild(card);
          });

          storeContent.innerHTML = '';
          storeContent.appendChild(grid);
        } catch(err){
          storeContent.innerHTML = `<div class="store-error">Failed to load providers: ${err.message || err}</div>`;
        }
      }

      /* === APPLY VERSION (frontend -> backend) === */
async function applyVersion(providerId, versionId, displayLabel){
  if (!hasPerm('server_start') && !hasPerm('files_create')) { alert('Unauthorized'); return; }
  const label = displayLabel || versionId;
  if (!confirm(`Install "${label}" on "${bot}"?`)) return;

  showProgressWheel(3, `Applying ${label}...`);
  try{
    const r = await fetch(`/api/servers/${encodeURIComponent(bot)}/versions/apply`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ providerId, versionId })
    });

    let j = null;
    try { j = await r.json(); } catch { j = null; }

    console.log('[applyVersion] status=', r.status, 'json=', j);

    if (!r.ok || !j || !j.ok) {
      const msg = (j && (j.detail || j.error)) ? (j.detail || j.error) : `HTTP ${r.status}`;
      throw new Error(msg);
    }

  } catch(e){
    setProgress(0, 'Apply failed');
    alert('Apply failed: ' + (e && e.message ? e.message : e));
  } finally {
    setTimeout(hideProgressWheel, 450);
  }
}
window.applyVersion = applyVersion;

      async function openProviderDetails(provider){
        if (!storeContent) return;
        storeCurrentProvider = provider;
        storeContent.innerHTML = '<div class="store-loading">Loading versions...</div>';
        try{
          const data = await fetchStoreVersions(provider.id || provider.provider || '');
          const versions = data.versions || [];

          const wrapper = document.createElement('div');

          const header = document.createElement('div');
          header.className = 'store-provider-header';

          const left = document.createElement('div');
          left.className = 'store-provider-header-main';

          const logoWrap = document.createElement('div');
          logoWrap.className = 'store-provider-logo';
          if (provider.logo){
            const img = document.createElement('img');
            img.src = provider.logo;
            img.alt = provider.name || provider.id || '';
            img.className = 'store-provider-header-logo';
            logoWrap.appendChild(img);
          } else {
            const span = document.createElement('span');
            span.className = 'store-provider-logo-placeholder';
            span.textContent = (provider.name || provider.id || '?').slice(0,2).toUpperCase();
            logoWrap.appendChild(span);
          }

          const text = document.createElement('div');
          const nameEl = document.createElement('div');
          nameEl.className = 'store-provider-header-name';
          nameEl.textContent = provider.name || data.displayName || provider.id;
          const descEl = document.createElement('div');
          descEl.className = 'store-provider-header-desc';
          descEl.textContent = provider.description || data.description || '';
          text.appendChild(nameEl);
          text.appendChild(descEl);

          left.appendChild(logoWrap);
          left.appendChild(text);

          const backBtn = document.createElement('button');
          backBtn.type = 'button';
          backBtn.className = 'store-back-btn';
          backBtn.innerHTML = '<i class="fa-solid fa-arrow-left"></i> Back';
          backBtn.addEventListener('click', ()=> renderStoreProvidersView());

          header.appendChild(left);
          header.appendChild(backBtn);

          wrapper.appendChild(header);

          const note = document.createElement('div');
          note.className = 'store-note';
          note.textContent = 'Click a version to install it (panel will download server.jar locally or instruct the node to wget it).';
          wrapper.appendChild(note);

          if (!versions.length){
            const empty = document.createElement('div');
            empty.className = 'store-empty';
            empty.textContent = 'No versions defined for this provider.';
            wrapper.appendChild(empty);
          } else {
            const list = document.createElement('div');
            list.className = 'store-version-list';
            versions.forEach(v => {
              const row = document.createElement('div');
              row.className = 'store-version-row';

              const meta = document.createElement('div');
              meta.className = 'store-version-meta';

              const vn = document.createElement('div');
              vn.className = 'store-version-name';
              vn.textContent = v.label || v.name || v.id;

              const vs = document.createElement('div');
              vs.className = 'store-version-sub';
              const parts = [];
              if (v.mcVersion) parts.push(`MC ${v.mcVersion}`);
              if (v.releaseDate) parts.push(v.releaseDate);
              vs.textContent = parts.join(' • ');

              meta.appendChild(vn);
              meta.appendChild(vs);

              const tags = document.createElement('div');
              tags.className = 'store-version-tags';
              (v.tags || []).forEach(tag => {
                const pill = document.createElement('span');
                pill.className = 'pill ' + (tag === 'latest' || tag === 'recommended' ? 'pill-green' : 'pill-muted');
                pill.textContent = tag;
                tags.appendChild(pill);
              });

              row.appendChild(meta);
              row.appendChild(tags);

              // CLICK = APPLY
              row.addEventListener('click', () => {
                const id = v.id || v.name || v.version || '';
                const label = v.label || v.name || id;
                applyVersion(provider.id || provider.provider || '', id, label);
              });

              list.appendChild(row);
            });
            wrapper.appendChild(list);
          }

          storeContent.innerHTML = '';
          storeContent.appendChild(wrapper);
        } catch(err){
          storeContent.innerHTML = `<div class="store-error">Failed to load versions: ${err.message || err}</div>`;
        }
      }

      function renderPluginsPlaceholder(){
        if (!storeContent) return;
        setActiveStoreTab('plugins');
        storeContent.innerHTML = '<div class="store-placeholder"><strong>Plugins</strong> management UI will live here. For now it is not wired to the backend.</div>';
      }

      async function openInfoModal(){
        if (!serverInfo) await loadServerInfo();
        const ip = serverInfo && serverInfo.ip ? serverInfo.ip : "—";
        const port = (serverInfo && (serverInfo.port!==undefined && serverInfo.port!==null)) ? serverInfo.port : "—";
        infoIp.textContent = ip; infoPort.textContent = String(port);
        infoAddress.value = (ip!=="—") ? formatAddress(ip, (port!=="—") ? port : undefined) : "";
        infoModal.classList.add('show'); infoModal.style.display='flex'; infoModal.setAttribute('aria-hidden','false'); infoAddress.select();
      }
      function closeInfoModal(){ infoModal.classList.remove('show'); infoModal.style.display='none'; infoModal.setAttribute('aria-hidden','true'); }
      infoModalClose.addEventListener('click', closeInfoModal);
      copyAddressBtn.addEventListener('click', async () => {
        try{ if (!infoAddress.value) return; await navigator.clipboard.writeText(infoAddress.value);
          copyAddressBtn.innerHTML = '<i class="fa-solid fa-check"></i>&nbsp;Copied';
          setTimeout(()=> copyAddressBtn.innerHTML = '<i class="fa-solid fa-copy"></i>&nbsp;Copy', 1200);
        } catch(e){ infoAddress.select(); document.execCommand('copy'); }
      });

      if (storeModalClose) storeModalClose.addEventListener('click', closeStoreModal);
      if (storeTabVersions) storeTabVersions.addEventListener('click', ()=> {
        renderStoreProvidersView();
      });
      if (storeTabPlugins) storeTabPlugins.addEventListener('click', ()=> {
        renderPluginsPlaceholder();
      });

      function focusConsole(){ openInfoModal(); }

      function applyPreferredStartup(scripts){
        const saved = localStorage.getItem(`startup-${bot}`) || "";
        const startFromIndex = serverInfo && serverInfo.start ? String(serverInfo.start) : "";
        let preferred = saved || startFromIndex || "";
        if (!preferred && scripts.includes("server.jar")) preferred = "server.jar";
        if (preferred && scripts.includes(preferred)) {
          const a=[...scriptSelect.options].find(o=>o.value===preferred); if(a) scriptSelect.value=preferred;
          const b=[...taskStartupSelect.options].find(o=>o.value===preferred); if(b) taskStartupSelect.value=preferred;
        }
      }

      let currentPath = "";
      async function loadExplorer(path = ""){
        try{
          if (!hasPerm('files_read')) { entriesEl.innerHTML = `<li style="color:var(--muted)">Unauthorized</li>`; return; }
          const data = await apiExplore(path);
          currentPath = data.path || "";
          breadcrumbs.innerHTML = `<a href="#" onclick="loadExplorer('')">Root</a>${currentPath ? " / " + currentPath : ""}`;
          entriesEl.innerHTML = "";

          data.entries.forEach((e) => {
            const li = document.createElement("li"); li.className = "entry";

            const left = document.createElement("div");
            const icon = document.createElement("div"); icon.innerHTML = e.isDir ? '<i class="fa-solid fa-folder"></i>' : '<i class="fa-solid fa-file"></i>';
            const nameWrap = document.createElement("div");
            const nm = document.createElement("div"); nm.className = "entry-name"; nm.textContent = e.name;
            const meta = document.createElement("div"); meta.className = "entry-meta"; meta.textContent = e.isDir ? "Folder" : "File";
            nameWrap.appendChild(nm); nameWrap.appendChild(meta);
            left.style.display = 'flex'; left.style.gap='8px'; left.style.alignItems='center';
            left.appendChild(icon); left.appendChild(nameWrap);

            const actions = document.createElement("div"); actions.className = "entry-actions";
            const moreBtn = document.createElement("button"); moreBtn.className = "more-btn"; moreBtn.innerHTML = '<i class="fa-solid fa-ellipsis-vertical"></i>';
            const menu = document.createElement("div"); menu.className = "more-menu";

            if (hasPerm('files_rename')) {
              const renameBtn = document.createElement("button"); renameBtn.textContent = "Rename";
              renameBtn.addEventListener('click', async (ev) => {
                ev.stopPropagation();
                const newName = prompt(`Rename "${e.name}" to:`); if (!newName || !newName.trim()) return alert("Invalid name");
                try{
                  const oldPath = currentPath ? currentPath + "/" + e.name : e.name;
                  await apiRename(oldPath, newName.trim());
                  alert('Renamed'); loadExplorer(currentPath);
                }catch(err){ alert('Rename failed: ' + (err.message || err)); }
                finally{ menu.classList.remove('show'); }
              });
              menu.appendChild(renameBtn);
            }

            if (hasPerm('files_delete')) {
              const deleteBtn = document.createElement("button"); deleteBtn.textContent = "Delete";
              deleteBtn.addEventListener('click', async (ev) => {
                ev.stopPropagation();
                if (!confirm(`Delete ${e.isDir ? "folder" : "file"} "${e.name}"?`)) { menu.classList.remove('show'); return; }
                try{
                  const rel = currentPath ? currentPath + "/" + e.name : e.name;
                  await apiDelete(rel, e.isDir);
                  setTimeout(()=> loadExplorer(currentPath), 200);
                }catch(err){ alert('Delete failed: ' + (err.message || err)); }
                menu.classList.remove('show');
              });
              menu.appendChild(deleteBtn);
            }

            const isArchive = !e.isDir && /\.(zip|tar|tgz|tar\.gz|tar\.bz2|bz2|rar|7z)$/i.test(e.name);
            if (isArchive && hasPerm('files_create')) {
              const unarchiveBtn = document.createElement("button"); unarchiveBtn.textContent = "Unarchive";
              unarchiveBtn.addEventListener('click', async (ev)=>{
                ev.stopPropagation(); menu.classList.remove('show');
                const targetRel = currentPath ? currentPath + "/" + e.name : e.name;
                if (!confirm(`Unarchive "${e.name}" into current folder?`)) return;
                showProgressWheel(6, "Unarchiving...");
                try{
                  const j = await apiExtract(targetRel);
                  setProgress(100, j.msg || 'Unarchive complete'); await new Promise(r => setTimeout(r, 250));
                  loadExplorer(currentPath); alert('Unarchive completed');
                }catch(err){ alert('Unarchive failed: ' + (err.message || err)); }
                finally{ hideProgressWheel(); }
              });
              menu.appendChild(unarchiveBtn);
            }

            actions.appendChild(moreBtn); actions.appendChild(menu);
            moreBtn.addEventListener('click', (ev) => {
              ev.stopPropagation();
              document.querySelectorAll('.more-menu.show').forEach(m=> { if (m !== menu) m.classList.remove('show'); });
              menu.classList.toggle('show');
            });

            li.addEventListener('click', async () => {
              if (e.isDir) {
                loadExplorer(currentPath ? currentPath + "/" + e.name : e.name);
              } else if (hasPerm('files_read')) {
                const rel = currentPath ? currentPath + "/" + e.name : e.name;
                if (REMOTE_MODE) {
                  try{
                    const content = await apiReadFile(rel);
                    if (content !== null) openEditorModal(rel, content);
                  } catch(err){ alert('Open failed: ' + (err.message || err)); }
                } else {
                  socket.emit("readFile", { bot, path: rel });
                }
              }
            });

            li.appendChild(left); li.appendChild(actions); entriesEl.appendChild(li);
          });

          const scripts = data.entries.filter(e => !e.isDir).map(e => e.name);
          scriptSelect.innerHTML = scripts.map(s => `<option value="${s}">${s}</option>`).join("");
          taskStartupSelect.innerHTML = `<option value="">(none)</option>` + scripts.map(s => `<option value="${s}">${s}</option>`).join("");
          applyPreferredStartup(scripts);
        }catch(err){
          entriesEl.innerHTML = `<li style="color:var(--muted)">${hasPerm('files_read') ? 'Failed to load' : 'Unauthorized'}</li>`;
        }
      }

      // ===== Progress utils
      let currentProgress=0, simInterval=null, isActiveOperation=false, operationStart=null;
      function showProgressWheel(initial=0,msg="Processing..."){ isActiveOperation=true; operationStart=Date.now(); progressWheel.classList.remove('hidden'); setProgress(initial,msg); }
      function hideProgressWheel(){ isActiveOperation=false; setTimeout(()=>{ progressWheel.classList.add('hidden'); setProgress(0); closeProgressPopup(); operationStart=null; popupTime.textContent="—"; },300); }
      function setProgress(percent,msg="Processing..."){
        if(typeof percent!=='number') percent=0; percent=Math.max(0,Math.min(100,Math.round(percent)));
        currentProgress=percent; progressFill.style.height=percent+"%"; popupPercent.textContent=percent+"%"; popupBar.style.width=percent+"%";
        if(msg) popupMsg.textContent=msg;
        if(operationStart){ const elapsed=Math.floor((Date.now()-operationStart)/1000); popupTime.textContent=`${elapsed}s elapsed`; } else popupTime.textContent="—";
        if(percent>=100 && isActiveOperation){ setTimeout(()=> hideProgressWheel(),450); }
      }
      function openProgressPopup(){ progressPopup.style.display="block"; progressPopup.setAttribute('aria-hidden','false'); popupPercent.textContent=currentProgress+"%"; popupBar.style.width=currentProgress+"%"; if(operationStart){ const elapsed=Math.floor((Date.now()-operationStart)/1000); popupTime.textContent=`${elapsed}s elapsed`; } else popupTime.textContent="—"; }
      function closeProgressPopup(){ progressPopup.style.display="none"; progressPopup.setAttribute('aria-hidden','true'); }
      progressWheel.addEventListener('click',()=>{ if(progressPopup.style.display==='block') closeProgressPopup(); else openProgressPopup(); });
      popupClose.addEventListener('click',()=> closeProgressPopup());

      function enableDropHandlers(){
        if (!hasPerm('files_upload')) return;
        const modalInner=document.querySelector('#filesModal .modal'); if(!modalInner) return;
        ['dragenter','dragover','dragleave','drop'].forEach(evt=>{ modalInner.addEventListener(evt,(e)=>e.preventDefault(),{passive:false}); });
        modalInner.addEventListener('dragenter', onDragEnter);
        modalInner.addEventListener('dragover', onDragOver);
        modalInner.addEventListener('dragleave', onDragLeave);
        modalInner.addEventListener('drop', onDrop);
      }
      function disableDropHandlers(){
        const modalInner=document.querySelector('#filesModal .modal'); if(!modalInner) return;
        modalInner.removeEventListener('dragenter', onDragEnter);
        modalInner.removeEventListener('dragover', onDragOver);
        modalInner.removeEventListener('dragleave', onDragLeave);
        modalInner.removeEventListener('drop', onDrop);
      }
      let dragCounter=0;
      function onDragEnter(e){ e.preventDefault(); dragCounter++; dropOverlay.classList.add('visible'); dropTitle.textContent="Drop files here to upload"; dropSubtitle.textContent="Release to upload to current folder"; }
      function onDragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect='copy'; if(!dropOverlay.classList.contains('visible')) dropOverlay.classList.add('visible'); }
      function onDragLeave(e){ e.preventDefault(); dragCounter=Math.max(0,dragCounter-1); if(dragCounter===0) dropOverlay.classList.remove('visible'); }
      async function onDrop(e){ e.preventDefault(); dragCounter=0; dropOverlay.classList.remove('visible'); const items=e.dataTransfer.files; if(!items||items.length===0) return; if(!hasPerm('files_upload')) return alert('Unauthorized'); const files=Array.from(items); await uploadFilesSequential(files); }

      async function uploadFilesSequential(files){
        for(let i=0;i<files.length;i++){
          const file=files[i], idx=i+1, total=files.length, msgBase=`Uploading ${idx} of ${total} — ${file.name}`;
          try{
            await apiUploadWithProgress(file, currentPath, (percent,state)=> setProgress(percent, state || msgBase), msgBase);
            await new Promise(r=>setTimeout(r,150)); loadExplorer(currentPath);
          }catch(err){ alert(`Upload failed for ${file.name}: ${err.message||err}`); }
        }
        setTimeout(()=>{ hideProgressWheel(); },400);
        alert('Uploads completed');
      }

      function openEditorModal(path, content){
        editorModal.classList.add('show'); editorModal.style.display='flex'; document.getElementById('editorPath').textContent=path;
        const lower=path.toLowerCase();
        if(lower.endsWith('.js')){ textArea.style.display='none'; codeArea.style.display='block'; codeArea.innerHTML=highlightJS(content); codeArea.dataset.raw=content; placeCaretAtEnd(codeArea); codeArea.focus(); }
        else { codeArea.style.display='none'; textArea.style.display='block'; textArea.value=content; textArea.dataset.original=content; textArea.focus(); }
        if(!hasPerm('files_create')){ editorSave.classList.add('disabled'); }
      }
      function closeEditorModal(){ editorModal.classList.remove('show'); editorModal.style.display='none'; document.getElementById('editorPath').textContent=''; codeArea.innerHTML=''; textArea.value=''; }
      editorModalClose.addEventListener('click', closeEditorModal);
      editorDiscard.addEventListener('click', () => {
        if (textArea.style.display!=='none') textArea.value = textArea.dataset.original || '';
        else codeArea.innerHTML = highlightJS(codeArea.dataset.raw || '');
      });
      editorSave.addEventListener('click', async () => {
        if (!hasPerm('files_create')) return alert('Unauthorized');
        const path = document.getElementById('editorPath').textContent; if(!path) return alert('No file open');
        let contentToSave = (textArea.style.display!=='none') ? textArea.value : getTextFromContentEditable(codeArea);
        try{
          await apiWriteFile(path, contentToSave);
          setTimeout(()=> { loadExplorer(currentPath); alert('Saved'); closeEditorModal(); }, 150);
        }catch(err){ alert('Save failed: ' + (err.message || err)); }
      });

      function run(){
        if (!hasPerm('server_start')) return alert('Unauthorized');
        consoleEl.textContent=''; const savedStartup=localStorage.getItem(`startup-${bot}`)||''; const fallback=(serverInfo&&serverInfo.start)?String(serverInfo.start):''; const selected=savedStartup||scriptSelect.value||fallback;
        if(!selected) return alert('No script selected to run');
        statusLabel.textContent='running'; const lower=selected.toLowerCase();
        if(lower.endsWith('.jar')){
          const overrides={ ports:['25565:25565'], env:{EULA:'TRUE',TYPE:'CUSTOM',CUSTOM_SERVER:`/data/${selected}`}, volumes:['{BOT_DIR}:/data'], restart:'unless-stopped' };
          apiAction({ bot, cmd:'run', templateId:'minecraft', docker: overrides }).catch(err=>alert('Run failed: ' + (err.message||err)));
          attachLogStreamIfRemote(); // [SSE]
          return;
        }
        apiAction({ bot, cmd:'run', file: selected }).catch(err=>alert('Run failed: ' + (err.message||err)));
        attachLogStreamIfRemote(); // [SSE]
      }
      function stop(){
        if (!hasPerm('server_stop')) return alert('Unauthorized');
        statusLabel.textContent='stopping';
        apiAction({ bot, cmd:'stop' })
          .then(()=> setTimeout(()=> statusLabel.textContent='idle', 500))
          .catch(err=> alert('Stop failed: ' + (err.message||err)));
      }

      fileUploadModal.addEventListener('change', () => {
        if(!hasPerm('files_upload')) return alert('Unauthorized');
        const f=fileUploadModal.files[0]; if(!f) return;
        showProgressWheel(0, `Uploading 1 of 1 — ${f.name}`);
        apiUploadWithProgress(f, currentPath, (percent,msg)=> setProgress(percent,msg),`Uploading 1 of 1 — ${f.name}`)
          .then(()=>{ loadExplorer(currentPath); setTimeout(()=>{ hideProgressWheel(); alert('Upload complete'); },350); })
          .catch((err)=>{ hideProgressWheel(); alert('Upload failed: '+(err&&err.message?err.message:'unknown')); })
          .finally(()=>{ fileUploadModal.value=''; });
      });

      async function createNew(){
        if(!hasPerm('files_create')) return alert('Unauthorized');
        const type=prompt("Type 'file' to create a file or 'folder' to create a folder:"); if(!type || (type!=='file'&&type!=='folder')) return alert('Invalid type.');
        const name=prompt(`Enter ${type} name:`); if(!name) return;
        showProgressWheel(4, type==='file' ? "Creating file..." : "Creating folder..."); startSimulatedProgress(4,88,420);
        try{
          await apiCreate(type, name, currentPath);
          setProgress(100, (type==='file' ? "File created" : "Folder created"));
          loadExplorer(currentPath);
          setTimeout(()=>{ hideProgressWheel(); alert((type==='file'?'File':'Folder')+' created successfully'); },350);
        }catch(err){
          hideProgressWheel(); alert(err.message||'Create failed');
        }
      }

      function sendCommand(){
        if(!hasPerm('console_write')) return alert('Unauthorized');
        const cmd=cmdInput.value.trim(); if(cmd==='') return;
        apiCommand(cmd).catch(err=> alert('Command failed: ' + (err.message||err)));
        cmdInput.value='';
      }
      cmdInput.addEventListener('keyup', (e)=>{ if(e.key==='Enter') sendCommand(); });
      function clearConsole(){ consoleEl.textContent=''; }

      function openFilesModal(){
        if (!hasPerm('files_read')) return alert('Unauthorized');
        filesModal.classList.add('show'); filesModal.style.display='flex'; loadExplorer(currentPath); enableDropHandlers();
      }
      function closeFilesModal(){ filesModal.classList.remove('show'); filesModal.style.display='none'; disableDropHandlers(); }
      filesModalClose.addEventListener('click', closeFilesModal);

      function openTaskModal(){ if(!hasPerm('server_start')) return alert('Unauthorized'); taskModal.classList.add('show'); taskModal.style.display='flex'; loadExplorer(currentPath); }
      function closeTaskModal(){ taskModal.classList.remove('show'); taskModal.style.display='none'; }
      taskModalClose.addEventListener('click', closeTaskModal);

      saveStartupBtn.addEventListener('click', ()=> {
        if(!hasPerm('server_start')) return alert('Unauthorized');
        const val = taskStartupSelect.value || '';
        if (val) { localStorage.setItem(`startup-${bot}`, val); alert('Startup file saved: ' + val); }
        else { localStorage.removeItem(`startup-${bot}`); alert('Startup file cleared'); }
      });

      document.addEventListener('keydown', (e)=> {
        if (e.key==='Escape') {
          if (editorModal && editorModal.classList.contains('show')) { closeEditorModal(); return; }
          if (filesModal && filesModal.classList.contains('show')) { closeFilesModal(); return; }
          if (taskModal && taskModal.classList.contains('show')) { closeTaskModal(); return; }
          if (infoModal && infoModal.classList.contains('show')) { closeInfoModal(); return; }
          if (storeModal && storeModal.classList.contains('show')) { closeStoreModal(); return; }
          if (progressPopup && progressPopup.style.display==='block') { closeProgressPopup(); return; }
        }
      });
      document.addEventListener('click', () => { document.querySelectorAll('.more-menu.show').forEach(m => m.classList.remove('show')); });

      document.addEventListener('DOMContentLoaded', async ()=>{
        await fetchPerms(); applyPermissionsToUI();
        await loadServerInfo();              // setează REMOTE_MODE / template etc
        attachLogStreamIfRemote();           // [SSE] — leagă fluxul de log dacă e remote
        await loadExplorer();
        function applyScale(){ const dpr=window.devicePixelRatio||1; const scale=Math.max(0.75,Math.min(1.12,dpr)); document.documentElement.style.setProperty('--ui-scale', scale); }
        applyScale(); window.addEventListener('resize', applyScale);
      });

      socket.on('output', ()=> { consoleEl.scrollTop = consoleEl.scrollHeight; });

      // === Helpers (highlight)
      function escapeHtmlRaw(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
      function highlightJS(src){
        if(typeof src!=='string') src=''; let out=escapeHtmlRaw(src);
        out=out.replace(/(\/\*[\s\S]*?\*\/|\/\/[^\n]*)/g,m=>`<span class="com">${m.replace(/</g,'&lt;')}</span>`);
        out=out.replace(/("([^"\\]|\\.)*"|'([^'\\]|\\.)*'|`([^`\\]|\\.)*`)/g,m=>`<span class="str">${m.replace(/</g,'&lt;')}</span>`);
        out=out.replace(/\b([0-9]+(?:\.[0-9]+)?)\b/g,`<span class="num">$1</span>`);
        out=out.replace(/\bclass\s+([A-Za-z_$][\w$]*)/g,(_,n)=>`class <span class="cls">${n}</span>`);
        out=out.replace(/\bfunction\s+([A-Za-z_$][\w$]*)\s*\(/g,(_,n)=>`function <span class="fn">${n}</span>(`);
        out=out.replace(/([A-Za-z_$][\w$]*)\s*=\s*\(.*?\)\s*=>/g,m=>m.replace(/([A-Za-z_$][\w$]*)/,`<span class="fn">$1</span>`));
        const keywords=['const','let','var','return','if','else','for','while','switch','case','break','continue','class','new','try','catch','finally','throw','await','async','import','from','export','extends','super','this','typeof','instanceof','in'];
        const kwRegex=new RegExp('\\b('+keywords.join('|')+')\\b','g'); out=out.replace(kwRegex,`<span class="kw">$1</span>`);
        out=out.replace(/\r\n|\r|\n/g,'<div>$&</div>'); out=out.replace(/<div>\n<\/div>/g,'<div></div>'); return out;
      }
      function getTextFromContentEditable(el){ let txt=el.innerText||el.textContent||''; txt=txt.replace(/\r\n/g,'\n').replace(/\r/g,'\n'); return txt; }
      function placeCaretAtEnd(el){ el.focus(); if(window.getSelection&&document.createRange){ const r=document.createRange(); r.selectNodeContents(el); r.collapse(false); const s=window.getSelection(); s.removeAllRanges(); s.addRange(r);} }
      function startSimulatedProgress(from=0,to=90,duration=400){
        if(simInterval){ clearInterval(simInterval); simInterval=null; }
        let pct=from; const steps=Math.max(8,Math.floor(duration/80)); const step=(to-from)/steps;
        simInterval=setInterval(()=>{ pct=Math.min(99,pct+step); setProgress(Math.round(pct)); if(pct>=to){ clearInterval(simInterval); simInterval=null; } }, Math.max(40, Math.floor(duration/steps)));
      }
    </script>

    <script src="https://kit.fontawesome.com/6bcbc61285.js" crossorigin="anonymous"></script>
  </body>
</html>
